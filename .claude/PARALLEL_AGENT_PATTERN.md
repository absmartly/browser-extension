# Parallel Agent Coordination Pattern with Self-Service Queue

This document describes the pattern for orchestrating multiple parallel agents to work on complex tasks systematically using a self-service task queue.

## Overview

This pattern enables you to:
1. Break down complex problems into parallel investigation/work streams
2. Have agents autonomously pick tasks from a shared queue
3. Coordinate findings without bottlenecks
4. Scale to any number of parallel agents (typically 5-7)

## Pattern Structure

### Step 1: Create the Investigation Plan

Create a high-level plan document with a dynamically generated filename based on the problem:

**Example filename pattern**: `.claude/{PROBLEM_SLUG}_INVESTIGATION_PLAN.md`

Where `{PROBLEM_SLUG}` is generated by the LLM based on the problem description (e.g., `API_EXPERIMENTS`, `AUTH_FLOW`, `SIDEBAR_INJECTION`).

**Contents**:
```markdown
# {Problem Title} Investigation Plan

## Problem Statement
[Clear description of what's broken or needs investigation]

## Key Insight
[What we already know that provides context]

## Investigation Hypothesis
1. **Hypothesis 1**: [Potential root cause]
2. **Hypothesis 2**: [Another potential cause]
3. **Hypothesis 3**: [Yet another possibility]

## Investigation Approach

### Phase 1: Identify the Root Cause
- [Diagnostic steps]
- [Files to check]
- [Questions to answer]

### Phase 2: Fix the Root Cause
- [Based on findings from Phase 1]

### Phase 3: Verify Fixes
- [Test commands]
- [Success criteria]

## Expected Outcome
[What success looks like]

## Files to Investigate

Primary:
- [List of key files]

Secondary:
- [Supporting files]

## Questions for Agents
1. [Specific question 1]
2. [Specific question 2]
[etc.]

## Success Metrics
✅ [Metric 1]
✅ [Metric 2]
[etc.]
```

---

### Step 2: Create the Task Queue

Create a shared queue file with a dynamically generated filename:

**Filename pattern**: `.claude/{PROBLEM_SLUG}_FIX_QUEUE.md`

**Contents**:
```markdown
# {Problem Title} - Task Queue

## Investigation Phase Tasks

| Task ID | Agent Role | Status | Files to Investigate | Questions to Answer |
|---------|-----------|--------|---------------------|---------------------|
| INV-1 | [Role Name] | PENDING | [file1.ts, file2.ts] | [Specific question] |
| INV-2 | [Role Name] | PENDING | [file3.ts] | [Specific question] |
| INV-3 | [Role Name] | PENDING | [file4.ts, file5.ts] | [Specific question] |
| INV-4 | [Role Name] | PENDING | [file6.tsx] | [Specific question] |
| INV-5 | [Role Name] | PENDING | [file7.spec.ts] | [Specific question] |
| INV-6 | [Role Name] | PENDING | [file8.ts, .env] | [Specific question] |
| INV-7 | [Role Name] | PENDING | [config files] | [Specific question] |

## Fix Phase Tasks

| Task ID | Type | Status | Description | Files to Modify |
|---------|------|--------|-------------|----------------|
| FIX-1 | [Type] | PENDING | [Description] | [files] |
| FIX-2 | [Type] | PENDING | [Description] | [files] |
[etc.]

## Investigation Findings Log

### Agent 1 - [Role Name]
**Status**: [PENDING/IN PROGRESS/COMPLETE]
**Files Investigated**: [list]
**Findings**:
- [Finding 1]
- [Finding 2]
**Root Cause?**: [YES/NO/PARTIAL]
**Recommended Fix**: [description]

### Agent 2 - [Role Name]
[Same structure]

[... repeat for all 7 agents]

---

## Instructions for Agents

### How to Use This Queue

1. **Read the queue** - Find your assigned task ID based on your agent number
2. **Mark as IN PROGRESS** - Update the Status column when you start
3. **Investigate** - Follow the investigation steps
4. **Document findings** - Add your findings to your section in "Investigation Findings Log"
5. **Mark as COMPLETE** - Update Status when done

### Task Status Values
- **PENDING**: Not started yet
- **IN PROGRESS**: Currently being worked on
- **COMPLETE**: Finished and documented

### What to Include in Findings
- Exact file paths and line numbers
- Code snippets (if relevant)
- Clear YES/NO on whether you found the root cause
- Specific recommended fixes
- Blockers or dependencies
```

---

### Step 3: Create the Universal Agent Prompt

Create a single prompt file that ALL agents receive:

**Filename pattern**: `.claude/{PROBLEM_SLUG}_AGENT_PROMPT.md`

**Contents**:
```markdown
# Universal Agent Prompt - {Problem Title} Investigation

**Mission**: [Brief mission statement]

---

## Your Task

You are one of 7 parallel investigators. Your job is to:

1. **Read** `.claude/{PROBLEM_SLUG}_FIX_QUEUE.md` to see which investigation task is assigned to you
2. **Investigate** the specific area of code listed in your task
3. **Document** your findings in the queue file
4. **Answer** the investigation questions
5. **Don't code yet** - just analyze and report back

---

## How to Work

### Phase: Investigation Only (No Code Changes)

You are NOT writing fixes yet. You are:
- Reading code
- Understanding the flow
- Identifying problems
- Documenting findings

### Agent Assignments

**Agent 1 - [Role Name]**:
- File: `[file path]`
- Question: [Specific question]
- Task: [What to find]
- Report: [What to report back]

**Agent 2 - [Role Name]**:
- File: `[file path]`
- Question: [Specific question]
- Task: [What to find]
- Report: [What to report back]

**Agent 3 - [Role Name]**:
[Same structure]

**Agent 4 - [Role Name]**:
[Same structure]

**Agent 5 - [Role Name]**:
[Same structure]

**Agent 6 - [Role Name]**:
[Same structure]

**Agent 7 - [Role Name]**:
[Same structure]

---

## How to Investigate

### Step 1: Read Your Assigned Code
- Open the file(s) specified for your agent
- Understand what the code does
- Look for issues or missing pieces

### Step 2: Answer Investigation Questions
- Your agent has 1-3 specific questions
- Answer them based on code reading
- Be specific and include line numbers

### Step 3: Document Findings
- Add your findings to `.claude/{PROBLEM_SLUG}_FIX_QUEUE.md`
- Update your section under "Investigation Findings Log"
- Include:
  - What you found
  - File path and line numbers
  - Is this the root cause?
  - What needs to be fixed?

### Step 4: Communicate
- Keep findings brief but complete
- Use code snippets if helpful
- Clearly state if it's blocking or not critical

---

## Key Files to Know

[List of important files relevant to this investigation]

---

## Investigation Commands

When investigating, you may need to:
```bash
# Search for specific code
grep -r "{search_term_1}" src/
grep -r "{search_term_2}" src/

# Look for message handlers
grep -r "{pattern}" src/

# Find auth setup
grep -r "{auth_pattern}" src/ --include="*.ts"

# View test to understand what it expects
cat {test_file} | head -150
```

---

## Important Notes

✅ **DO**:
- Read code carefully
- Ask specific questions about what you see
- Include line numbers in findings
- Be thorough in investigation
- Report blockers clearly

❌ **DON'T**:
- Make code changes yet
- Make assumptions without checking code
- Skip parts of the investigation
- Use grep without understanding context
- Report vague findings ("something's wrong")

---

## Expected Outcome

After all 7 agents complete investigation:
- We will know the root cause
- We will know exactly which files need fixing
- We will understand the flow from [start] → [end]
- We will be ready to implement fixes

---

## When You're Done

1. Add your findings to `.claude/{PROBLEM_SLUG}_FIX_QUEUE.md`
2. Clearly state if you found the root cause
3. List files that need fixing
4. Wait for all agents to complete
5. Follow orchestrator's next instructions

---

## Questions?

If you encounter:
- **Unclear code**: Document what you expect vs what you see
- **Missing files**: Report the missing file and what should be there
- **Multiple issues**: List all of them with priorities
- **Can't find something**: Report what you searched for and what you expected to find

Good luck! Let's find this bug!
```

---

### Step 4: Dispatch All Agents in Parallel

Use the Task tool to launch all agents simultaneously with the universal prompt:

```typescript
// All agents receive the same prompt and self-select their tasks from the queue
Task({
  subagent_type: "general-purpose",
  description: "Agent 1 investigation",
  prompt: `Read the file .claude/{PROBLEM_SLUG}_AGENT_PROMPT.md and complete your assigned investigation task. Report findings to .claude/{PROBLEM_SLUG}_FIX_QUEUE.md`
})

Task({
  subagent_type: "general-purpose",
  description: "Agent 2 investigation",
  prompt: `Read the file .claude/{PROBLEM_SLUG}_AGENT_PROMPT.md and complete your assigned investigation task. Report findings to .claude/{PROBLEM_SLUG}_FIX_QUEUE.md`
})

// Repeat for agents 3-7...
```

---

## Dynamic Filename Generation

The LLM should generate the `{PROBLEM_SLUG}` based on the problem description:

**Examples**:
- "API experiments not loading" → `API_EXPERIMENTS`
- "Authentication flow broken" → `AUTH_FLOW`
- "Sidebar injection failing" → `SIDEBAR_INJECTION`
- "Database migration issues" → `DB_MIGRATION`
- "Test suite flakiness" → `TEST_FLAKINESS`

**Rules for slug generation**:
1. Use SCREAMING_SNAKE_CASE
2. Keep it under 25 characters
3. Make it descriptive but concise
4. Use only letters, numbers, and underscores
5. No special characters or spaces

---

## Key Benefits of This Pattern

1. **Self-Service**: Agents pick tasks independently from the queue
2. **Parallel Execution**: All agents work simultaneously, no waiting
3. **Transparent Progress**: Queue shows real-time status of all tasks
4. **Shared Context**: All agents read and write to same queue file
5. **No Bottleneck**: No orchestrator needed to assign tasks one by one
6. **Reusable**: Same pattern works for investigation, fixes, testing, refactoring, etc.
7. **Scalable**: Works with any number of agents (typically 5-7 optimal)
8. **Documented**: All findings captured in structured format for future reference

---

## Example Usage

### User Request:
"The API experiments aren't loading. Create a plan and have 7 agents investigate."

### LLM Response:
1. Generate `PROBLEM_SLUG` = `API_EXPERIMENTS`
2. Create `.claude/API_EXPERIMENTS_INVESTIGATION_PLAN.md`
3. Create `.claude/API_EXPERIMENTS_FIX_QUEUE.md` with 7 investigation tasks
4. Create `.claude/API_EXPERIMENTS_AGENT_PROMPT.md` with agent assignments
5. Dispatch 7 agents in parallel, each reading the agent prompt
6. Agents self-coordinate through the queue file
7. Collect findings when all agents complete
8. Summarize root causes and next steps

---

## After Investigation Phase

Once all agents complete:
1. **Review findings** from all agents in the queue
2. **Identify root causes** based on evidence
3. **Create fix tasks** in the "Fix Phase Tasks" section
4. **Optional**: Run another round with agents picking fix tasks
5. **Verify fixes** with tests or manual validation

---

## Notes

- This pattern was successfully used to investigate API experiment loading issues
- 7 agents completed investigation in parallel and identified multiple root causes
- The self-service queue model eliminated coordination overhead
- All findings were captured in structured format for future reference
- Pattern is reusable for any complex debugging or investigation task

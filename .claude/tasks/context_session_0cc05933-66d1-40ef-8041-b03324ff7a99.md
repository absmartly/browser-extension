# Session Context - URL Expression Filtering for DOM Changes

**Session ID**: 0cc05933-66d1-40ef-8041-b03324ff7a99
**Date**: 2025-10-07
**Task**: Add URL/page expression filtering to DOM changes editor

## Objective

Add functionality to specify URL expressions for DOM changes, allowing users to control on which pages/URLs specific DOM changes should be applied. This is similar to the Statsig extension's URL filtering feature.

## Current State

- DOM changes are currently applied globally without URL filtering
- DOM change types are defined in `/Users/joalves/git_tree/absmartly-browser-extension/src/types/dom-changes.ts`
- Main editor component is in `/Users/joalves/git_tree/absmartly-browser-extension/src/components/DOMChangesInlineEditor.tsx`
- SDK plugin is located at `/Users/joalves/git_tree/absmartly-sdk-plugins/src`

## Research Findings

### SDK Plugin Analysis
- SDK plugin is located at `/Users/joalves/git_tree/absmartly-sdk-plugins/src`
- Current implementation does NOT support URL filtering
- `__dom_changes` is currently stored as a simple array: `DOMChange[]`
- All changes are applied globally on every page

### Proposed SDK Architecture Change

The `__dom_changes` variable needs to change from an array to an object:

```typescript
// Current (legacy)
__dom_changes: DOMChange[]

// New proposed structure
__dom_changes: {
  changes: DOMChange[];
  urlFilter?: string | string[] | URLFilterConfig;

  // Global defaults that can be overridden per-change
  waitForElement?: boolean;
  persistStyle?: boolean;
  important?: boolean;
  observerRoot?: string;
}
```

## Implementation Plan

### Phase 1: SDK Plugin Enhancement (Documented)
**Status**: ✅ Comprehensive plan document created

Created `/Users/joalves/git_tree/absmartly-sdk-plugins/URL_FILTERING_FEATURE.md` with:
- New data structure proposal
- URLMatcher utility design
- Pattern matching rules (simple wildcards and regex)
- Backward compatibility strategy
- SPA mode URL change handling
- Global defaults feature
- Migration path and testing requirements

### Phase 2: Browser Extension Updates (✅ COMPLETED)

1. **Update Type Definitions** ✅
   - Added `URLFilter` and `URLFilterConfig` types to `/Users/joalves/git_tree/absmartly-browser-extension/src/types/dom-changes.ts`
   - Added `DOMChangesConfig` interface with `changes`, `urlFilter`, and global defaults
   - Created `DOMChangesData` union type supporting both legacy array and new config format

2. **Update DOM Changes Editor UI** ✅
   - Created `URLFilterSection` component in `VariantList.tsx`
   - Added three modes: "Apply on all pages", "Target specific URLs", and "Advanced (Include/Exclude + Regex)"
   - Simple mode: Multiple URL patterns with wildcard support (* and ?)
   - Advanced mode: Include/exclude patterns with regex mode toggle
   - Global defaults section with checkboxes for waitForElement, persistStyle, important, and observerRoot input

3. **Update Storage/API** ✅
   - Updated `Variant` interface to use `DOMChangesData` type
   - Added helper functions: `getChangesArray()`, `getChangesConfig()`, `normalizeToNewFormat()`
   - Modified `updateVariantDOMChanges()` to preserve URL filter and global defaults
   - Added `updateVariantDOMConfig()` to update URL filter and global defaults separately
   - **Always convert legacy format to new format** when loading experiments
   - Updated `addVariant()` to create variants with new format `{ changes: [] }`
   - Updated JSON editor to accept and save both formats

4. **Testing** (Pending)
   - Test with different URL patterns
   - Verify backward compatibility with array format
   - Test wildcard and regex patterns
   - Test global defaults inheritance

## Progress

- [x] Created session context file
- [x] Researched SDK plugin URL filtering capability
- [x] Created comprehensive feature plan document for SDK team
- [x] SDK team implemented URL filtering in plugin (docs at `/Users/joalves/git_tree/absmartly-sdk-plugins/docs/DOM_CHANGES_PAYLOAD_FORMAT.md`)
- [x] Update browser extension types for new format
- [x] Add URL expression UI to variant editor
- [x] Update storage/serialization logic to always use new format
- [ ] Test functionality end-to-end

## Key Decisions

1. **URL filtering is at the experiment variant level**, not per DOM change
2. **Backward compatibility is critical** - must support existing array format
3. **Global defaults feature** - move common options (waitForElement, important, etc.) to variant level
4. **Pattern matching** - support both simple wildcards (*) and regex for flexibility
5. **SPA support** - re-evaluate filters on URL changes in single-page apps

## Design Approach: Lightweight URL Filtering

After discussion, decided on a **simple, lightweight approach**:

### Key Decisions

1. **No state tracking needed**: Don't need to revert changes, only apply new ones
2. **URL change listeners enabled**: Track URL changes to check if variants now match
3. **No reverting changes**: Once applied, changes stay until page reload
4. **Apply forward only**: When URL changes, check all variants if their URL filter now matches
5. **URL filter is per-variant**: Each variant of an experiment can have different URL filters

### Rationale

- In SPAs, URL changes typically show new views where previous changes aren't visible
- If elements are still visible, keeping changes is better than abrupt removal (poor UX)
- Variants don't change in production (extension handles preview separately)
- Full page reloads will re-evaluate URL filters correctly
- Avoids complexity, memory overhead, and state management issues

### Implementation

SDK plugin will:
1. On initial load: Check each variant's URL filter and apply if matches
2. Track which experiment+variant combinations have been applied (Set with keys like "exp_name:variant_id")
3. Listen for URL changes (pushState, replaceState, popstate)
4. On URL change: Check all variants again, apply those that now match (if not already applied)
5. Never remove or revert existing changes
6. Support both legacy (array) and new (object with urlFilter) formats
7. Apply global defaults from variant config to individual changes

**Example**: Experiment "hero_banner" with variants 0, 1, 2 where variant 1 has `urlFilter: "*/products/*"`
- User assigned to variant 1
- Load `/home` → No changes (doesn't match)
- Navigate to `/products/123` → Changes applied
- Navigate to `/cart` → Changes persist (not removed)

## Implementation Details

### Files Modified

1. `/Users/joalves/git_tree/absmartly-browser-extension/src/types/dom-changes.ts`
   - Added `URLFilterConfig` interface (include, exclude, mode)
   - Added `URLFilter` type (string | string[] | URLFilterConfig)
   - Added `DOMChangesConfig` interface (changes, urlFilter, global defaults)
   - Added `DOMChangesData` union type (DOMChange[] | DOMChangesConfig)

2. `/Users/joalves/git_tree/absmartly-browser-extension/src/components/VariantList.tsx`
   - Updated `Variant` interface to use `DOMChangesData`
   - Added helper functions: `getChangesArray()`, `getChangesConfig()`, `normalizeToNewFormat()`
   - Modified `addVariant()` to use new format
   - Modified `updateVariantDOMChanges()` to preserve config
   - Added `updateVariantDOMConfig()` for URL filter/defaults updates
   - Added `URLFilterSection` component with full UI (300+ lines)
   - Updated variant loading to always normalize to new format

3. `/Users/joalves/git_tree/absmartly-browser-extension/src/components/DOMChangesJSONEditor.tsx`
   - Updated types to use `DOMChangesData`
   - Added validation for both array and object formats

### UI Components Added

**URLFilterSection** - Complete URL filtering UI with:
- Radio button mode selector (all pages / simple / advanced)
- Simple mode: Dynamic list of URL patterns with add/remove
- Advanced mode: Separate include/exclude pattern lists with regex toggle
- Global defaults section: waitForElement, persistStyle, important checkboxes, observerRoot input
- Helpful placeholders and hints for pattern syntax
- Blue-tinted container to distinguish from DOM changes section

## Next Steps

1. ✅ **Phase 1**: SDK team implemented URL filtering
   - URLMatcher utility with wildcard and regex support
   - New `__dom_changes` object format with `urlFilter` field
   - Backward compatibility with array format
   - Global defaults feature

2. ✅ **Phase 2**: Browser extension updates completed
   - Updated types to support new format
   - Added URL filter UI to variant editor
   - Updated storage/serialization to always use new format

3. **Phase 3**: Testing and deployment (pending)
   - Test URL filtering end-to-end
   - Verify SDK correctly applies URL filters
   - Test wildcard and regex patterns
   - Test global defaults inheritance
   - Deploy and monitor

!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ABsmartlyDOM=t():e.ABsmartlyDOM=t()}(this,()=>(()=>{"use strict";var e={214:function(e,t,r){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},n.apply(this,arguments)},a=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},i=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o};Object.defineProperty(t,"__esModule",{value:!0}),t.PendingChangeManager=void 0;var o=r(609),s=function(){function e(e,t){void 0===t&&(t=!1),this.applyFn=e,this.pending=new Map,this.observers=new Map,this.appliedSelectors=new Set,this.batchTimer=null,this.batchedWork=new Set,this.debug=t}return e.prototype.addPending=function(e){var t=e.change,r=e.observerRoot,a=r;r&&!document.querySelector(r)&&(this.debug&&(0,o.logDebug)("[ABsmartly] Observer root not found, using document:",r),a=void 0);var i="".concat(t.selector,"-").concat(a||"document");this.debug&&(0,o.logDebug)("[ABsmartly] Adding pending change for selector:",t.selector);var s=this.getObserverRoot(a).querySelector(t.selector);if(s)this.applyChange(s,n(n({},e),{observerRoot:a}));else{var l=this.pending.get(i)||[];l.push(n(n({},e),{observerRoot:a})),this.pending.set(i,l),this.ensureObserver(a)}},e.prototype.removePending=function(e,t,r){var n="".concat(e,"-").concat(r||"document"),a=this.pending.get(n);if(a){var i=a.filter(function(e){return e.experimentName!==t});0===i.length?this.pending.delete(n):this.pending.set(n,i)}this.checkObserverCleanup(r)},e.prototype.removeAllPending=function(e){var t,r;try{for(var n=a(this.pending.entries()),o=n.next();!o.done;o=n.next()){var s=i(o.value,2),l=s[0],c=s[1].filter(function(t){return t.experimentName!==e});0===c.length?this.pending.delete(l):this.pending.set(l,c)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}this.cleanupObservers()},e.prototype.ensureObserver=function(e){var t=this,r=e||"document";if(!this.observers.has(r)){var n=this.getObserverRoot(e),a=new MutationObserver(function(r){t.handleMutations(r,e)});a.observe(n,{childList:!0,subtree:!0}),this.observers.set(r,a),this.debug&&(0,o.logDebug)("[ABsmartly] Started observer for root:",r)}},e.prototype.handleMutations=function(e,t){var r,n,o,s,l=this,c=[];try{for(var u=a(e),g=u.next();!g.done;g=u.next()){var h=g.value,d=function(e){var r,n,o,s;if(!(e instanceof Element))return"continue";var u=t||"document";try{for(var g=(r=void 0,a(p.pending.entries())),h=g.next();!h.done;h=g.next()){var d=i(h.value,2),f=d[0],y=d[1];if(f.endsWith("-".concat(u))){var m=function(t){var r=t.change;if(e.matches(r.selector))return c.push(function(){return l.applyChange(e,t)}),"continue";e.querySelectorAll(r.selector).forEach(function(e){c.push(function(){return l.applyChange(e,t)})})};try{for(var v=(o=void 0,a(y)),b=v.next();!b.done;b=v.next()){m(b.value)}}catch(e){o={error:e}}finally{try{b&&!b.done&&(s=v.return)&&s.call(v)}finally{if(o)throw o.error}}}}}catch(e){r={error:e}}finally{try{h&&!h.done&&(n=g.return)&&n.call(g)}finally{if(r)throw r.error}}},p=this;try{for(var f=(o=void 0,a(h.addedNodes)),y=f.next();!y.done;y=f.next()){d(y.value)}}catch(e){o={error:e}}finally{try{y&&!y.done&&(s=f.return)&&s.call(f)}finally{if(o)throw o.error}}}}catch(e){r={error:e}}finally{try{g&&!g.done&&(n=u.return)&&n.call(u)}finally{if(r)throw r.error}}c.length>0&&this.batchWork(c)},e.prototype.batchWork=function(e){var t=this;e.forEach(function(e){return t.batchedWork.add(e)}),this.batchTimer&&clearTimeout(this.batchTimer),this.batchTimer=setTimeout(function(){t.processBatchedWork()},32)},e.prototype.processBatchedWork=function(){var e=Array.from(this.batchedWork);this.batchedWork.clear(),this.batchTimer=null,this.debug&&e.length>0&&(0,o.logDebug)("[ABsmartly] Processing batched work:",e.length,"items"),e.forEach(function(e){return e()})},e.prototype.applyChange=function(e,t){var r=t.change,n=t.experimentName,a=t.observerRoot,i="".concat(r.selector,"-").concat(a||"document","-").concat(n);if(!this.appliedSelectors.has(i)&&(this.debug&&(0,o.logDebug)("[ABsmartly] Applying pending change to element:",r.selector),this.applyFn(r,n,e))){this.appliedSelectors.add(i);var s="".concat(r.selector,"-").concat(a||"document"),l=this.pending.get(s);if(l){var c=l.filter(function(e){return e.experimentName!==n||e.change.selector!==r.selector});0===c.length?this.pending.delete(s):this.pending.set(s,c)}this.checkObserverCleanup(a)}},e.prototype.getObserverRoot=function(e){if(!e)return document.documentElement;var t=document.querySelector(e);return t||document.documentElement},e.prototype.checkObserverCleanup=function(e){var t,r,n=e||"document",i=!1;try{for(var s=a(this.pending.keys()),l=s.next();!l.done;l=s.next()){if(l.value.endsWith("-".concat(n))){i=!0;break}}}catch(e){t={error:e}}finally{try{l&&!l.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}if(!i){var c=this.observers.get(n);c&&(c.disconnect(),this.observers.delete(n),this.debug&&(0,o.logDebug)("[ABsmartly] Disconnected observer for root:",n))}},e.prototype.cleanupObservers=function(){var e,t,r,n,i=this,s=[];try{for(var l=a(this.observers.keys()),c=l.next();!c.done;c=l.next()){var u=c.value,g=!1;try{for(var h=(r=void 0,a(this.pending.keys())),d=h.next();!d.done;d=h.next()){if(d.value.endsWith("-".concat(u))){g=!0;break}}}catch(e){r={error:e}}finally{try{d&&!d.done&&(n=h.return)&&n.call(h)}finally{if(r)throw r.error}}g||s.push(u)}}catch(t){e={error:t}}finally{try{c&&!c.done&&(t=l.return)&&t.call(l)}finally{if(e)throw e.error}}s.forEach(function(e){var t=i.observers.get(e);t&&(t.disconnect(),i.observers.delete(e),i.debug&&(0,o.logDebug)("[ABsmartly] Cleaned up observer for root:",e))})},e.prototype.destroy=function(){var e,t;this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null);try{for(var r=a(this.observers.values()),n=r.next();!n.done;n=r.next()){n.value.disconnect()}}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}this.observers.clear(),this.pending.clear(),this.appliedSelectors.clear(),this.batchedWork.clear(),this.debug&&(0,o.logDebug)("[ABsmartly] PendingChangeManager destroyed")},e.prototype.getPendingCount=function(){var e,t,r=0;try{for(var n=a(this.pending.values()),i=n.next();!i.done;i=n.next()){r+=i.value.length}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}return r},e.prototype.getAppliedCount=function(){return this.appliedSelectors.size},e.prototype.hasPendingForExperiment=function(e){var t,r;try{for(var n=a(this.pending.values()),i=n.next();!i.done;i=n.next()){if(i.value.some(function(t){return t.experimentName===e}))return!0}}catch(e){t={error:e}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}return!1},e}();t.PendingChangeManager=s},252:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageBridge=void 0;var n=r(609),a=function(){function e(e){void 0===e&&(e=!1),this.handlers=new Map,this.isReady=!1,this.debug=e,this.setupListener()}return e.prototype.setupListener=function(){var e=this;window.addEventListener("message",function(t){if(t.source===window){var r=t.data;if(r&&"object"==typeof r&&"absmartly-extension"===r.source){(0,n.logMessage)("received",r.type,r.payload),e.debug&&(0,n.logDebug)("[ABsmartly] Received message:",r.type,r.payload);var a=e.handlers.get(r.type);if(a)try{a(r.payload||{})}catch(t){(0,n.logDebug)("[ABsmartly] Error handling message:",t),e.sendError(t instanceof Error?t.message:"Unknown error")}}}}),this.isReady=!0},e.prototype.on=function(e,t){this.handlers.set(e,t)},e.prototype.off=function(e){this.handlers.delete(e)},e.prototype.sendMessage=function(e,t){var r={source:"absmartly-sdk",type:e,payload:t};(0,n.logMessage)("sent",e,t),this.debug&&(0,n.logDebug)("[ABsmartly] Sending message:",e,t),window.postMessage(r,"*")},e.prototype.notifyReady=function(e,t){this.sendMessage("PLUGIN_READY",{version:e,capabilities:t})},e.prototype.requestInjectionCode=function(){this.sendMessage("REQUEST_INJECTION_CODE")},e.prototype.requestOverrides=function(){this.sendMessage("REQUEST_OVERRIDES")},e.prototype.notifyChangesApplied=function(e,t){this.sendMessage("CHANGES_APPLIED",{count:e,experimentName:t})},e.prototype.notifyChangesRemoved=function(e){this.sendMessage("CHANGES_REMOVED",{experimentName:e})},e.prototype.sendExperimentData=function(e){this.sendMessage("EXPERIMENT_DATA",{experiments:e})},e.prototype.sendOverridesData=function(e){this.sendMessage("OVERRIDES_DATA",{overrides:e})},e.prototype.notifyExperimentTriggered=function(e,t){this.sendMessage("EXPERIMENT_TRIGGERED",{experimentName:e,variant:t})},e.prototype.sendError=function(e){this.sendMessage("ERROR",{error:e})},e.prototype.notifyCodeInjected=function(e){this.sendMessage("CODE_INJECTED",{locations:e})},e.prototype.destroy=function(){this.handlers.clear(),this.isReady=!1},e.prototype.getIsReady=function(){return this.isReady},e}();t.MessageBridge=a},254:function(e,t,r){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,a)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.DOMChangesPlugin=void 0;var i=r(530);Object.defineProperty(t,"DOMChangesPlugin",{enumerable:!0,get:function(){return i.DOMChangesPlugin}}),a(r(574),t),t.default=i.DOMChangesPlugin},356:function(e,t,r){var n=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},a=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o},i=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,a=0,i=t.length;a<i;a++)!n&&a in t||(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.VariantExtractor=void 0;var o=r(609),s=function(){function e(e,t,r,n){void 0===t&&(t="variable"),void 0===r&&(r="__dom_changes"),void 0===n&&(n=!1),this.cachedAllChanges=null,this.context=e,this.dataSource=t,this.dataFieldName=r,this.debug=n}return e.prototype.clearCache=function(){this.cachedAllChanges=null},e.prototype.extractAllChanges=function(){var e,t,r,s,l,c,u;if(this.cachedAllChanges)return this.debug&&(0,o.logDebug)("[ABsmartly VariantExtractor] Returning cached changes"),this.cachedAllChanges;var g=new Map;try{var h=this.context.data();if((0,o.logDebug)("[VariantExtractor DEBUG] Raw context data structure:",{hasData:!!h,contextKeys:h?Object.keys(h):[],experimentCount:(null===(r=null==h?void 0:h.experiments)||void 0===r?void 0:r.length)||0,firstExperiment:(null===(s=null==h?void 0:h.experiments)||void 0===s?void 0:s[0])?{name:h.experiments[0].name,variantCount:(null===(l=h.experiments[0].variants)||void 0===l?void 0:l.length)||0,firstVariantStructure:(null===(c=h.experiments[0].variants)||void 0===c?void 0:c[0])?Object.keys(h.experiments[0].variants[0]):[]}:null,rawContextData:JSON.stringify(h).substring(0,500)+"..."}),this.debug&&(0,o.logDebug)("[ABsmartly VariantExtractor] Extracting changes from context:",{hasData:!!h,experimentCount:(null===(u=null==h?void 0:h.experiments)||void 0===u?void 0:u.length)||0}),null==h?void 0:h.experiments){this.debug&&(0,o.logDebug)("[ABsmartly VariantExtractor] Available experiments:",h.experiments.map(function(e){var t;return{name:e.name,hasVariants:!!e.variants,variantCount:(null===(t=e.variants)||void 0===t?void 0:t.length)||0}}));try{for(var d=n(h.experiments),p=d.next();!p.done;p=d.next()){var f=p.value,y=this.extractAllVariantsForExperiment(f);y.size>0?(g.set(f.name,y),this.debug&&(0,o.logDebug)("[ABsmartly VariantExtractor] Experiment '".concat(f.name,"' has DOM changes:"),{variantsWithChanges:Array.from(y.keys()),changesByVariant:Array.from(y.entries()).map(function(e){var t=a(e,2),r=t[0],n=t[1];return{variant:r,changeCount:n.length,changeTypes:i([],a(new Set(n.map(function(e){return e.type}))),!1)}})})):this.debug&&(0,o.logDebug)("[ABsmartly VariantExtractor] Experiment '".concat(f.name,"' has no DOM changes"))}}catch(t){e={error:t}}finally{try{p&&!p.done&&(t=d.return)&&t.call(d)}finally{if(e)throw e.error}}}}catch(e){(0,o.logDebug)("[ABsmartly] Error extracting DOM changes:",e)}return this.cachedAllChanges=g,g},e.prototype.extractAllVariantsForExperiment=function(e){var t,r=new Map;if((0,o.logDebug)("[DEBUG] Processing experiment:",e.name,"with",(null===(t=e.variants)||void 0===t?void 0:t.length)||0,"variants"),!e.variants)return(0,o.logDebug)("[DEBUG] No variants found for experiment:",e.name),r;for(var n=0;n<e.variants.length;n++){var a=e.variants[n];if(a){var i=null;if("variable"===this.dataSource){if(a.variables&&a.variables[this.dataFieldName])i=a.variables[this.dataFieldName],(0,o.logDebug)("[VariantExtractor DEBUG] ✓ Found DOM changes in variables[".concat(this.dataFieldName,"]:"),i);else if(a.config)try{var s="string"==typeof a.config?JSON.parse(a.config):a.config;s&&s[this.dataFieldName]?(i=s[this.dataFieldName],(0,o.logDebug)("[VariantExtractor DEBUG] ✓ Found DOM changes in config[".concat(this.dataFieldName,"]:"),i)):(0,o.logDebug)("[VariantExtractor DEBUG] ✗ No",this.dataFieldName,"field found in parsed config")}catch(e){(0,o.logDebug)("[VariantExtractor DEBUG] ✗ Failed to parse variant.config:",e,"Raw config:","string"==typeof a.config?a.config.substring(0,100):"")}if(i){var l=this.parseChanges(i);l&&l.length>0&&r.set(n,l)}}}}return r},e.prototype.getExperimentChanges=function(e){var t=this.extractAllChanges().get(e);if(!t||0===t.size)return null;var r=this.context.peek(e);return null==r?(this.debug&&(0,o.logDebug)("[ABsmartly] No variant selected for ".concat(e)),null):t.get(r)||null},e.prototype.parseChanges=function(e){var t,r;if(!e)return null;if("string"==typeof e)try{e=JSON.parse(e)}catch(e){return(0,o.logDebug)("[ABsmartly] Failed to parse DOM changes JSON:",e),null}if(!Array.isArray(e))return this.debug&&(0,o.logDebug)("[ABsmartly] DOM changes data is not an array"),null;var a=[];try{for(var i=n(e),s=i.next();!s.done;s=i.next()){var l=s.value;this.isValidChange(l)?a.push(l):this.debug&&(0,o.logDebug)("[ABsmartly] Invalid DOM change:",l)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}return a.length>0?a:null},e.prototype.isValidChange=function(e){if(!e||"object"!=typeof e)return!1;var t=e;if(!t.selector||!t.type)return!1;if(!["text","html","style","class","attribute","javascript","move","create"].includes(t.type))return!1;switch(t.type){case"class":if(!t.add&&!t.remove)return!1;if(t.add&&!Array.isArray(t.add))return!1;if(t.remove&&!Array.isArray(t.remove))return!1;break;case"move":if(!t.targetSelector)return!1;break;case"create":if(!t.element||!t.targetSelector)return!1;break;case"style":case"attribute":if(!t.value||"object"!=typeof t.value)return!1}return!0},e.prototype.getAllVariantChanges=function(e){var t=this.extractAllChanges().get(e);if(!t)return[];for(var r=Math.max.apply(Math,i([],a(t.keys()),!1)),n=[],o=0;o<=r;o++)n.push(t.get(o)||[]);return n},e.prototype.getExperiment=function(e){try{var t=this.context.data();return t&&t.experiments&&t.experiments.find(function(t){return t.name===e})||null}catch(t){return this.debug&&(0,o.logDebug)("[ABsmartly VariantExtractor] Failed to get experiment '".concat(e,"' - context may not be ready:"),t),null}},e}();t.VariantExtractor=s},530:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(a,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function s(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(l){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(i=0)),i;)try{if(r=1,n&&(a=2&s[0]?n.return:s[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,s[1])).done)return a;switch(n=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){i.label=s[1];break}if(6===s[0]&&i.label<a[1]){i.label=a[1],a=s;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(s);break}a[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],n=0}finally{r=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}},i=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},o=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o};Object.defineProperty(t,"__esModule",{value:!0}),t.DOMChangesPlugin=void 0;var s=r(944),l=r(624),c=r(252),u=r(937),g=r(356),h=r(693),d=r(713),p=r(609),f=function(){function e(e){var t,r,n,a,i,o,c;if(this.messageBridge=null,this.mutationObserver=null,this.visibilityObserver=null,this.persistenceObserver=null,this.exposedExperiments=new Set,this.eventListeners=new Map,this.styleManagers=new Map,this.watchedElements=new WeakMap,this.reapplyingElements=new WeakSet,this.reapplyLogThrottle=new Map,this.initialized=!1,this.config={context:e.context,autoApply:null===(t=e.autoApply)||void 0===t||t,spa:null===(r=e.spa)||void 0===r||r,visibilityTracking:null===(n=e.visibilityTracking)||void 0===n||n,extensionBridge:null===(a=e.extensionBridge)||void 0===a||a,dataSource:null!==(i=e.dataSource)&&void 0!==i?i:"variable",dataFieldName:null!==(o=e.dataFieldName)&&void 0!==o?o:"__dom_changes",debug:null!==(c=e.debug)&&void 0!==c&&c},!this.config.context)throw new Error("[ABsmartly] Context is required");this.stateManager=new s.StateManager,this.domManipulator=new l.DOMManipulator(this.stateManager,this.config.debug,this),this.codeInjector=new u.CodeInjector(this.config.debug),this.variantExtractor=new g.VariantExtractor(this.config.context,this.config.dataSource,this.config.dataFieldName,this.config.debug),this.exposureTracker=new d.ExposureTracker(this.config.context,this.config.debug)}return e.prototype.ready=function(){return n(this,void 0,void 0,function(){var t,r,n;return a(this,function(a){switch(a.label){case 0:if(this.initialized)return(0,p.logDebug)("Plugin already initialized"),[2];t=performance.now(),(0,p.logDebug)("Initializing ABsmartly DOM Changes Plugin",{version:e.VERSION,config:{autoApply:this.config.autoApply,spa:this.config.spa,visibilityTracking:this.config.visibilityTracking,extensionBridge:this.config.extensionBridge,dataSource:this.config.dataSource,DEBUG:p.DEBUG}}),a.label=1;case 1:return a.trys.push([1,4,,5]),this.config.extensionBridge&&this.setupMessageBridge(),this.config.spa&&this.setupMutationObserver(),this.config.autoApply?[4,this.applyChanges()]:[3,3];case 2:a.sent(),a.label=3;case 3:return this.config.extensionBridge&&this.messageBridge&&this.messageBridge.requestInjectionCode(),this.initialized=!0,this.registerWithContext(),this.emit("initialized"),r=performance.now()-t,(0,p.logPerformance)("Plugin initialization",r),console.log("[ABsmartly] DOM plugin loaded successfully (v".concat(e.VERSION,")")),this.config.debug&&(0,p.logDebug)("[ABsmartly] DOM Changes Plugin initialized with debug mode"),[3,5];case 4:throw n=a.sent(),(0,p.logDebug)("[ABsmartly] Failed to initialize plugin:",n),n;case 5:return[2]}})})},e.prototype.initialize=function(){return n(this,void 0,void 0,function(){return a(this,function(e){return[2,this.ready()]})})},e.prototype.setupMessageBridge=function(){var t=this;this.messageBridge=new c.MessageBridge(this.config.debug),this.messageBridge.on("APPLY_CHANGES",function(e){t.applyChanges(e.experimentName)}),this.messageBridge.on("REMOVE_CHANGES",function(e){t.removeChanges(e.experimentName)}),this.messageBridge.on("INJECTION_CODE",function(e){var r={headStart:e.headStart,headEnd:e.headEnd,bodyStart:e.bodyStart,bodyEnd:e.bodyEnd};t.injectCode(r)}),this.messageBridge.on("GET_EXPERIMENTS",function(){return n(t,void 0,void 0,function(){var e,t,r;return a(this,function(n){switch(n.label){case 0:return[4,this.config.context.ready()];case 1:return n.sent(),e=(null===(t=this.config.context.data())||void 0===t?void 0:t.experiments)||[],null===(r=this.messageBridge)||void 0===r||r.sendExperimentData(e),[2]}})})}),this.messageBridge.notifyReady(e.VERSION,["overrides","injection","spa","visibility"])},e.prototype.setupMutationObserver=function(){var e=this,t=new MutationObserver(function(){var t,r,n=e.stateManager.getPendingChanges();if(0!==n.length)try{for(var a=i(n),o=a.next();!o.done;o=a.next()){var s=o.value;if(document.querySelectorAll(s.change.selector).length>0)e.domManipulator.applyChange(s.change,s.experimentName)&&e.stateManager.removePendingChange(s.experimentName,s.change)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}});t.observe(document.body,{childList:!0,subtree:!0}),this.mutationObserver=t},e.prototype.applyChanges=function(e){return n(this,void 0,void 0,function(){var t,r,n,s,l,c,u,g,h,d,f,y,m,v,b,x,E,A,S,C,w,D,M,O,B,_,k,P,N,j,T,R,I;return a(this,function(a){switch(a.label){case 0:t=performance.now(),(0,p.logDebug)("Starting to apply changes",{specificExperiment:e||"all",action:"apply_start"}),this.config.debug&&((0,p.logDebug)("[ABsmartly] === DOM Changes Application Starting ==="),(0,p.logDebug)("[ABsmartly] Target:",e||"all experiments"),(0,p.logDebug)("[ABsmartly] Context ready:",!0)),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.config.context.ready()];case 2:return a.sent(),[3,4];case 3:return r=a.sent(),(0,p.logDebug)("[ABsmartly] Failed to wait for context ready:",r),[2];case 4:if(this.variantExtractor.clearCache(),e)x=this.variantExtractor.getExperimentChanges(e),n=new Map(x?[[e,x]]:[]),this.config.debug&&(s=this.config.context.peek(e),(0,p.logDebug)("[ABsmartly] Single experiment '".concat(e,"':"),{variant:s,hasChanges:!!x,changeCount:(null==x?void 0:x.length)||0}));else{l=this.variantExtractor.extractAllChanges(),n=new Map,(0,p.logDebug)("[ABsmartly] All available experiments with DOM changes:",Array.from(l.keys()));try{for(c=i(l),u=c.next();!u.done;u=c.next())g=o(u.value,2),b=g[0],h=g[1],A=this.config.context.peek(b),(0,p.logDebug)("[ABsmartly] Experiment '".concat(b,"':"),{assignedVariant:A||0,availableVariants:Array.from(h.keys())}),A?(x=h.get(A))&&x.length>0?(n.set(b,x),(0,p.logDebug)("[ABsmartly]   -> Will apply ".concat(x.length," changes for variant ").concat(A))):(0,p.logDebug)("[ABsmartly]   -> No changes found for variant ".concat(A)):(0,p.logDebug)("[ABsmartly]   -> No variant assigned (control or not in experiment)")}catch(e){k={error:e}}finally{try{u&&!u.done&&(P=c.return)&&P.call(c)}finally{if(k)throw k.error}}}d=0,f=new Map,(0,p.logDebug)("[ABsmartly] Experiments to process:",Array.from(n.keys())),(0,p.logDebug)("[ABsmartly] Total experiments with changes:",n.size),a.label=5;case 5:a.trys.push([5,11,12,13]),y=i(n),m=y.next(),a.label=6;case 6:if(m.done)return[3,10];v=o(m.value,2),b=v[0],x=v[1],E={total:x.length,success:0,pending:0},(0,p.logDebug)("[ABsmartly] Processing experiment '".concat(b,"' with ").concat(x.length," changes:"),x.map(function(e){return{type:e.type,selector:e.selector,trigger:e.trigger_on_view?"viewport":"immediate"}})),A=this.config.context.peek(b),S=this.variantExtractor.getAllVariantChanges(b),C=!1,w=!1;try{for(T=void 0,D=i(x),M=D.next();!M.done;M=D.next())O=M.value,0===document.querySelectorAll(O.selector).length&&"create"!==O.type?(this.config.spa||O.waitForElement)&&(this.stateManager.addPendingChange(b,O),E.pending++,O.trigger_on_view&&(w=!0)):this.domManipulator.applyChange(O,b)&&(d++,E.success++,O.trigger_on_view?w=!0:C=!0)}catch(e){T={error:e}}finally{try{M&&!M.done&&(R=D.return)&&R.call(D)}finally{if(T)throw T.error}}return(w||C)&&this.exposureTracker.registerExperiment(b,A||0,x,S),!C||w?[3,8]:[4,this.config.context.ready()];case 7:a.sent(),this.config.context.treatment(b),this.exposedExperiments.add(b),(0,p.logDebug)("Triggered immediate exposure for experiment: ".concat(b)),a.label=8;case 8:f.set(b,E),(0,p.logExperimentSummary)(b,E.total,E.success,E.pending),a.label=9;case 9:return m=y.next(),[3,6];case 10:return[3,13];case 11:return B=a.sent(),N={error:B},[3,13];case 12:try{m&&!m.done&&(j=y.return)&&j.call(y)}finally{if(N)throw N.error}return[7];case 13:return _=performance.now()-t,(0,p.logPerformance)("Apply changes",_,{totalApplied:d,experiments:f.size}),this.config.debug&&((0,p.logDebug)("[ABsmartly] === DOM Changes Application Complete ==="),(0,p.logDebug)("[ABsmartly] Summary:",{totalChangesApplied:d,experimentsProcessed:f.size,duration:"".concat(_.toFixed(2),"ms"),experiments:Array.from(f.entries()).map(function(e){var t=o(e,2),r=t[0],n=t[1];return{name:r,total:n.total,success:n.success,pending:n.pending,pendingReason:n.pending>0?"Elements not found yet (SPA mode will retry)":void 0}})})),this.emit("changes-applied",{count:d,experimentName:e}),null===(I=this.messageBridge)||void 0===I||I.notifyChangesApplied(d,e),[2]}})})},e.prototype.removeChanges=function(e){var t,r=performance.now(),n=[];(0,p.logDebug)("Starting to remove changes",{specificExperiment:e||"all",action:"remove_start"}),n=e?this.domManipulator.removeChanges(e):this.domManipulator.removeAllChanges();var a=performance.now()-r;return(0,p.logPerformance)("Remove changes",a,{changesRemoved:n.length}),this.config.debug&&(0,p.logDebug)("[ABsmartly] Removed ".concat(n.length," changes"),n),this.emit("changes-removed",{experimentName:e,removedChanges:n}),null===(t=this.messageBridge)||void 0===t||t.notifyChangesRemoved(e),n},e.prototype.refreshChanges=function(){this.removeChanges(),this.applyChanges()},e.prototype.injectCode=function(e){var t,r=this.codeInjector.inject(e);this.emit("code-injected",{locations:r}),null===(t=this.messageBridge)||void 0===t||t.notifyCodeInjected(r)},e.prototype.requestInjectionCode=function(){var e;null===(e=this.messageBridge)||void 0===e||e.requestInjectionCode()},e.prototype.getPendingChanges=function(){return this.stateManager.getPendingChanges()},e.prototype.hasChanges=function(e){return this.stateManager.hasChanges(e)},e.prototype.getOriginalState=function(e){var t,r;try{for(var n=i(["text","html","style","class","attribute","move"]),a=n.next();!a.done;a=n.next()){var o=a.value,s=this.stateManager.getOriginalState(e,o);if(s)return s}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}},e.prototype.removeSpecificChange=function(e,t,r){return this.domManipulator.removeSpecificChange(e,t,r)},e.prototype.applyChange=function(e,t){(0,p.logDebug)("Applying single change via public API",{experimentName:t,selector:e.selector,changeType:e.type});try{var r=this.domManipulator.applyChange(e,t);return r&&this.emit("change_applied",{experimentName:t,change:e}),r}catch(e){return this.config.debug&&(0,p.logDebug)("[ABsmartly] Error applying change:",e),!1}},e.prototype.removeAllChanges=function(e){return this.removeChanges(e)},e.prototype.getAppliedChanges=function(e){return e?this.stateManager.getAppliedChanges(e):this.stateManager.getAppliedChanges()},e.prototype.revertChange=function(e){try{return this.domManipulator.revertChange(e)}catch(e){return this.config.debug&&(0,p.logDebug)("[ABsmartly] Error reverting change:",e),!1}},e.prototype.on=function(e,t){var r=this.eventListeners.get(e)||[];r.push(t),this.eventListeners.set(e,r)},e.prototype.off=function(e,t){if(t){var r=this.eventListeners.get(e)||[],n=r.indexOf(t);-1!==n&&r.splice(n,1)}else this.eventListeners.delete(e)},e.prototype.emit=function(e,t){(this.eventListeners.get(e)||[]).forEach(function(r){try{r(t)}catch(t){(0,p.logDebug)("[ABsmartly] Error in event listener for ".concat(e,":"),t)}})},e.prototype.getStyleManager=function(e){var t="absmartly-styles-".concat(e),r=this.styleManagers.get(e);return r||(r=new h.StyleSheetManager(t,this.config.debug),this.styleManagers.set(e,r)),r},e.prototype.buildCssRule=function(e,t,r){void 0===r&&(r=!0);var n=Object.entries(t).map(function(e){var t=o(e,2),n=t[0],a=t[1],i=n.replace(/([A-Z])/g,"-$1").toLowerCase(),s=r?" !important":"";return"  ".concat(i,": ").concat(a).concat(s,";")}).join("\n");return"".concat(e," {\n").concat(n,"\n}")},e.prototype.buildStateRules=function(e,t,r){void 0===r&&(r=!0);var n=[];return t.normal&&n.push(this.buildCssRule(e,t.normal,r)),t.hover&&n.push(this.buildCssRule("".concat(e,":hover"),t.hover,r)),t.active&&n.push(this.buildCssRule("".concat(e,":active"),t.active,r)),t.focus&&n.push(this.buildCssRule("".concat(e,":focus"),t.focus,r)),n.join("\n\n")},e.prototype.setupPersistenceObserver=function(){var e=this;this.persistenceObserver||(this.persistenceObserver=new MutationObserver(function(t){window.__absmartlyVisualEditorModifying?(0,p.logDebug)("Skipping style persistence - visual editor is modifying DOM",{mutationCount:t.length}):t.forEach(function(t){var r=t.target;if(!e.reapplyingElements.has(r)){var n=e.watchedElements.get(r);n&&n.forEach(function(t){e.stateManager.getAppliedChanges(t).forEach(function(n){var a,s,l=n.change;if("style"===l.type&&r.matches(l.selector)&&e.checkStyleOverwritten(r,l.value)){if(window.__absmartlyVisualEditorModifying)return void(0,p.logDebug)("Skipping style reapplication - visual editor is modifying DOM",{selector:l.selector});e.reapplyingElements.add(r),e.domManipulator.applyChange(l,t);var c="".concat(t,"-").concat(l.selector),u=Date.now(),g=e.reapplyLogThrottle.get(c)||0;if(e.config.debug&&u-g>5e3&&((0,p.logDebug)("Reapplied style after mutation (React/framework conflict detected)",{experimentName:t,selector:l.selector,note:"This happens when the page framework (React/Vue/etc) fights with DOM changes"}),e.reapplyLogThrottle.set(c,u),e.reapplyLogThrottle.size>100)){var h=u-6e4;try{for(var d=i(e.reapplyLogThrottle.entries()),f=d.next();!f.done;f=d.next()){var y=o(f.value,2),m=y[0];y[1]<h&&e.reapplyLogThrottle.delete(m)}}catch(e){a={error:e}}finally{try{f&&!f.done&&(s=d.return)&&s.call(d)}finally{if(a)throw a.error}}}Promise.resolve().then(function(){e.reapplyingElements.delete(r)})}})})}})}),this.persistenceObserver.observe(document.body,{attributes:!0,attributeFilter:["style"],subtree:!0,attributeOldValue:!0}))},e.prototype.checkStyleOverwritten=function(e,t){var r,n;try{for(var a=i(Object.entries(t)),s=a.next();!s.done;s=a.next()){var l=o(s.value,2),c=l[0],u=l[1],g=c.replace(/([A-Z])/g,"-$1").toLowerCase(),h=e.style.getPropertyValue(g),d=e.style.getPropertyPriority(g);if(h!==u||u.includes("!important")&&!d)return!0}}catch(e){r={error:e}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}return!1},e.prototype.watchElement=function(e,t){var r=this.watchedElements.get(e);r||(r=new Set,this.watchedElements.set(e,r)),r.add(t),this.persistenceObserver||this.setupPersistenceObserver()},e.prototype.unwatchElement=function(e,t){var r=this.watchedElements.get(e);r&&(r.delete(t),0===r.size&&this.watchedElements.delete(e))},e.prototype.refreshExperiments=function(){this.config.debug&&(0,p.logDebug)("[ABsmartly] Refreshing experiments and clearing cache"),this.variantExtractor.clearCache(),this.config.autoApply&&this.applyChanges()},e.prototype.destroy=function(){this.removeChanges(),this.codeInjector.cleanup(),this.stateManager.clearAll(),this.domManipulator.destroy(),this.exposureTracker.destroy(),this.styleManagers.forEach(function(e){return e.destroy()}),this.styleManagers.clear(),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.visibilityObserver&&(this.visibilityObserver.disconnect(),this.visibilityObserver=null),this.persistenceObserver&&(this.persistenceObserver.disconnect(),this.persistenceObserver=null),this.messageBridge&&(this.messageBridge.destroy(),this.messageBridge=null),this.eventListeners.clear(),this.exposedExperiments.clear(),this.watchedElements=new WeakMap,this.unregisterFromContext(),this.initialized=!1,this.config.debug&&(0,p.logDebug)("[ABsmartly] DOM Changes Plugin destroyed")},e.prototype.registerWithContext=function(){this.config.context&&(this.config.context.__plugins||(this.config.context.__plugins={}),this.config.context.__plugins.domPlugin={name:"DOMChangesPlugin",version:e.VERSION,initialized:!0,capabilities:["overrides","injection","spa","visibility"],instance:this,timestamp:Date.now()},this.config.context.__domPlugin=this.config.context.__plugins.domPlugin,this.config.debug&&(0,p.logDebug)("[ABsmartly] DOMChangesPlugin registered with context at __plugins.domPlugin"))},e.prototype.unregisterFromContext=function(){var e;this.config.context&&((null===(e=this.config.context.__plugins)||void 0===e?void 0:e.domPlugin)&&delete this.config.context.__plugins.domPlugin,this.config.context.__domPlugin&&delete this.config.context.__domPlugin,this.config.debug&&(0,p.logDebug)("[ABsmartly] DOMChangesPlugin unregistered from context"))},e.VERSION="1.0.1",e}();t.DOMChangesPlugin=f},574:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},609:function(e,t){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},r.apply(this,arguments)},n=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o},a=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,a=0,i=t.length;a<i;a++)!n&&a in t||(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))};function i(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];if(t.DEBUG)if(2===e.length&&"string"==typeof e[0]&&"object"==typeof e[1]){var i=n(e,2),o=i[0],s=i[1];if(o.includes("Original state already stored"))return;if(o.includes("State store operation"))return;if(o.includes("Performance:")&&(null==s?void 0:s.duration)&&s.duration<5)return;if(o.includes("Message sent:")||o.includes("Message received:"))return;var l=(new Date).toISOString(),c="[ABsmartly Debug]";console.log("".concat(c," [").concat(l,"] ").concat(o),s)}else if(1===e.length&&"string"==typeof e[0]){if((o=e[0]).includes("Original state already stored"))return;if(o.includes("State store operation"))return;if(o.includes("Message sent:")||o.includes("Message received:"))return;l=(new Date).toISOString(),c="[ABsmartly Debug]";console.log("".concat(c," [").concat(l,"] ").concat(o))}else console.log.apply(console,a([],n(e),!1))}Object.defineProperty(t,"__esModule",{value:!0}),t.DEBUG=void 0,t.logDebug=i,t.logChangeApplication=function(e,r,n,a,o){if(t.DEBUG){i("".concat(o?"✓":"✗"," Applied ").concat(n," change to ").concat(a," element(s)"),{experimentName:e,selector:r,changeType:n,elementsCount:a,success:o})}},t.logChangeRemoval=function(e,r,n,a){if(t.DEBUG){i("Restored ".concat(a," element(s) to original state"),{experimentName:e,selector:r,changeType:n,elementsCount:a,action:"restore"})}},t.logExperimentSummary=function(e,r,n,a){if(t.DEBUG){i('Experiment "'.concat(e,'" summary'),{experimentName:e,totalChanges:r,successfulChanges:n,pendingChanges:a,successRate:r>0?"".concat(Math.round(n/r*100),"%"):"N/A"})}},t.logStateOperation=function(e,r,n,a){if(t.DEBUG){i("State ".concat(e," operation"),{operation:e,selector:r,changeType:n,experimentName:a})}},t.logVisibilityEvent=function(e,r,n){if(t.DEBUG){i(n?"Element became visible - experiment triggered":"Element visibility changed",{experimentName:e,selector:r.className||r.id||r.tagName,triggered:n,action:"visibility"})}},t.logMessage=function(e,r,n){if(t.DEBUG){i("Message ".concat(e,": ").concat(r),{direction:e,messageType:r,payload:n,bridge:"extension"})}},t.logPerformance=function(e,n,a){if(t.DEBUG){i("Performance: ".concat(e," took ").concat(n,"ms"),r({operation:e,duration:n,performance:!0},a))}},t.DEBUG=!1},624:function(e,t,r){var n=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o},a=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,a=0,i=t.length;a<i;a++)!n&&a in t||(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))},i=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.DOMManipulator=void 0;var o=r(609),s=r(214),l=function(){function e(e,t,r){void 0===t&&(t=!1);var n=this;this.stateManager=e,this.debug=t,this.plugin=r,this.pendingManager=new s.PendingChangeManager(function(e,t,r){return r?n.applyChangeToSpecificElement(e,t,r):n.applyChange(e,t)},t)}return e.prototype.applyChange=function(e,t){var r=this;if(!e.enabled&&void 0!==e.enabled)return(0,o.logDebug)("Skipping disabled change for experiment: ".concat(t),{experimentName:t,selector:e.selector,changeType:e.type}),!1;try{if("styleRules"===e.type)return this.applyStyleRules(e,t);var n=document.querySelectorAll(e.selector),a=[];if(0===n.length&&"create"!==e.type)return e.waitForElement?(this.debug&&(0,o.logDebug)("[ABsmartly] Element not found, adding to pending: ".concat(e.selector)),this.pendingManager.addPending({change:e,experimentName:t,observerRoot:e.observerRoot}),!0):(this.debug&&(0,o.logDebug)("[ABsmartly] No elements found for selector: ".concat(e.selector)),(0,o.logDebug)("No elements found for selector",{experimentName:t,selector:e.selector,changeType:e.type}),!1);if(n.forEach(function(n){if(r.stateManager.storeOriginalState(e.selector,n,e.type),r.applyChangeToElement(n,e),"javascript"===e.type){if(e.value)try{new Function("element",String(e.value))(n),a.push(n)}catch(e){(0,o.logDebug)("[ABsmartly] JavaScript execution error:",e)}}else if("move"===e.type){var i=e.targetSelector||(e.value&&"object"==typeof e.value?e.value.targetSelector:null),s=e.position||(e.value&&"object"==typeof e.value?e.value.position:null);if(i){var l=document.querySelector(i);l?(r.moveElement(n,l,s),a.push(n)):r.debug&&(0,o.logDebug)("[ABsmartly] Move target not found: ".concat(i))}}else a.push(n);n.setAttribute("data-absmartly-modified","true"),n.setAttribute("data-absmartly-experiment",t),"style"===e.type&&r.plugin.watchElement(n,t)}),"create"===e.type&&e.element&&e.targetSelector){var i=this.createElement(e,t);i&&a.push(i)}return a.length>0?(this.stateManager.addAppliedChange(t,e,a),e.waitForElement&&this.pendingManager.removePending(e.selector,t,e.observerRoot),(0,o.logChangeApplication)(t,e.selector,e.type,a.length,!0),!0):((0,o.logChangeApplication)(t,e.selector,e.type,0,!1),!1)}catch(r){return this.debug&&(0,o.logDebug)("[ABsmartly] Error applying DOM change:",r,e),(0,o.logDebug)("Error applying DOM change",{experimentName:t,selector:e.selector,changeType:e.type,error:r instanceof Error?r.message:"Unknown error"}),!1}},e.prototype.moveElement=function(e,t,r){var n,a,i,o=e.parentElement;if(o){var s=this.getParentSelector(o);s&&e.setAttribute("data-absmartly-original-parent",s)}switch(r){case"before":null===(n=t.parentElement)||void 0===n||n.insertBefore(e,t);break;case"after":t.nextSibling?null===(a=t.parentElement)||void 0===a||a.insertBefore(e,t.nextSibling):null===(i=t.parentElement)||void 0===i||i.appendChild(e);break;case"firstChild":t.firstChild?t.insertBefore(e,t.firstChild):t.appendChild(e);break;default:t.appendChild(e)}},e.prototype.createElement=function(e,t){if(!e.element||!e.targetSelector)return null;var r=document.querySelector(e.targetSelector);if(!r)return this.debug&&(0,o.logDebug)("[ABsmartly] Create target not found: ".concat(e.targetSelector)),null;var n=document.createElement("div");n.innerHTML=e.element;var a=n.firstElementChild;if(!a)return null;var i="".concat(t,"-").concat(e.selector,"-create-").concat(Date.now());return this.stateManager.addCreatedElement(i,a),this.moveElement(a,r,e.position),a.setAttribute("data-absmartly-created","true"),a.setAttribute("data-absmartly-experiment",t),a.setAttribute("data-absmartly-change-id",i),a},e.prototype.removeChanges=function(e){var t,r,s=this,l=[];this.pendingManager.removeAllPending(e),(0,o.logDebug)("Starting to remove changes for experiment: ".concat(e),{experimentName:e,action:"remove_start"});try{var c=this.stateManager.getAppliedChanges(e);l.push.apply(l,a([],n(c),!1));var u=function(t){var r=t.change,n=t.elements;if("styleRules"===r.type){var a=g.plugin.getStyleManager(e),i="".concat(r.selector,"::states");return a.deleteRule(i),document.querySelectorAll(r.selector).forEach(function(e){e.removeAttribute("data-absmartly-modified"),e.removeAttribute("data-absmartly-experiment"),e.removeAttribute("data-absmartly-style-rules")}),"continue"}if("delete"===r.type&&r.value){var l=r.value;if(l.html&&l.parentSelector){var c=document.querySelector(l.parentSelector);if(c){var u=document.createElement("div");u.innerHTML=l.html;var h=u.firstElementChild;if(h){if(l.nextSiblingSelector){var d=document.querySelector(l.nextSiblingSelector);d&&d.parentElement===c?c.insertBefore(h,d):c.appendChild(h)}else c.appendChild(h);(0,o.logDebug)("Restored deleted element",{experimentName:e,selector:r.selector,changeType:"delete"})}}}return"continue"}n.forEach(function(t){if(t.hasAttribute("data-absmartly-created")){var n=t.getAttribute("data-absmartly-change-id");n&&s.stateManager.removeCreatedElement(n),t.remove(),(0,o.logDebug)("Removed created element",{experimentName:e,changeId:n,changeType:"create"})}else{var a=s.stateManager.getOriginalState(r.selector,r.type);a?(s.restoreElement(t,a,r.type),(0,o.logChangeRemoval)(e,r.selector,r.type,1)):s.debug&&(0,o.logDebug)("[ABsmartly] No original state found for restoration",{selector:r.selector,type:r.type,experimentName:e}),t.removeAttribute("data-absmartly-modified"),t.removeAttribute("data-absmartly-experiment"),t.removeAttribute("data-absmartly-style-rules"),"style"===r.type&&s.plugin.unwatchElement(t,e)}}),g.stateManager.clearOriginalState(r.selector,r.type)},g=this;try{for(var h=i(c),d=h.next();!d.done;d=h.next()){u(d.value)}}catch(e){t={error:e}}finally{try{d&&!d.done&&(r=h.return)&&r.call(h)}finally{if(t)throw t.error}}this.stateManager.removeAppliedChanges(e);var p=this.plugin.getStyleManager(e);p&&p.destroy(),(0,o.logDebug)("Successfully removed changes for experiment: ".concat(e),{experimentName:e,changesRemoved:l.length,action:"remove_complete"})}catch(t){this.debug&&(0,o.logDebug)("[ABsmartly] Error removing changes for experiment:",t),(0,o.logDebug)("Error removing changes",{experimentName:e,error:t instanceof Error?t.message:"Unknown error"})}return l},e.prototype.applyStyleRules=function(e,t){try{var r=this.plugin.getStyleManager(t),n="".concat(e.selector,"::states"),a=this.plugin.buildStateRules(e.selector,e.states||{},!1!==e.important);r.setRule(n,a),this.debug&&((0,o.logDebug)("[ABsmartly] Applied style rule: ".concat(n)),(0,o.logDebug)("[ABsmartly] CSS: ".concat(a)));var i=e.selector.replace(/:hover|:active|:focus|:visited/g,""),s=void 0;try{(s=document.querySelectorAll(i)).forEach(function(e){e.setAttribute("data-absmartly-modified","true"),e.setAttribute("data-absmartly-experiment",t),e.setAttribute("data-absmartly-style-rules","true")})}catch(e){s=document.querySelectorAll('*[data-absmartly-experiment="'+t+'"]')}return this.stateManager.addAppliedChange(t,e,Array.from(s)),(0,o.logChangeApplication)(t,e.selector,"styleRules",s.length,!0),!0}catch(e){return this.debug&&(0,o.logDebug)("[ABsmartly] Error applying style rules:",e),!1}},e.prototype.applyChangeToElement=function(e,t){var r,i;switch(t.type){case"text":void 0!==t.value&&(e.textContent=String(t.value));break;case"html":void 0!==t.value&&(e.innerHTML=String(t.value));break;case"style":t.value&&"object"==typeof t.value&&Object.entries(t.value).forEach(function(t){var r=n(t,2),a=r[0],i=r[1],o=a.replace(/([A-Z])/g,"-$1").toLowerCase();e.style.setProperty(o,String(i))});break;case"class":t.add&&Array.isArray(t.add)&&(r=e.classList).add.apply(r,a([],n(t.add),!1)),t.remove&&Array.isArray(t.remove)&&(i=e.classList).remove.apply(i,a([],n(t.remove),!1));break;case"attribute":t.value&&"object"==typeof t.value&&Object.entries(t.value).forEach(function(t){var r=n(t,2),a=r[0],i=r[1];null==i?e.removeAttribute(a):e.setAttribute(a,String(i))});break;case"move":if(t.value&&"object"==typeof t.value){var s=t.value,l=document.querySelector(s.targetSelector);l?(s.originalTargetSelector&&s.originalPosition&&(e.setAttribute("data-absmartly-original-target",s.originalTargetSelector),e.setAttribute("data-absmartly-original-position",s.originalPosition)),this.moveElement(e,l,s.position)):this.debug&&(0,o.logDebug)("[ABsmartly] Move target not found: ".concat(s.targetSelector))}break;case"delete":if(t.value&&"object"==typeof t.value){var c=t.value;c.html&&e.setAttribute("data-absmartly-deleted-html",c.html),c.parentSelector&&e.setAttribute("data-absmartly-deleted-parent",c.parentSelector),c.nextSiblingSelector&&e.setAttribute("data-absmartly-deleted-sibling",c.nextSiblingSelector)}e.remove()}},e.prototype.restoreElement=function(e,t,r){var i,s=t.originalState;switch(r){case"text":void 0!==s.html?e.innerHTML=s.html:void 0!==s.text&&(e.textContent=s.text);break;case"html":void 0!==s.html&&(e.innerHTML=s.html);break;case"style":void 0!==s.style&&(""===s.style?e.removeAttribute("style"):e.setAttribute("style",s.style));break;case"class":this.debug&&(0,o.logDebug)("[ABsmartly] Restoring classes",{originalClasses:s.classList,currentClasses:Array.from(e.classList),selector:e.className}),s.classList?(e.className="",s.classList.length>0&&(i=e.classList).add.apply(i,a([],n(s.classList),!1))):e.className="",this.debug&&(0,o.logDebug)("[ABsmartly] Classes after restoration",{classes:Array.from(e.classList)});break;case"attribute":if(s.attributes){for(var l=new Set,c=0;c<e.attributes.length;c++)l.add(e.attributes[c].name);Object.entries(s.attributes).forEach(function(t){var r=n(t,2),a=r[0],i=r[1];e.setAttribute(a,i),l.delete(a)}),l.forEach(function(t){"style"===t||"class"===t||t.startsWith("data-absmartly-")||e.removeAttribute(t)})}break;case"move":var u=e.getAttribute("data-absmartly-original-target"),g=e.getAttribute("data-absmartly-original-position");if(u&&g){var h=document.querySelector(u);h?(this.moveElement(e,h,g),e.removeAttribute("data-absmartly-original-target"),e.removeAttribute("data-absmartly-original-position")):this.debug&&(0,o.logDebug)("[ABsmartly] Original move target not found: ".concat(u))}else s.parent&&(s.nextSibling?s.parent.insertBefore(e,s.nextSibling):s.parent.appendChild(e))}},e.prototype.removeAllChanges=function(e){var t,r,o=[];if(e){var s=this.removeChanges(e);o.push.apply(o,a([],n(s),!1))}else{var l=this.stateManager.getAllExperimentNames();try{for(var c=i(l),u=c.next();!u.done;u=c.next()){var g=u.value;s=this.removeChanges(g);o.push.apply(o,a([],n(s),!1))}}catch(e){t={error:e}}finally{try{u&&!u.done&&(r=c.return)&&r.call(c)}finally{if(t)throw t.error}}}return o},e.prototype.applyChangeToSpecificElement=function(e,t,r){try{if(this.stateManager.storeOriginalState(e.selector,r,e.type),this.applyChangeToElement(r,e),"javascript"===e.type&&e.value)try{new Function("element",String(e.value))(r)}catch(e){return(0,o.logDebug)("[ABsmartly] JavaScript execution error:",e),!1}else if("move"===e.type){var n=e.targetSelector||(e.value&&"object"==typeof e.value?e.value.targetSelector:null),a=e.position||(e.value&&"object"==typeof e.value?e.value.position:null);if(n){var i=document.querySelector(n);if(!i)return!1;this.moveElement(r,i,a)}}r.setAttribute("data-absmartly-modified","true"),r.setAttribute("data-absmartly-experiment",t),"style"===e.type&&this.plugin.watchElement(r,t);var s=this.stateManager.getAppliedChanges(t).find(function(t){return t.change.selector===e.selector&&t.change.type===e.type});return s?s.elements.includes(r)||s.elements.push(r):this.stateManager.addAppliedChange(t,e,[r]),!0}catch(e){return this.debug&&(0,o.logDebug)("[ABsmartly] Error applying change to specific element:",e),!1}},e.prototype.getParentSelector=function(e){if(e.id)return"#".concat(e.id);if(e.className){var t=e.className.split(" ").filter(function(e){return e&&!e.startsWith("absmartly")});if(t.length>0)return".".concat(t[0])}return e.tagName.toLowerCase()},e.prototype.destroy=function(){this.pendingManager.destroy()},e.prototype.removeSpecificChange=function(e,t,r){var n,a,s,l=this;(0,o.logDebug)("Removing specific change",{experimentName:e,selector:t,changeType:r,action:"remove_specific"});try{var c=this.stateManager.getAppliedChanges(e),u=c.filter(function(e){return e.change.selector===t&&e.change.type===r});if(0===u.length)return(0,o.logDebug)("Specific change not found",{experimentName:e,selector:t,changeType:r}),!1;var g=c.findIndex(function(e){return e.change.selector===t&&e.change.type===r}),h=c[g],d=h.change,p=h.elements;if(null===(s=p[0])||void 0===s?void 0:s.hasAttribute("data-absmartly-created"))p.forEach(function(e){var t=e.getAttribute("data-absmartly-change-id");t&&l.stateManager.removeCreatedElement(t),e.remove()});else{var f=this.stateManager.getOriginalState(d.selector,d.type);f&&p.forEach(function(e){l.restoreElement(e,f,d.type)});var y=u.filter(function(e,t){return c.indexOf(u[t])!==g}),m=function(e){document.querySelectorAll(e.change.selector).forEach(function(t){l.applyChangeToElement(t,e.change)})};try{for(var v=i(y),b=v.next();!b.done;b=v.next()){m(b.value)}}catch(e){n={error:e}}finally{try{b&&!b.done&&(a=v.return)&&a.call(v)}finally{if(n)throw n.error}}0===y.length&&p.forEach(function(e){e.removeAttribute("data-absmartly-modified"),e.removeAttribute("data-absmartly-experiment")})}return this.stateManager.removeSpecificAppliedChange(e,t,r),(0,o.logChangeRemoval)(e,t,r,p.length),!0}catch(e){return this.debug&&(0,o.logDebug)("[ABsmartly] Error removing specific change:",e),!1}},e.prototype.revertChange=function(e){var t=this,r=e.experimentName,n=e.change,a=e.elements;try{return a.forEach(function(e){if(e)if(e.hasAttribute("data-absmartly-created")){var r=e.getAttribute("data-absmartly-change-id");r&&t.stateManager.removeCreatedElement(r),e.remove()}else{var a=t.stateManager.getOriginalState(n.selector,n.type);a&&t.restoreElement(e,a,n.type),e.removeAttribute("data-absmartly-modified"),e.removeAttribute("data-absmartly-experiment")}}),(0,o.logChangeRemoval)(r,n.selector,n.type,a.length),!0}catch(e){return this.debug&&(0,o.logDebug)("[ABsmartly] Error reverting change:",e),!1}},e}();t.DOMManipulator=l},693:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.StyleSheetManager=void 0;var n=r(609),a=function(){function e(e,t){void 0===t&&(t=!1),this.id=e,this.styleEl=null,this.rules=new Map,this.debug=t}return e.prototype.ensure=function(){if(!(this.styleEl&&document.head.contains(this.styleEl)||(this.styleEl=document.getElementById(this.id),this.styleEl))){var e=document.createElement("style");e.id=this.id,e.setAttribute("data-absmartly-styles","true"),document.head.appendChild(e),this.styleEl=e,this.debug&&(0,n.logDebug)("[ABsmartly] Created stylesheet: ".concat(this.id))}return this.styleEl},e.prototype.setRule=function(e,t){this.rules.set(e,t),this.render(),this.debug&&(0,n.logDebug)("[ABsmartly] Set CSS rule for ".concat(e))},e.prototype.deleteRule=function(e){this.rules.delete(e)&&(this.render(),this.debug&&(0,n.logDebug)("[ABsmartly] Deleted CSS rule for ".concat(e)))},e.prototype.hasRule=function(e){return this.rules.has(e)},e.prototype.clear=function(){var e=this.rules.size>0;this.rules.clear(),e&&(this.render(),this.debug&&(0,n.logDebug)("[ABsmartly] Cleared all CSS rules from ".concat(this.id)))},e.prototype.destroy=function(){this.clear(),this.styleEl&&document.head.contains(this.styleEl)&&(this.styleEl.remove(),this.styleEl=null,this.debug&&(0,n.logDebug)("[ABsmartly] Destroyed stylesheet: ".concat(this.id)))},e.prototype.render=function(){var e=this.ensure(),t=Array.from(this.rules.values()).join("\n\n");e.textContent=t},e.prototype.getRulesCount=function(){return this.rules.size},e.prototype.getCssText=function(){return Array.from(this.rules.values()).join("\n\n")},e}();t.StyleSheetManager=a},713:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(a,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function s(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(l){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(i=0)),i;)try{if(r=1,n&&(a=2&s[0]?n.return:s[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,s[1])).done)return a;switch(n=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){i.label=s[1];break}if(6===s[0]&&i.label<a[1]){i.label=a[1],a=s;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(s);break}a[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],n=0}finally{r=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}},i=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o},o=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,a=0,i=t.length;a<i;a++)!n&&a in t||(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.ExposureTracker=void 0;var s=r(609),l=function(){function e(e,t){void 0===t&&(t=!1),this.context=e,this.experiments=new Map,this.trackedElements=new Map,this.mutationObserver=null,this.placeholders=new Map,this.debug=t,this.setupIntersectionObserver()}return e.prototype.registerExperiment=function(e,t,r,n){var a=this;this.debug&&(0,s.logDebug)("[ABsmartly] Registering experiment ".concat(e," for exposure tracking"));var l=new Set,c=new Set,u=new Map;n.forEach(function(e){e.forEach(function(e){e.trigger_on_view&&("move"===e.type?(u.has(e.selector)||u.set(e.selector,new Set),e.targetSelector&&u.get(e.selector).add(e.targetSelector)):l.add(e.selector))})}),u.forEach(function(e,t){var r=document.querySelector(t);if(null==r?void 0:r.parentElement){var n=a.getStableParentSelector(r.parentElement);n&&c.add(n)}e.forEach(function(e){return c.add(e)})});var g=!1,h=!1;r.forEach(function(e){e.trigger_on_view?h=!0:g=!0});var d={experimentName:e,variant:t,changes:r,allPossibleSelectors:new Set(o(o([],i(l),!1),i(c),!1)),triggered:!1,hasImmediateTrigger:g,hasViewportTrigger:h};this.experiments.set(e,d),this.debug&&(0,s.logDebug)("[ABsmartly] Experiment ".concat(e," will track selectors:"),Array.from(d.allPossibleSelectors)),h&&this.observeSelectors(e,d.allPossibleSelectors),g&&this.triggerExposure(e).catch(function(t){(0,s.logDebug)("[ABsmartly] Failed to trigger exposure for ".concat(e,":"),t)})},e.prototype.getOriginalParentForMove=function(e){var t=document.querySelector(e);return(null==t?void 0:t.parentElement)?this.getStableParentSelector(t.parentElement):null},e.prototype.getStableParentSelector=function(e){if(e.id)return"#".concat(e.id);if(e.className){var t=e.className.split(" ").filter(function(e){return e&&!e.startsWith("absmartly")});if(t.length>0)return".".concat(t[0])}var r=e.parentElement;if(r){var n=Array.from(r.children).indexOf(e);return"".concat(e.tagName.toLowerCase(),":nth-child(").concat(n+1,")")}return null},e.prototype.observeSelectors=function(e,t){var r=this;t.forEach(function(t){var n=document.querySelectorAll(t);n.length>0?n.forEach(function(t){r.trackElement(t,e)}):r.watchForSelector(t,e)})},e.prototype.trackElement=function(e,t){this.trackedElements.has(e)?this.trackedElements.get(e).experiments.add(t):(this.trackedElements.set(e,{element:e,experiments:new Set([t]),isPlaceholder:e.hasAttribute("data-absmartly-placeholder")}),this.observer.observe(e))},e.prototype.watchForSelector=function(e,t){this.mutationObserver||this.setupMutationObserver()},e.prototype.setupIntersectionObserver=function(){var e=this;this.observer=new IntersectionObserver(function(t){t.forEach(function(t){t.isIntersecting&&e.handleElementVisible(t.target)})},{threshold:.01,rootMargin:"0px"})},e.prototype.setupMutationObserver=function(){var e=this;this.mutationObserver=new MutationObserver(function(t){t.forEach(function(t){t.addedNodes.forEach(function(t){t instanceof Element&&e.checkNewElement(t)})})}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0})},e.prototype.checkNewElement=function(e){var t=this;this.experiments.forEach(function(r,n){r.allPossibleSelectors.forEach(function(r){e.matches(r)&&t.trackElement(e,n),e.querySelectorAll(r).forEach(function(e){t.trackElement(e,n)})})})},e.prototype.handleElementVisible=function(e){var t=this,r=this.trackedElements.get(e);r&&r.experiments.forEach(function(n){var a=t.experiments.get(n);if(a&&!a.triggered&&(t.triggerExposure(n).catch(function(e){(0,s.logDebug)("[ABsmartly] Failed to trigger exposure for ".concat(n,":"),e)}),t.debug)){var i=r.isPlaceholder?e.getAttribute("data-absmartly-original-selector"):t.getElementSelector(e);(0,s.logDebug)("[ABsmartly] Triggering exposure for ".concat(n," via ").concat(i))}})},e.prototype.triggerExposure=function(e){return n(this,void 0,void 0,function(){var t;return a(this,function(r){switch(r.label){case 0:return!(t=this.experiments.get(e))||t.triggered?[2]:[4,this.context.ready()];case 1:return r.sent(),this.context.treatment(e),t.triggered=!0,this.debug&&(0,s.logDebug)("[ABsmartly] Exposure triggered for experiment: ".concat(e)),this.cleanupExperiment(e),[2]}})})},e.prototype.cleanupExperiment=function(e){var t=this;this.trackedElements.forEach(function(r,n){r.experiments.delete(e),0===r.experiments.size&&(t.observer.unobserve(n),t.trackedElements.delete(n))}),this.placeholders.forEach(function(r,n){n.startsWith("".concat(e,"-"))&&(r.remove(),t.placeholders.delete(n))}),this.experiments.delete(e),0===this.experiments.size&&this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null)},e.prototype.getElementSelector=function(e){if(e.id)return"#".concat(e.id);if(e.className){var t=e.className.split(" ").filter(function(e){return e&&!e.startsWith("absmartly")});if(t.length>0)return".".concat(t.join("."))}return e.tagName.toLowerCase()},e.prototype.needsViewportTracking=function(e){var t,r=this.experiments.get(e);return null!==(t=null==r?void 0:r.hasViewportTrigger)&&void 0!==t&&t},e.prototype.isTriggered=function(e){var t,r=this.experiments.get(e);return null!==(t=null==r?void 0:r.triggered)&&void 0!==t&&t},e.prototype.destroy=function(){this.observer.disconnect(),this.mutationObserver&&this.mutationObserver.disconnect(),this.placeholders.forEach(function(e){return e.remove()}),this.experiments.clear(),this.trackedElements.clear(),this.placeholders.clear(),this.debug&&(0,s.logDebug)("[ABsmartly] ExposureTracker destroyed")},e}();t.ExposureTracker=l},937:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CodeInjector=void 0;var n=r(609),a=function(){function e(e){void 0===e&&(e=!1),this.injectedLocations=new Set,this.debug=e}return e.prototype.inject=function(e){var t=[];return e.headStart&&e.headStart.trim()&&this.injectScript("head-start",e.headStart)&&t.push("head-start"),e.headEnd&&e.headEnd.trim()&&this.injectScript("head-end",e.headEnd)&&t.push("head-end"),e.bodyStart&&e.bodyStart.trim()&&this.injectScript("body-start",e.bodyStart)&&t.push("body-start"),e.bodyEnd&&e.bodyEnd.trim()&&this.injectScript("body-end",e.bodyEnd)&&t.push("body-end"),t},e.prototype.injectScript=function(e,t){if(this.injectedLocations.has(e))return!1;try{var r=document.createElement("script");switch(r.textContent=t,r.setAttribute("data-absmartly-injected",e),e){case"head-start":if(!document.head)return!1;document.head.firstChild?document.head.insertBefore(r,document.head.firstChild):document.head.appendChild(r);break;case"head-end":if(!document.head)return!1;document.head.appendChild(r);break;case"body-start":if(!document.body)return!1;document.body.firstChild?document.body.insertBefore(r,document.body.firstChild):document.body.appendChild(r);break;case"body-end":if(!document.body)return!1;document.body.appendChild(r);break;default:return!1}return this.injectedLocations.add(e),this.debug&&(0,n.logDebug)("[ABsmartly] Injecting code at ".concat(e)),!0}catch(t){return this.debug&&(0,n.logDebug)("[ABsmartly] Error injecting code at ".concat(e,":"),t),!1}},e.prototype.cleanup=function(){var e=this;document.querySelectorAll("script[data-absmartly-injected]").forEach(function(t){var r=t.getAttribute("data-absmartly-injected");r&&e.debug&&(0,n.logDebug)("[ABsmartly] Removing injected script at ".concat(r)),t.remove()}),this.injectedLocations.clear()},e.prototype.getInjectedLocations=function(){return Array.from(this.injectedLocations)},e.prototype.hasInjectedAt=function(e){return this.injectedLocations.has(e)},e}();t.CodeInjector=a},944:function(e,t,r){var n=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o},a=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,a=0,i=t.length;a<i;a++)!n&&a in t||(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.StateManager=void 0;var i=r(609),o=function(){function e(){this.appliedChanges=new Map,this.pendingChanges=new Map,this.originalStates=new Map,this.createdElements=new Map}return e.prototype.storeOriginalState=function(e,t,r){var n="".concat(e,"-").concat(r);if(this.originalStates.has(n))(0,i.logDebug)("Original state already stored",{selector:e,changeType:r,action:"skip_store"});else{var a={selector:e,type:r,originalState:{}};switch(r){case"text":a.originalState.text=t.textContent||"",t.children.length>0&&(a.originalState.html=t.innerHTML);break;case"html":a.originalState.html=t.innerHTML;break;case"style":a.originalState.style=t.getAttribute("style")||"";break;case"class":a.originalState.classList=Array.from(t.classList);break;case"attribute":a.originalState.attributes={};for(var o=0;o<t.attributes.length;o++){var s=t.attributes[o];"style"===s.name||"class"===s.name||s.name.startsWith("data-absmartly-")||(a.originalState.attributes[s.name]=s.value)}break;case"move":a.originalState.parent=t.parentElement,a.originalState.nextSibling=t.nextElementSibling}this.originalStates.set(n,a),(0,i.logStateOperation)("store",e,r)}},e.prototype.getOriginalState=function(e,t){return this.originalStates.get("".concat(e,"-").concat(t))},e.prototype.clearOriginalState=function(e,t){var r="".concat(e,"-").concat(t);this.originalStates.has(r)&&(this.originalStates.delete(r),(0,i.logDebug)("Cleared original state",{selector:e,changeType:t,action:"clear_state"}))},e.prototype.addAppliedChange=function(e,t,r){var n={experimentName:e,change:t,elements:r,timestamp:Date.now()};(0,i.logDebug)("Adding applied change",{experimentName:e,selector:t.selector,changeType:t.type,elementsCount:r.length});var a=this.appliedChanges.get(e)||[];a.push(n),this.appliedChanges.set(e,a)},e.prototype.getAppliedChanges=function(e){if(e)return this.appliedChanges.get(e)||[];var t=[];return this.appliedChanges.forEach(function(e){t.push.apply(t,a([],n(e),!1))}),t},e.prototype.removeAppliedChanges=function(e){var t;if(e){var r=(null===(t=this.appliedChanges.get(e))||void 0===t?void 0:t.length)||0;this.appliedChanges.delete(e),(0,i.logDebug)("Removed applied changes for experiment",{experimentName:e,changesRemoved:r})}else{var n=this.getAppliedChanges().length;this.appliedChanges.clear(),(0,i.logDebug)("Cleared all applied changes",{changesRemoved:n})}},e.prototype.removeSpecificAppliedChange=function(e,t,r){var n=this.appliedChanges.get(e);if(n){var a=n.findIndex(function(e){return e.change.selector===t&&e.change.type===r});-1!==a&&(n.splice(a,1),0===n.length?this.appliedChanges.delete(e):this.appliedChanges.set(e,n),(0,i.logDebug)("Removed specific applied change",{experimentName:e,selector:t,changeType:r}))}},e.prototype.addPendingChange=function(e,t){var r={experimentName:e,change:t,retryCount:0},n=this.pendingChanges.get(e)||[];n.push(r),this.pendingChanges.set(e,n),(0,i.logDebug)("Added pending change (element not found)",{experimentName:e,selector:t.selector,changeType:t.type,totalPending:n.length})},e.prototype.getPendingChanges=function(e){if(e)return this.pendingChanges.get(e)||[];var t=[];return this.pendingChanges.forEach(function(e){t.push.apply(t,a([],n(e),!1))}),t},e.prototype.removePendingChange=function(e,t){var r=this.pendingChanges.get(e);if(r){var n=r.findIndex(function(e){return e.change.selector===t.selector&&e.change.type===t.type});-1!==n&&(r.splice(n,1),0===r.length&&this.pendingChanges.delete(e))}},e.prototype.incrementRetryCount=function(e,t){var r=this.pendingChanges.get(e);if(r){var n=r.find(function(e){return e.change.selector===t.selector&&e.change.type===t.type});n&&n.retryCount++}},e.prototype.addCreatedElement=function(e,t){this.createdElements.set(e,t)},e.prototype.getCreatedElement=function(e){return this.createdElements.get(e)},e.prototype.removeCreatedElement=function(e){var t=this.createdElements.get(e);t&&(t.remove(),this.createdElements.delete(e))},e.prototype.clearAll=function(){var e={appliedChanges:this.getAppliedChanges().length,pendingChanges:this.getPendingChanges().length,originalStates:this.originalStates.size,createdElements:this.createdElements.size};this.appliedChanges.clear(),this.pendingChanges.clear(),this.originalStates.clear(),this.createdElements.forEach(function(e){return e.remove()}),this.createdElements.clear(),(0,i.logDebug)("Cleared all state",e)},e.prototype.hasChanges=function(e){return this.appliedChanges.has(e)},e.prototype.getAllExperimentNames=function(){return Array.from(this.appliedChanges.keys())},e}();t.StateManager=o}},t={};var r=function r(n){var a=t[n];if(void 0!==a)return a.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,r),i.exports}(254);return r})());
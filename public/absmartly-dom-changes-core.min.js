!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ABsmartlyDOM=t():e.ABsmartlyDOM=t()}(this,()=>(()=>{"use strict";var e={214:function(e,t,r){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},n.apply(this,arguments)},i=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},a=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,a=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}return o};Object.defineProperty(t,"__esModule",{value:!0}),t.PendingChangeManager=void 0;var o=r(609),l=function(){function e(e,t){void 0===t&&(t=!1),this.applyFn=e,this.pending=new Map,this.observers=new Map,this.appliedSelectors=new Set,this.batchTimer=null,this.batchedWork=new Set,this.debug=t}return e.prototype.addPending=function(e){var t=e.change,r=e.observerRoot,i=r;r&&!document.querySelector(r)&&(this.debug&&(0,o.logDebug)("[ABsmartly] Observer root not found, using document:",r),i=void 0);var a="".concat(t.selector,"-").concat(i||"document");this.debug&&(0,o.logDebug)("[ABsmartly] Adding pending change for selector:",t.selector);var l=this.getObserverRoot(i).querySelector(t.selector);if(l)this.applyChange(l,n(n({},e),{observerRoot:i}));else{var s=this.pending.get(a)||[];s.push(n(n({},e),{observerRoot:i})),this.pending.set(a,s),this.ensureObserver(i)}},e.prototype.removePending=function(e,t,r){var n="".concat(e,"-").concat(r||"document"),i=this.pending.get(n);if(i){var a=i.filter(function(e){return e.experimentName!==t});0===a.length?this.pending.delete(n):this.pending.set(n,a)}this.checkObserverCleanup(r)},e.prototype.removeAllPending=function(e){var t,r;try{for(var n=i(this.pending.entries()),o=n.next();!o.done;o=n.next()){var l=a(o.value,2),s=l[0],c=l[1].filter(function(t){return t.experimentName!==e});0===c.length?this.pending.delete(s):this.pending.set(s,c)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}this.cleanupObservers()},e.prototype.ensureObserver=function(e){var t=this,r=e||"document";if(!this.observers.has(r)){var n=this.getObserverRoot(e),i=new MutationObserver(function(r){t.handleMutations(r,e)});i.observe(n,{childList:!0,subtree:!0}),this.observers.set(r,i),this.debug&&(0,o.logDebug)("[ABsmartly] Started observer for root:",r)}},e.prototype.handleMutations=function(e,t){var r,n,o,l,s=this,c=[];try{for(var u=i(e),h=u.next();!h.done;h=u.next()){var p=h.value,g=function(e){var r,n,o,l;if(!(e instanceof Element))return"continue";var u=t||"document";try{for(var h=(r=void 0,i(d.pending.entries())),p=h.next();!p.done;p=h.next()){var g=a(p.value,2),f=g[0],y=g[1];if(f.endsWith("-".concat(u))){var v=function(t){var r=t.change;if(e.matches(r.selector))return c.push(function(){return s.applyChange(e,t)}),"continue";e.querySelectorAll(r.selector).forEach(function(e){c.push(function(){return s.applyChange(e,t)})})};try{for(var m=(o=void 0,i(y)),b=m.next();!b.done;b=m.next()){v(b.value)}}catch(e){o={error:e}}finally{try{b&&!b.done&&(l=m.return)&&l.call(m)}finally{if(o)throw o.error}}}}}catch(e){r={error:e}}finally{try{p&&!p.done&&(n=h.return)&&n.call(h)}finally{if(r)throw r.error}}},d=this;try{for(var f=(o=void 0,i(p.addedNodes)),y=f.next();!y.done;y=f.next()){g(y.value)}}catch(e){o={error:e}}finally{try{y&&!y.done&&(l=f.return)&&l.call(f)}finally{if(o)throw o.error}}}}catch(e){r={error:e}}finally{try{h&&!h.done&&(n=u.return)&&n.call(u)}finally{if(r)throw r.error}}c.length>0&&this.batchWork(c)},e.prototype.batchWork=function(e){var t=this;e.forEach(function(e){return t.batchedWork.add(e)}),this.batchTimer&&clearTimeout(this.batchTimer),this.batchTimer=setTimeout(function(){t.processBatchedWork()},32)},e.prototype.processBatchedWork=function(){var e=Array.from(this.batchedWork);this.batchedWork.clear(),this.batchTimer=null,this.debug&&e.length>0&&(0,o.logDebug)("[ABsmartly] Processing batched work:",e.length,"items"),e.forEach(function(e){return e()})},e.prototype.applyChange=function(e,t){var r=t.change,n=t.experimentName,i=t.observerRoot,a="".concat(r.selector,"-").concat(i||"document","-").concat(n);if(!this.appliedSelectors.has(a)&&(this.debug&&(0,o.logDebug)("[ABsmartly] Applying pending change to element:",r.selector),this.applyFn(r,n,e))){this.appliedSelectors.add(a);var l="".concat(r.selector,"-").concat(i||"document"),s=this.pending.get(l);if(s){var c=s.filter(function(e){return e.experimentName!==n||e.change.selector!==r.selector});0===c.length?this.pending.delete(l):this.pending.set(l,c)}this.checkObserverCleanup(i)}},e.prototype.getObserverRoot=function(e){if(!e)return document.documentElement;var t=document.querySelector(e);return t||document.documentElement},e.prototype.checkObserverCleanup=function(e){var t,r,n=e||"document",a=!1;try{for(var l=i(this.pending.keys()),s=l.next();!s.done;s=l.next()){if(s.value.endsWith("-".concat(n))){a=!0;break}}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=l.return)&&r.call(l)}finally{if(t)throw t.error}}if(!a){var c=this.observers.get(n);c&&(c.disconnect(),this.observers.delete(n),this.debug&&(0,o.logDebug)("[ABsmartly] Disconnected observer for root:",n))}},e.prototype.cleanupObservers=function(){var e,t,r,n,a=this,l=[];try{for(var s=i(this.observers.keys()),c=s.next();!c.done;c=s.next()){var u=c.value,h=!1;try{for(var p=(r=void 0,i(this.pending.keys())),g=p.next();!g.done;g=p.next()){if(g.value.endsWith("-".concat(u))){h=!0;break}}}catch(e){r={error:e}}finally{try{g&&!g.done&&(n=p.return)&&n.call(p)}finally{if(r)throw r.error}}h||l.push(u)}}catch(t){e={error:t}}finally{try{c&&!c.done&&(t=s.return)&&t.call(s)}finally{if(e)throw e.error}}l.forEach(function(e){var t=a.observers.get(e);t&&(t.disconnect(),a.observers.delete(e),a.debug&&(0,o.logDebug)("[ABsmartly] Cleaned up observer for root:",e))})},e.prototype.destroy=function(){var e,t;this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null);try{for(var r=i(this.observers.values()),n=r.next();!n.done;n=r.next()){n.value.disconnect()}}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}this.observers.clear(),this.pending.clear(),this.appliedSelectors.clear(),this.batchedWork.clear(),this.debug&&(0,o.logDebug)("[ABsmartly] PendingChangeManager destroyed")},e.prototype.getPendingCount=function(){var e,t,r=0;try{for(var n=i(this.pending.values()),a=n.next();!a.done;a=n.next()){r+=a.value.length}}catch(t){e={error:t}}finally{try{a&&!a.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}return r},e.prototype.getAppliedCount=function(){return this.appliedSelectors.size},e.prototype.hasPendingForExperiment=function(e){var t,r;try{for(var n=i(this.pending.values()),a=n.next();!a.done;a=n.next()){if(a.value.some(function(t){return t.experimentName===e}))return!0}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}return!1},e}();t.PendingChangeManager=l},254:function(e,t,r){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.DOMChangesPlugin=t.DOMChangesPluginLite=void 0;var a=r(702);Object.defineProperty(t,"DOMChangesPluginLite",{enumerable:!0,get:function(){return a.DOMChangesPluginLite}}),Object.defineProperty(t,"DOMChangesPlugin",{enumerable:!0,get:function(){return a.DOMChangesPluginLite}}),i(r(574),t),t.default=a.DOMChangesPluginLite},356:function(e,t,r){var n=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},i=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,a=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}return o},a=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,i=0,a=t.length;i<a;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.VariantExtractor=void 0;var o=r(609),l=r(973),s=function(){function e(e,t,r,n){void 0===t&&(t="variable"),void 0===r&&(r="__dom_changes"),void 0===n&&(n=!1),this.cachedAllChanges=null,this.context=e,this.dataSource=t,this.dataFieldName=r,this.debug=n}return e.prototype.clearCache=function(){this.cachedAllChanges=null},e.prototype.extractAllChanges=function(){var e,t,r,l,s,c,u;if(this.cachedAllChanges)return this.debug&&(0,o.logDebug)("[ABsmartly VariantExtractor] Returning cached changes"),this.cachedAllChanges;var h=new Map;try{var p=this.context.data();if((0,o.logDebug)("[VariantExtractor DEBUG] Raw context data structure:",{hasData:!!p,contextKeys:p?Object.keys(p):[],experimentCount:(null===(r=null==p?void 0:p.experiments)||void 0===r?void 0:r.length)||0,firstExperiment:(null===(l=null==p?void 0:p.experiments)||void 0===l?void 0:l[0])?{name:p.experiments[0].name,variantCount:(null===(s=p.experiments[0].variants)||void 0===s?void 0:s.length)||0,firstVariantStructure:(null===(c=p.experiments[0].variants)||void 0===c?void 0:c[0])?Object.keys(p.experiments[0].variants[0]):[]}:null,rawContextData:JSON.stringify(p).substring(0,500)+"..."}),this.debug&&(0,o.logDebug)("[ABsmartly VariantExtractor] Extracting changes from context:",{hasData:!!p,experimentCount:(null===(u=null==p?void 0:p.experiments)||void 0===u?void 0:u.length)||0}),null==p?void 0:p.experiments){this.debug&&(0,o.logDebug)("[ABsmartly VariantExtractor] Available experiments:",p.experiments.map(function(e){var t;return{name:e.name,hasVariants:!!e.variants,variantCount:(null===(t=e.variants)||void 0===t?void 0:t.length)||0}}));try{for(var g=n(p.experiments),d=g.next();!d.done;d=g.next()){var f=d.value,y=this.extractAllVariantsForExperiment(f);y.size>0?(h.set(f.name,y),this.debug&&(0,o.logDebug)("[ABsmartly VariantExtractor] Experiment '".concat(f.name,"' has DOM changes:"),{variantsWithChanges:Array.from(y.keys()),changesByVariant:Array.from(y.entries()).map(function(e){var t=i(e,2),r=t[0],n=t[1];return{variant:r,changeCount:n.length,changeTypes:a([],i(new Set(n.map(function(e){return e.type}))),!1)}})})):this.debug&&(0,o.logDebug)("[ABsmartly VariantExtractor] Experiment '".concat(f.name,"' has no DOM changes"))}}catch(t){e={error:t}}finally{try{d&&!d.done&&(t=g.return)&&t.call(g)}finally{if(e)throw e.error}}}}catch(e){(0,o.logDebug)("[ABsmartly] Error extracting DOM changes:",e)}return this.cachedAllChanges=h,h},e.prototype.extractAllVariantsForExperiment=function(e){var t,r=new Map;if((0,o.logDebug)("[DEBUG] Processing experiment:",e.name,"with",(null===(t=e.variants)||void 0===t?void 0:t.length)||0,"variants"),!e.variants)return(0,o.logDebug)("[DEBUG] No variants found for experiment:",e.name),r;for(var n=0;n<e.variants.length;n++){var i=e.variants[n];if(i){var a=null;if("variable"===this.dataSource){if(i.variables&&i.variables[this.dataFieldName])a=i.variables[this.dataFieldName],(0,o.logDebug)("[VariantExtractor DEBUG] ✓ Found DOM changes in variables[".concat(this.dataFieldName,"]:"),a);else if(i.config)try{var l="string"==typeof i.config?JSON.parse(i.config):i.config;l&&l[this.dataFieldName]?(a=l[this.dataFieldName],(0,o.logDebug)("[VariantExtractor DEBUG] ✓ Found DOM changes in config[".concat(this.dataFieldName,"]:"),a)):(0,o.logDebug)("[VariantExtractor DEBUG] ✗ No",this.dataFieldName,"field found in parsed config")}catch(e){(0,o.logDebug)("[VariantExtractor DEBUG] ✗ Failed to parse variant.config:",e,"Raw config:","string"==typeof i.config?i.config.substring(0,100):"")}if(a){var s=this.extractChangesFromData(a);s&&s.length>0&&r.set(n,s)}}}}return r},e.prototype.extractChangesFromData=function(e){if(!e)return null;if("string"==typeof e)try{e=JSON.parse(e)}catch(e){return(0,o.logDebug)("[ABsmartly] Failed to parse DOM changes JSON:",e),null}if(e&&"object"==typeof e&&!Array.isArray(e)&&"changes"in e){var t=e;return this.parseChanges(t.changes)}return this.parseChanges(e)},e.prototype.getExperimentChanges=function(e){var t=this.extractAllChanges().get(e);if(!t||0===t.size)return null;var r=this.context.peek(e);return null==r?(this.debug&&(0,o.logDebug)("[ABsmartly] No variant selected for ".concat(e)),null):t.get(r)||null},e.prototype.parseChanges=function(e){var t,r;if(!e)return null;if("string"==typeof e)try{e=JSON.parse(e)}catch(e){return(0,o.logDebug)("[ABsmartly] Failed to parse DOM changes JSON:",e),null}if(!Array.isArray(e))return this.debug&&(0,o.logDebug)("[ABsmartly] DOM changes data is not an array"),null;var i=[];try{for(var a=n(e),l=a.next();!l.done;l=a.next()){var s=l.value;this.isValidChange(s)?i.push(s):this.debug&&(0,o.logDebug)("[ABsmartly] Invalid DOM change:",s)}}catch(e){t={error:e}}finally{try{l&&!l.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}return i.length>0?i:null},e.prototype.isValidChange=function(e){if(!e||"object"!=typeof e)return!1;var t=e;if(void 0===t.selector||null===t.selector||!t.type)return!1;if(!["text","html","style","class","attribute","javascript","move","create","delete","styleRules"].includes(t.type))return!1;switch(t.type){case"class":if(!t.add&&!t.remove)return!1;if(t.add&&!Array.isArray(t.add))return!1;if(t.remove&&!Array.isArray(t.remove))return!1;break;case"move":if(!t.targetSelector)return!1;break;case"create":if(!t.element||!t.targetSelector)return!1;break;case"style":case"attribute":if(!t.value||"object"!=typeof t.value)return!1}return!0},e.prototype.getAllVariantChanges=function(e){var t=this.extractAllChanges().get(e);if(!t)return[];for(var r=Math.max.apply(Math,a([],i(t.keys()),!1)),n=[],o=0;o<=r;o++)n.push(t.get(o)||[]);return n},e.prototype.getExperiment=function(e){try{var t=this.context.data();return t&&t.experiments&&t.experiments.find(function(t){return t.name===e})||null}catch(t){return this.debug&&(0,o.logDebug)("[ABsmartly VariantExtractor] Failed to get experiment '".concat(e,"' - context may not be ready:"),t),null}},e.prototype.getAllVariantsData=function(e){var t=new Map;try{var r=this.context.data();if(!(null==r?void 0:r.experiments))return t;var n=r.experiments.find(function(t){return t.name===e});if(!(null==n?void 0:n.variants))return t;for(var i=0;i<n.variants.length;i++){var a=n.variants[i];if(a){var l=null;if("variable"===this.dataSource)if(a.variables&&a.variables[this.dataFieldName])l=a.variables[this.dataFieldName];else if(a.config)try{var s="string"==typeof a.config?JSON.parse(a.config):a.config;s&&s[this.dataFieldName]&&(l=s[this.dataFieldName])}catch(e){(0,o.logDebug)("[VariantExtractor] Failed to parse variant.config:",e)}if(l){if("string"==typeof l)try{l=JSON.parse(l)}catch(e){(0,o.logDebug)("[ABsmartly] Failed to parse DOM changes JSON:",e);continue}t.set(i,l)}}}}catch(e){(0,o.logDebug)("[ABsmartly] Error getting all variants data:",e)}return t},e.prototype.anyVariantMatchesURL=function(e,t){var r,a;void 0===t&&(t=window.location.href);var o=this.getAllVariantsData(e),s=!1;try{for(var c=n(o),u=c.next();!u.done;u=c.next()){var h=i(u.value,2)[1];if(h&&"object"==typeof h&&!Array.isArray(h)&&"urlFilter"in h){var p=h;if(p.urlFilter&&(s=!0,l.URLMatcher.matches(p.urlFilter,t)))return!0}}}catch(e){r={error:e}}finally{try{u&&!u.done&&(a=c.return)&&a.call(c)}finally{if(r)throw r.error}}return!s},e}();t.VariantExtractor=s},574:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},609:function(e,t){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},r.apply(this,arguments)},n=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,a=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}return o},i=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,i=0,a=t.length;i<a;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))};function a(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];if(t.DEBUG)if(2===e.length&&"string"==typeof e[0]&&"object"==typeof e[1]){var a=n(e,2),o=a[0],l=a[1];if(o.includes("Original state already stored"))return;if(o.includes("State store operation"))return;if(o.includes("Performance:")&&(null==l?void 0:l.duration)&&l.duration<5)return;if(o.includes("Message sent:")||o.includes("Message received:"))return;var s=(new Date).toISOString(),c="[ABsmartly Debug]";console.log("".concat(c," [").concat(s,"] ").concat(o),l)}else if(1===e.length&&"string"==typeof e[0]){if((o=e[0]).includes("Original state already stored"))return;if(o.includes("State store operation"))return;if(o.includes("Message sent:")||o.includes("Message received:"))return;s=(new Date).toISOString(),c="[ABsmartly Debug]";console.log("".concat(c," [").concat(s,"] ").concat(o))}else console.log.apply(console,i([],n(e),!1))}Object.defineProperty(t,"__esModule",{value:!0}),t.DEBUG=void 0,t.logDebug=a,t.logChangeApplication=function(e,r,n,i,o){if(t.DEBUG){a("".concat(o?"✓":"✗"," Applied ").concat(n," change to ").concat(i," element(s)"),{experimentName:e,selector:r,changeType:n,elementsCount:i,success:o})}},t.logChangeRemoval=function(e,r,n,i){if(t.DEBUG){a("Restored ".concat(i," element(s) to original state"),{experimentName:e,selector:r,changeType:n,elementsCount:i,action:"restore"})}},t.logExperimentSummary=function(e,r,n,i){if(t.DEBUG){a('Experiment "'.concat(e,'" summary'),{experimentName:e,totalChanges:r,successfulChanges:n,pendingChanges:i,successRate:r>0?"".concat(Math.round(n/r*100),"%"):"N/A"})}},t.logStateOperation=function(e,r,n,i){if(t.DEBUG){a("State ".concat(e," operation"),{operation:e,selector:r,changeType:n,experimentName:i})}},t.logVisibilityEvent=function(e,r,n){if(t.DEBUG){a(n?"Element became visible - experiment triggered":"Element visibility changed",{experimentName:e,selector:r.className||r.id||r.tagName,triggered:n,action:"visibility"})}},t.logMessage=function(e,r,n){if(t.DEBUG){a("Message ".concat(e,": ").concat(r),{direction:e,messageType:r,payload:n,bridge:"extension"})}},t.logPerformance=function(e,n,i){if(t.DEBUG){a("Performance: ".concat(e," took ").concat(n,"ms"),r({operation:e,duration:n,performance:!0},i))}},t.DEBUG=!1},693:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.StyleSheetManager=void 0;var n=r(609),i=function(){function e(e,t){void 0===t&&(t=!1),this.id=e,this.styleEl=null,this.rules=new Map,this.debug=t}return e.prototype.ensure=function(){if(!(this.styleEl&&document.head.contains(this.styleEl)||(this.styleEl=document.getElementById(this.id),this.styleEl))){var e=document.createElement("style");e.id=this.id,e.setAttribute("data-absmartly-styles","true"),document.head.appendChild(e),this.styleEl=e,this.debug&&(0,n.logDebug)("[ABsmartly] Created stylesheet: ".concat(this.id))}return this.styleEl},e.prototype.setRule=function(e,t){this.rules.set(e,t),this.render(),this.debug&&(0,n.logDebug)("[ABsmartly] Set CSS rule for ".concat(e))},e.prototype.deleteRule=function(e){this.rules.delete(e)&&(this.render(),this.debug&&(0,n.logDebug)("[ABsmartly] Deleted CSS rule for ".concat(e)))},e.prototype.hasRule=function(e){return this.rules.has(e)},e.prototype.clear=function(){var e=this.rules.size>0;this.rules.clear(),e&&(this.render(),this.debug&&(0,n.logDebug)("[ABsmartly] Cleared all CSS rules from ".concat(this.id)))},e.prototype.destroy=function(){this.clear(),this.styleEl&&document.head.contains(this.styleEl)&&(this.styleEl.remove(),this.styleEl=null,this.debug&&(0,n.logDebug)("[ABsmartly] Destroyed stylesheet: ".concat(this.id)))},e.prototype.render=function(){var e=this.ensure(),t=Array.from(this.rules.values()).join("\n\n");e.textContent=t},e.prototype.getRulesCount=function(){return this.rules.size},e.prototype.getCssText=function(){return Array.from(this.rules.values()).join("\n\n")},e}();t.StyleSheetManager=i},702:function(e,t,r){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},n.apply(this,arguments)},i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{s(n.next(e))}catch(e){a(e)}}function l(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,l)}s((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=l(0),o.throw=l(1),o.return=l(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(l){return function(s){return function(l){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(a=0)),a;)try{if(r=1,n&&(i=2&l[0]?n.return:l[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,l[1])).done)return i;switch(n=0,i&&(l=[2&l[0],i.value]),l[0]){case 0:case 1:i=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,n=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==l[0]&&2!==l[0])){a=0;continue}if(3===l[0]&&(!i||l[1]>i[0]&&l[1]<i[3])){a.label=l[1];break}if(6===l[0]&&a.label<i[1]){a.label=i[1],i=l;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(l);break}i[2]&&a.ops.pop(),a.trys.pop();continue}l=t.call(e,a)}catch(e){l=[6,e],n=0}finally{r=i=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}},o=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},l=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,a=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}return o};Object.defineProperty(t,"__esModule",{value:!0}),t.DOMChangesPluginLite=void 0;var s=r(964),c=r(356),u=r(693),h=r(713),p=r(609),g=r(973),d=function(){function e(e){var t,r,n,i,a,o,l,u,p,g;if(this.mutationObserver=null,this.exposedExperiments=new Set,this.eventListeners=new Map,this.styleManagers=new Map,this.initialized=!1,this.watchedElements=new WeakMap,this.persistenceObserver=null,this.reapplyingElements=new Set,this.reapplyLogThrottle=new Map,this.appliedStyleChanges=new Map,this.antiFlickerTimeout=null,this.antiFlickerStyleId="absmartly-antiflicker",this.config={context:e.context,autoApply:null===(t=e.autoApply)||void 0===t||t,spa:null===(r=e.spa)||void 0===r||r,visibilityTracking:null===(n=e.visibilityTracking)||void 0===n||n,extensionBridge:!1,dataSource:null!==(i=e.dataSource)&&void 0!==i?i:"variable",dataFieldName:null!==(a=e.dataFieldName)&&void 0!==a?a:"__dom_changes",debug:null!==(o=e.debug)&&void 0!==o&&o,hideUntilReady:null!==(l=e.hideUntilReady)&&void 0!==l&&l,hideTimeout:null!==(u=e.hideTimeout)&&void 0!==u?u:3e3,hideSelector:null!==(p=e.hideSelector)&&void 0!==p?p:"[data-absmartly-hide]",hideTransition:null!==(g=e.hideTransition)&&void 0!==g&&g},!this.config.context)throw new Error("[ABsmartly] Context is required");this.config.hideUntilReady&&this.hideContent(),this.domManipulator=new s.DOMManipulatorLite(this.config.debug,this),this.variantExtractor=new c.VariantExtractor(this.config.context,this.config.dataSource,this.config.dataFieldName,this.config.debug),this.exposureTracker=new h.ExposureTracker(this.config.context,this.config.debug)}return e.prototype.ready=function(){return i(this,void 0,void 0,function(){var t,r,n;return a(this,function(i){switch(i.label){case 0:if(this.initialized)return(0,p.logDebug)("Plugin already initialized"),[2];t=performance.now(),(0,p.logDebug)("Initializing ABsmartly DOM Changes Plugin Lite",{version:e.VERSION,config:{autoApply:this.config.autoApply,spa:this.config.spa,visibilityTracking:this.config.visibilityTracking,dataSource:this.config.dataSource,DEBUG:p.DEBUG}}),i.label=1;case 1:return i.trys.push([1,4,,5]),this.config.spa&&(this.setupMutationObserver(),this.setupURLChangeListener()),this.config.autoApply?[4,this.applyChanges()]:[3,3];case 2:i.sent(),i.label=3;case 3:return this.initialized=!0,this.registerWithContext(),this.emit("initialized"),r=performance.now()-t,(0,p.logPerformance)("Plugin initialization",r),(0,p.logDebug)("[ABsmartly] DOM plugin lite loaded successfully (v".concat(e.VERSION,")")),this.config.debug&&(0,p.logDebug)("[ABsmartly] DOM Changes Plugin Lite initialized with debug mode"),[3,5];case 4:throw n=i.sent(),(0,p.logDebug)("[ABsmartly] Failed to initialize plugin:",n),n;case 5:return[2]}})})},e.prototype.initialize=function(){return i(this,void 0,void 0,function(){return a(this,function(e){return[2,this.ready()]})})},e.prototype.setupMutationObserver=function(){var e=new MutationObserver(function(){});e.observe(document.body,{childList:!0,subtree:!0}),this.mutationObserver=e},e.prototype.setupURLChangeListener=function(){var e=this,t=function(){return i(e,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return e=window.location.href,(0,p.logDebug)("[ABsmartly] URL changed, re-evaluating experiments:",e),[4,this.removeAllChanges()];case 1:return t.sent(),[4,this.applyChanges()];case 2:return t.sent(),[2]}})})};window.addEventListener("popstate",t);var r=history.pushState,n=history.replaceState;history.pushState=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];r.apply(history,e),t()},history.replaceState=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];n.apply(history,e),t()},this.config.debug&&(0,p.logDebug)("[ABsmartly] URL change listener set up for SPA mode")},e.prototype.removeAllChanges=function(){return i(this,void 0,void 0,function(){return a(this,function(e){return this.exposedExperiments.clear(),this.styleManagers.clear(),this.appliedStyleChanges.clear(),this.variantExtractor.clearCache(),this.config.debug&&(0,p.logDebug)("[ABsmartly] All change tracking cleared for URL change"),[2]})})},e.prototype.applyChanges=function(e){return i(this,void 0,void 0,function(){var t,r,n,i,s,c,u,h,g,d,f,y,v,m,b,x,E,A,w,S,D,C,O,M,B,k,_,T,P,F,R,N,L,j,V,U,I,z,G,W,q,J,$,H,Z;return a(this,function(a){switch(a.label){case 0:t=performance.now(),r=window.location.href,(0,p.logDebug)("Starting to apply changes",{specificExperiment:e||"all",url:r,action:"apply_start"}),this.config.debug&&((0,p.logDebug)("[ABsmartly] === DOM Changes Application Starting ==="),(0,p.logDebug)("[ABsmartly] Target:",e||"all experiments"),(0,p.logDebug)("[ABsmartly] Current URL:",r),(0,p.logDebug)("[ABsmartly] Context ready:",!0)),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.config.context.ready()];case 2:return a.sent(),[3,4];case 3:return n=a.sent(),(0,p.logDebug)("[ABsmartly] Failed to wait for context ready:",n),[2];case 4:this.variantExtractor.clearCache(),i=this.getAllExperimentsData(),s=0,c=new Map,(0,p.logDebug)("[ABsmartly] Experiments to process:",Array.from(i.keys())),(0,p.logDebug)("[ABsmartly] Total experiments with changes:",i.size);try{for(u=o(i),h=u.next();!h.done;h=u.next())if(g=l(h.value,2),d=g[0],f=g[1],!e||d===e)if(y=this.config.context.peek(d),v=f.variantData,m=f.urlFilter,b=f.globalDefaults,this.variantExtractor.anyVariantMatchesURL(d,r))if(x=this.shouldApplyVisualChanges(v,m,r),E=this.extractChangesFromData(v,b),A=this.extractAllVariantChanges(d),w=A.some(function(e){return e&&e.length>0}),w){if(S={total:(null==E?void 0:E.length)||0,success:0,pending:0},this.config.debug&&(0,p.logDebug)("[ABsmartly] Processing experiment '".concat(d,"' (variant ").concat(y,"):"),{urlMatches:x,changeCount:(null==E?void 0:E.length)||0,userVariantHasChanges:((null==E?void 0:E.length)||0)>0,changes:(null==E?void 0:E.map(function(e){return{type:e.type,selector:e.selector,trigger:e.trigger_on_view?"viewport":"immediate"}}))||[]}),D=!1,C=!1,x&&E&&E.length>0)try{for(z=void 0,O=o(E),M=O.next();!M.done;M=O.next())if(j=M.value,this.domManipulator.applyChange(j,d))s++,S.success++,j.trigger_on_view?C=!0:D=!0;else if("create"!==j.type&&"styleRules"!==j.type)try{0===document.querySelectorAll(j.selector).length&&(this.config.spa||j.waitForElement)&&(S.pending++,j.trigger_on_view&&(C=!0))}catch(e){this.config.debug&&(0,p.logDebug)("[ABsmartly] Invalid selector: ".concat(j.selector),e)}}catch(e){z={error:e}}finally{try{M&&!M.done&&(G=O.return)&&G.call(O)}finally{if(z)throw z.error}}else if(E&&E.length>0){try{for(W=void 0,B=o(E),k=B.next();!k.done;k=B.next())(j=k.value).trigger_on_view?C=!0:D=!0}catch(e){W={error:e}}finally{try{k&&!k.done&&(q=B.return)&&q.call(B)}finally{if(W)throw W.error}}(0,p.logDebug)("[ABsmartly] Experiment '".concat(d,"' variant ").concat(y," doesn't match URL filter or has no changes, but setting up tracking for SRM prevention"))}if(_=C,T=D,!C||!D)try{for(J=void 0,P=o(A),F=P.next();!F.done;F=P.next()){if((R=F.value)&&R.length>0)try{for(H=void 0,N=o(R),L=N.next();!L.done&&((j=L.value).trigger_on_view?_=!0:T=!0,!_||!T);L=N.next());}catch(e){H={error:e}}finally{try{L&&!L.done&&(Z=N.return)&&Z.call(N)}finally{if(H)throw H.error}}if(_&&T)break}}catch(e){J={error:e}}finally{try{F&&!F.done&&($=P.return)&&$.call(P)}finally{if(J)throw J.error}}(_||T)&&this.exposureTracker.registerExperiment(d,y||0,E||[],A),c.set(d,S),(0,p.logExperimentSummary)(d,S.total,S.success,S.pending)}else this.config.debug&&(0,p.logDebug)("[ABsmartly] Skipping experiment '".concat(d,"' - no variants have changes"));else(0,p.logDebug)("[ABsmartly] Skipping experiment '".concat(d,"' - no variant matches URL: ").concat(r))}catch(e){U={error:e}}finally{try{h&&!h.done&&(I=u.return)&&I.call(u)}finally{if(U)throw U.error}}return V=performance.now()-t,(0,p.logPerformance)("Apply changes",V,{totalApplied:s,experiments:c.size}),this.config.debug&&((0,p.logDebug)("[ABsmartly] === DOM Changes Application Complete ==="),(0,p.logDebug)("[ABsmartly] Summary:",{totalChangesApplied:s,experimentsProcessed:c.size,duration:"".concat(V.toFixed(2),"ms"),experiments:Array.from(c.entries()).map(function(e){var t=l(e,2),r=t[0],n=t[1];return{name:r,total:n.total,success:n.success,pending:n.pending,pendingReason:n.pending>0?"Elements not found yet (SPA mode will retry)":void 0}})})),this.config.hideUntilReady&&this.showContent(),this.emit("changes-applied",{count:s,experimentName:e}),[2]}})})},e.prototype.getAllExperimentsData=function(){var e,t,r=new Map,n=this.variantExtractor.extractAllChanges();try{for(var i=o(n),a=i.next();!a.done;a=i.next()){var s=l(a.value,1)[0],c=this.config.context.peek(s);if(null!=c){var u=this.variantExtractor.getAllVariantsData(s).get(c);if(u){var h=null,p={};if(u&&"object"==typeof u&&!Array.isArray(u)&&"changes"in u){var g=u;h=g.urlFilter,p={waitForElement:g.waitForElement,persistStyle:g.persistStyle,important:g.important,observerRoot:g.observerRoot}}r.set(s,{variantData:u,urlFilter:h,globalDefaults:p})}}}}catch(t){e={error:t}}finally{try{a&&!a.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return r},e.prototype.extractChangesFromData=function(e,t){var r=null;return Array.isArray(e)?r=e:e&&"object"==typeof e&&"changes"in e&&(r=e.changes),r&&0!==r.length?r.map(function(e){var r,i,a,o;return n(n({},e),{waitForElement:null!==(r=e.waitForElement)&&void 0!==r?r:t.waitForElement,persistStyle:null!==(i=e.persistStyle)&&void 0!==i?i:t.persistStyle,important:null!==(a=e.important)&&void 0!==a?a:t.important,observerRoot:null!==(o=e.observerRoot)&&void 0!==o?o:t.observerRoot})}):null},e.prototype.extractAllVariantChanges=function(e){for(var t=this.variantExtractor.getAllVariantChanges(e),r=this.variantExtractor.getAllVariantsData(e),i=[],a=function(e){var a=t[e],o=r.get(e);if(!a||0===a.length)return i.push([]),"continue";var l={};if(o&&"object"==typeof o&&!Array.isArray(o)&&"changes"in o){var s=o;l={waitForElement:s.waitForElement,persistStyle:s.persistStyle,important:s.important,observerRoot:s.observerRoot}}var c=a.map(function(e){var t,r,i,a;return n(n({},e),{waitForElement:null!==(t=e.waitForElement)&&void 0!==t?t:l.waitForElement,persistStyle:null!==(r=e.persistStyle)&&void 0!==r?r:l.persistStyle,important:null!==(i=e.important)&&void 0!==i?i:l.important,observerRoot:null!==(a=e.observerRoot)&&void 0!==a?a:l.observerRoot})});i.push(c)},o=0;o<t.length;o++)a(o);return i},e.prototype.shouldApplyVisualChanges=function(e,t,r){return!!Array.isArray(e)||(!t||g.URLMatcher.matches(t,r))},e.prototype.hasChanges=function(e){return this.domManipulator.hasChanges(e)},e.prototype.applyChange=function(e,t){(0,p.logDebug)("Applying single change via public API",{experimentName:t,selector:e.selector,changeType:e.type});try{var r=this.domManipulator.applyChange(e,t);return r&&this.emit("change_applied",{experimentName:t,change:e}),r}catch(e){return this.config.debug&&(0,p.logDebug)("[ABsmartly] Error applying change:",e),!1}},e.prototype.on=function(e,t){var r=this.eventListeners.get(e)||[];r.push(t),this.eventListeners.set(e,r)},e.prototype.off=function(e,t){if(t){var r=this.eventListeners.get(e)||[],n=r.indexOf(t);-1!==n&&r.splice(n,1)}else this.eventListeners.delete(e)},e.prototype.emit=function(e,t){var r,n,i=this.eventListeners.get(e)||[];try{for(var a=o(i),l=a.next();!l.done;l=a.next()){var s=l.value;try{s(t)}catch(t){(0,p.logDebug)("[ABsmartly] Error in event listener for ".concat(e,":"),t)}}}catch(e){r={error:e}}finally{try{l&&!l.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}},e.prototype.getStyleManager=function(e){var t="absmartly-styles-".concat(e),r=this.styleManagers.get(e);return r||(r=new u.StyleSheetManager(t,this.config.debug),this.styleManagers.set(e,r)),r},e.prototype.buildCssRule=function(e,t,r){void 0===r&&(r=!0);var n=Object.entries(t).map(function(e){var t=l(e,2),n=t[0],i=t[1],a=n.replace(/([A-Z])/g,"-$1").toLowerCase(),o=r?" !important":"";return"  ".concat(a,": ").concat(i).concat(o,";")}).join("\n");return"".concat(e," {\n").concat(n,"\n}")},e.prototype.buildStateRules=function(e,t,r){void 0===r&&(r=!0);var n=[];return t.normal&&n.push(this.buildCssRule(e,t.normal,r)),t.hover&&n.push(this.buildCssRule("".concat(e,":hover"),t.hover,r)),t.active&&n.push(this.buildCssRule("".concat(e,":active"),t.active,r)),t.focus&&n.push(this.buildCssRule("".concat(e,":focus"),t.focus,r)),n.join("\n\n")},e.prototype.refreshExperiments=function(){this.config.debug&&(0,p.logDebug)("[ABsmartly] Refreshing experiments and clearing cache"),this.variantExtractor.clearCache(),this.config.autoApply&&this.applyChanges()},e.prototype.destroy=function(){this.domManipulator.destroy(),this.exposureTracker.destroy(),this.styleManagers.forEach(function(e){return e.destroy()}),this.styleManagers.clear(),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.persistenceObserver&&(this.persistenceObserver.disconnect(),this.persistenceObserver=null),null!==this.antiFlickerTimeout&&(clearTimeout(this.antiFlickerTimeout),this.antiFlickerTimeout=null);var e=document.getElementById(this.antiFlickerStyleId);e&&e.remove(),this.eventListeners.clear(),this.exposedExperiments.clear(),this.watchedElements=new WeakMap,this.appliedStyleChanges.clear(),this.reapplyingElements.clear(),this.reapplyLogThrottle.clear(),this.unregisterFromContext(),this.initialized=!1,this.config.debug&&(0,p.logDebug)("[ABsmartly] DOM Changes Plugin Lite destroyed")},e.prototype.registerWithContext=function(){this.config.context&&(this.config.context.__plugins||(this.config.context.__plugins={}),this.config.context.__plugins.domPlugin={name:"DOMChangesPluginLite",version:e.VERSION,initialized:!0,capabilities:["spa","visibility"],instance:this,timestamp:Date.now()},this.config.context.__domPlugin=this.config.context.__plugins.domPlugin,this.config.debug&&(0,p.logDebug)("[ABsmartly] DOMChangesPluginLite registered with context at __plugins.domPlugin"))},e.prototype.unregisterFromContext=function(){var e;this.config.context&&((null===(e=this.config.context.__plugins)||void 0===e?void 0:e.domPlugin)&&delete this.config.context.__plugins.domPlugin,this.config.context.__domPlugin&&delete this.config.context.__domPlugin,this.config.debug&&(0,p.logDebug)("[ABsmartly] DOMChangesPluginLite unregistered from context"))},e.prototype.hideContent=function(){var e=this,t=this.config.hideUntilReady;if(t&&!document.getElementById(this.antiFlickerStyleId)){var r=document.createElement("style");r.id=this.antiFlickerStyleId;var n=!1!==this.config.hideTransition,i="body"===t?"body":this.config.hideSelector||"[data-absmartly-hide]";r.textContent="\n        ".concat(i,n?" {\n          visibility: hidden !important;\n          opacity: 0 !important;\n        }\n      ":" {\n          visibility: hidden !important;\n        }\n      "),document.head.appendChild(r),this.antiFlickerTimeout=window.setTimeout(function(){e.config.debug&&(0,p.logDebug)("[ABsmartly] Anti-flicker timeout reached (".concat(e.config.hideTimeout,"ms), showing content")),e.showContent()},this.config.hideTimeout),this.config.debug&&(0,p.logDebug)("[ABsmartly] Anti-flicker enabled (mode: ".concat(t,", transition: ").concat(n?this.config.hideTransition:"none",", timeout: ").concat(this.config.hideTimeout,"ms)"))}},e.prototype.showContent=function(){var e=this;null!==this.antiFlickerTimeout&&(clearTimeout(this.antiFlickerTimeout),this.antiFlickerTimeout=null);var t=document.getElementById(this.antiFlickerStyleId);if(t)if(!1!==this.config.hideTransition){var r="body"===this.config.hideUntilReady?"body":this.config.hideSelector||"[data-absmartly-hide]";t.textContent="\n        ".concat(r," {\n          opacity: 0 !important;\n          transition: opacity ").concat(this.config.hideTransition," !important;\n        }\n      "),t.offsetHeight,t.textContent="\n        ".concat(r," {\n          opacity: 1 !important;\n          transition: opacity ").concat(this.config.hideTransition," !important;\n        }\n      ");var n=1e3*parseFloat(this.config.hideTransition);setTimeout(function(){t.remove(),e.config.debug&&(0,p.logDebug)("[ABsmartly] Anti-flicker fade-in complete, style removed")},n),this.config.debug&&(0,p.logDebug)("[ABsmartly] Anti-flicker fading in with transition: ".concat(this.config.hideTransition))}else t.remove(),this.config.debug&&(0,p.logDebug)("[ABsmartly] Anti-flicker removed, content now visible")},e.prototype.watchElement=function(e,t,r){var n=this.watchedElements.get(e);n||(n=new Set,this.watchedElements.set(e,n)),n.add(t),this.appliedStyleChanges.has(t)||this.appliedStyleChanges.set(t,[]);var i=this.appliedStyleChanges.get(t);!i.includes(r)&&(i.push(r),this.config.debug&&(0,p.logDebug)("[ABsmartly] Watching element for style persistence",{experimentName:t,selector:r.selector,element:e.tagName})),this.persistenceObserver||this.setupPersistenceObserver()},e.prototype.unwatchElement=function(e,t){var r=this.watchedElements.get(e);r&&(r.delete(t),0===r.size&&this.watchedElements.delete(e))},e.prototype.setupPersistenceObserver=function(){var e=this;this.persistenceObserver||(this.persistenceObserver=new MutationObserver(function(t){t.forEach(function(t){var r=t.target;if(!e.reapplyingElements.has(r)){var n=e.watchedElements.get(r);if(n){if(e.config.debug){var i="mutation:".concat(r.tagName,":").concat(r.getAttribute("name")||r.className),a=Date.now();a-(e.reapplyLogThrottle.get(i)||0)>5e3&&((0,p.logDebug)("[ABsmartly] Style mutation detected on watched element",{element:r.tagName,selector:r.getAttribute("name")||r.className,oldValue:t.oldValue}),e.reapplyLogThrottle.set(i,a))}n.forEach(function(t){var n=e.appliedStyleChanges.get(t);n&&n.forEach(function(n){var i,a;if("style"===n.type&&r.matches(n.selector))if(e.checkStyleOverwritten(r,n.value)){e.reapplyingElements.add(r),e.domManipulator.applyChange(n,t);var s="".concat(t,"-").concat(n.selector),c=Date.now(),u=e.reapplyLogThrottle.get(s)||0;if(e.config.debug&&c-u>5e3&&((0,p.logDebug)("Reapplied style after mutation (React/framework conflict detected)",{experimentName:t,selector:n.selector,note:"This happens when the page framework (React/Vue/etc) fights with DOM changes"}),e.reapplyLogThrottle.set(s,c),e.reapplyLogThrottle.size>100)){var h=c-6e4;try{for(var g=o(e.reapplyLogThrottle.entries()),d=g.next();!d.done;d=g.next()){var f=l(d.value,2),y=f[0];f[1]<h&&e.reapplyLogThrottle.delete(y)}}catch(e){i={error:e}}finally{try{d&&!d.done&&(a=g.return)&&a.call(g)}finally{if(i)throw i.error}}}setTimeout(function(){e.reapplyingElements.delete(r)},0)}else e.config.debug&&(0,p.logDebug)("[ABsmartly] Style mutation detected but no reapply needed",{experimentName:t,selector:n.selector})})})}}})}),this.persistenceObserver.observe(document.body,{attributes:!0,attributeFilter:["style"],subtree:!0,attributeOldValue:!0}),this.config.debug&&(0,p.logDebug)("[ABsmartly] Style persistence observer setup complete"))},e.prototype.checkStyleOverwritten=function(e,t){var r,n;try{for(var i=o(Object.entries(t)),a=i.next();!a.done;a=i.next()){var s=l(a.value,2),c=s[0],u=s[1],h=c.replace(/([A-Z])/g,"-$1").toLowerCase(),p=e.style.getPropertyValue(h),g=e.style.getPropertyPriority(h);if(p!==u||u.includes("!important")&&!g)return!0}}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return!1},e.VERSION="1.0.0-lite",e}();t.DOMChangesPluginLite=d},713:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{s(n.next(e))}catch(e){a(e)}}function l(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,l)}s((n=n.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){var r,n,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=l(0),o.throw=l(1),o.return=l(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(l){return function(s){return function(l){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(a=0)),a;)try{if(r=1,n&&(i=2&l[0]?n.return:l[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,l[1])).done)return i;switch(n=0,i&&(l=[2&l[0],i.value]),l[0]){case 0:case 1:i=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,n=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==l[0]&&2!==l[0])){a=0;continue}if(3===l[0]&&(!i||l[1]>i[0]&&l[1]<i[3])){a.label=l[1];break}if(6===l[0]&&a.label<i[1]){a.label=i[1],i=l;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(l);break}i[2]&&a.ops.pop(),a.trys.pop();continue}l=t.call(e,a)}catch(e){l=[6,e],n=0}finally{r=i=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}},a=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,a=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}return o},o=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,i=0,a=t.length;i<a;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.ExposureTracker=void 0;var l=r(609),s=function(){function e(e,t){void 0===t&&(t=!1),this.context=e,this.experiments=new Map,this.trackedElements=new Map,this.mutationObserver=null,this.placeholders=new Map,this.debug=t,this.setupIntersectionObserver()}return e.prototype.registerExperiment=function(e,t,r,n){var i=this;this.debug&&(0,l.logDebug)("[ABsmartly] Registering experiment ".concat(e," for exposure tracking"));var s=new Set,c=new Set,u=new Map;n.forEach(function(e){e.forEach(function(e){e.trigger_on_view&&("move"===e.type?(u.has(e.selector)||u.set(e.selector,new Set),e.targetSelector&&u.get(e.selector).add(e.targetSelector)):s.add(e.selector))})}),u.forEach(function(r,a){var o=[];n.forEach(function(e,t){var r=e.find(function(e){return"move"===e.type&&e.selector===a&&e.trigger_on_view});(null==r?void 0:r.targetSelector)&&o.push({targetSelector:r.targetSelector,position:r.position||"lastChild",variantIndex:t})});var l=o.findIndex(function(e){return e.variantIndex===t});l>=0?(s.add(a),o.forEach(function(t,r){r!==l&&i.createContainerPlaceholder(e,a,t.targetSelector,t.position)})):(s.add(a),o.forEach(function(t){i.createContainerPlaceholder(e,a,t.targetSelector,t.position)}))});var h=!1,p=!1;n.forEach(function(e){e.forEach(function(e){e.trigger_on_view?p=!0:h=!0})});var g={experimentName:e,variant:t,changes:r,allPossibleSelectors:new Set(o(o([],a(s),!1),a(c),!1)),triggered:!1,hasImmediateTrigger:h,hasViewportTrigger:p};this.experiments.set(e,g),this.debug&&(0,l.logDebug)("[ABsmartly] Experiment ".concat(e," will track selectors:"),Array.from(g.allPossibleSelectors)),h?this.triggerExposure(e).catch(function(t){(0,l.logDebug)("[ABsmartly] Failed to trigger exposure for ".concat(e,":"),t)}):p&&this.observeSelectors(e,g.allPossibleSelectors)},e.prototype.createContainerPlaceholder=function(e,t,r,n){var i,a;void 0===n&&(n="lastChild");var o=document.querySelector(r);if(o){var s="".concat(e,"-").concat(t,"-").concat(r,"-").concat(n);if(!this.placeholders.has(s)){var c=document.createElement("span");switch(c.style.cssText="\n      display: inline-block;\n      width: 1px;\n      height: 1px;\n      position: relative;\n      left: -1px;\n      visibility: hidden;\n      pointer-events: none;\n      font-size: 0;\n      line-height: 0;\n      overflow: hidden;\n    ",c.setAttribute("data-absmartly-placeholder","true"),c.setAttribute("data-absmartly-original-selector",t),c.setAttribute("data-absmartly-experiment",e),c.setAttribute("aria-hidden","true"),n){case"firstChild":o.insertBefore(c,o.firstChild);break;case"lastChild":default:o.appendChild(c);break;case"before":null===(i=o.parentElement)||void 0===i||i.insertBefore(c,o);break;case"after":null===(a=o.parentElement)||void 0===a||a.insertBefore(c,o.nextSibling)}this.placeholders.set(s,c),this.trackElement(c,e),this.debug&&(0,l.logDebug)("[ABsmartly] Created placeholder for ".concat(t," at ").concat(r," (").concat(n,")"))}}},e.prototype.getOriginalParentForMove=function(e){var t=document.querySelector(e);return(null==t?void 0:t.parentElement)?this.getStableParentSelector(t.parentElement):null},e.prototype.getStableParentSelector=function(e){if(e.id)return"#".concat(e.id);if(e.className){var t=e.className.split(" ").filter(function(e){return e&&!e.startsWith("absmartly")});if(t.length>0)return".".concat(t[0])}var r=e.parentElement;if(r){var n=Array.from(r.children).indexOf(e);return"".concat(e.tagName.toLowerCase(),":nth-child(").concat(n+1,")")}return null},e.prototype.observeSelectors=function(e,t){var r=this;t.forEach(function(t){var n=document.querySelectorAll(t);n.length>0?n.forEach(function(t){r.trackElement(t,e)}):r.watchForSelector(t,e)})},e.prototype.trackElement=function(e,t){this.trackedElements.has(e)?this.trackedElements.get(e).experiments.add(t):(this.trackedElements.set(e,{element:e,experiments:new Set([t]),isPlaceholder:e.hasAttribute("data-absmartly-placeholder")}),this.observer.observe(e))},e.prototype.watchForSelector=function(e,t){this.mutationObserver||this.setupMutationObserver()},e.prototype.setupIntersectionObserver=function(){var e=this;this.observer=new IntersectionObserver(function(t){t.forEach(function(t){t.isIntersecting&&e.handleElementVisible(t.target)})},{threshold:.01,rootMargin:"0px"})},e.prototype.setupMutationObserver=function(){var e=this;this.mutationObserver=new MutationObserver(function(t){t.forEach(function(t){t.addedNodes.forEach(function(t){t instanceof Element&&e.checkNewElement(t)})})}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0})},e.prototype.checkNewElement=function(e){var t=this;this.experiments.forEach(function(r,n){r.allPossibleSelectors.forEach(function(r){e.matches(r)&&t.trackElement(e,n),e.querySelectorAll(r).forEach(function(e){t.trackElement(e,n)})})})},e.prototype.handleElementVisible=function(e){var t=this,r=this.trackedElements.get(e);r&&r.experiments.forEach(function(n){var i=t.experiments.get(n);if(i&&!i.triggered&&(t.triggerExposure(n).catch(function(e){(0,l.logDebug)("[ABsmartly] Failed to trigger exposure for ".concat(n,":"),e)}),t.debug)){var a=r.isPlaceholder?e.getAttribute("data-absmartly-original-selector"):t.getElementSelector(e);(0,l.logDebug)("[ABsmartly] Triggering exposure for ".concat(n," via ").concat(a))}})},e.prototype.triggerExposure=function(e){return n(this,void 0,void 0,function(){var t;return i(this,function(r){switch(r.label){case 0:return!(t=this.experiments.get(e))||t.triggered?[2]:[4,this.context.ready()];case 1:return r.sent(),this.context.treatment(e),t.triggered=!0,this.debug&&(0,l.logDebug)("[ABsmartly] Exposure triggered for experiment: ".concat(e)),this.cleanupExperiment(e),[2]}})})},e.prototype.cleanupExperiment=function(e){var t=this;this.trackedElements.forEach(function(r,n){r.experiments.delete(e),0===r.experiments.size&&(t.observer.unobserve(n),t.trackedElements.delete(n))}),this.placeholders.forEach(function(r,n){n.startsWith("".concat(e,"-"))&&(r.remove(),t.placeholders.delete(n))});var r=this.experiments.get(e);r&&r.allPossibleSelectors.clear(),0===this.experiments.size&&this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null)},e.prototype.getElementSelector=function(e){if(e.id)return"#".concat(e.id);if(e.className){var t=e.className.split(" ").filter(function(e){return e&&!e.startsWith("absmartly")});if(t.length>0)return".".concat(t.join("."))}return e.tagName.toLowerCase()},e.prototype.needsViewportTracking=function(e){var t,r=this.experiments.get(e);return null!==(t=null==r?void 0:r.hasViewportTrigger)&&void 0!==t&&t},e.prototype.isTriggered=function(e){var t,r=this.experiments.get(e);return null!==(t=null==r?void 0:r.triggered)&&void 0!==t&&t},e.prototype.destroy=function(){this.observer.disconnect(),this.mutationObserver&&this.mutationObserver.disconnect(),this.placeholders.forEach(function(e){return e.remove()}),this.experiments.clear(),this.trackedElements.clear(),this.placeholders.clear(),this.debug&&(0,l.logDebug)("[ABsmartly] ExposureTracker destroyed")},e}();t.ExposureTracker=s},964:function(e,t,r){var n=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},i=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,a=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}return o},a=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,i=0,a=t.length;i<a;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.DOMManipulatorLite=void 0;var o=r(609),l=r(214),s=function(){function e(e,t){void 0===e&&(e=!1);var r=this;this.appliedChanges=new Map,this.debug=e,this.plugin=t,this.pendingManager=new l.PendingChangeManager(function(e,t,n){return n?r.applyChangeToSpecificElement(e,t,n):r.applyChange(e,t)},e)}return e.prototype.applyChange=function(e,t){var r,n=this;if(!e.enabled&&void 0!==e.enabled)return(0,o.logDebug)("Skipping disabled change for experiment: ".concat(t),{experimentName:t,selector:e.selector,changeType:e.type}),!1;try{if("styleRules"===e.type)return this.applyStyleRules(e,t);if("create"===e.type){if(e.element&&e.targetSelector)if(this.createElement(e,t))return this.trackAppliedChange(t,e),(0,o.logChangeApplication)(t,e.targetSelector,e.type,1,!0),!0;return!1}var i=document.querySelectorAll(e.selector),a=[];if(0===i.length)return e.waitForElement||(null===(r=this.plugin.config)||void 0===r?void 0:r.spa)?(this.debug&&(0,o.logDebug)("[ABsmartly] Element not found, adding to pending: ".concat(e.selector)),this.pendingManager.addPending({change:e,experimentName:t,observerRoot:e.observerRoot}),!0):(this.debug&&(0,o.logDebug)("[ABsmartly] No elements found for selector: ".concat(e.selector)),(0,o.logDebug)("No elements found for selector",{experimentName:t,selector:e.selector,changeType:e.type}),!1);if(i.forEach(function(r){var i;if(n.applyChangeToElement(r,e),"javascript"===e.type){if(e.value)try{new Function("element",String(e.value))(r),a.push(r)}catch(e){(0,o.logDebug)("[ABsmartly] JavaScript execution error:",e)}}else if("move"===e.type){var l=e.targetSelector||(e.value&&"object"==typeof e.value?e.value.targetSelector:null),s=e.position||(e.value&&"object"==typeof e.value?e.value.position:null);if(l){var c=document.querySelector(l);c?(n.moveElement(r,c,s),a.push(r)):n.debug&&(0,o.logDebug)("[ABsmartly] Move target not found: ".concat(l))}}else a.push(r);"style"===e.type&&(e.persistStyle||(null===(i=n.plugin.config)||void 0===i?void 0:i.spa))&&n.plugin.watchElement(r,t,e)}),a.length>0){this.trackAppliedChange(t,e),e.waitForElement&&this.pendingManager.removePending(e.selector,t,e.observerRoot);var l=a.some(function(e){var t;return null===(t=n.plugin.reapplyingElements)||void 0===t?void 0:t.has(e)});return l||(0,o.logChangeApplication)(t,e.selector,e.type,a.length,!0),!0}return(0,o.logChangeApplication)(t,e.selector,e.type,0,!1),!1}catch(r){return this.debug&&(0,o.logDebug)("[ABsmartly] Error applying DOM change:",r,e),(0,o.logDebug)("Error applying DOM change",{experimentName:t,selector:e.selector,changeType:e.type,error:r instanceof Error?r.message:"Unknown error"}),!1}},e.prototype.moveElement=function(e,t,r){var n,i,a;switch(r){case"before":null===(n=t.parentElement)||void 0===n||n.insertBefore(e,t);break;case"after":t.nextSibling?null===(i=t.parentElement)||void 0===i||i.insertBefore(e,t.nextSibling):null===(a=t.parentElement)||void 0===a||a.appendChild(e);break;case"firstChild":t.firstChild?t.insertBefore(e,t.firstChild):t.appendChild(e);break;default:t.appendChild(e)}},e.prototype.createElement=function(e,t){var r,i;if(!e.element||!e.targetSelector)return null;var a=document.querySelector(e.targetSelector);if(!a)return this.debug&&(0,o.logDebug)("[ABsmartly] Create target not found: ".concat(e.targetSelector)),null;var l=document.createElement("div");l.innerHTML=e.element;var s=Array.from(l.children);if(0===s.length)return null;try{for(var c=n(s),u=c.next();!u.done;u=c.next()){var h=u.value;this.moveElement(h,a,e.position)}}catch(e){r={error:e}}finally{try{u&&!u.done&&(i=c.return)&&i.call(c)}finally{if(r)throw r.error}}return s[0]},e.prototype.applyStyleRules=function(e,t){try{var r=this.plugin.getStyleManager(t),n="".concat(e.selector,"::states"),i=void 0;if("string"==typeof e.value&&e.value.trim())i=e.value;else{if(!e.states)return!1;i=this.plugin.buildStateRules(e.selector,e.states,!1!==e.important)}return r.setRule(n,i),this.debug&&((0,o.logDebug)("[ABsmartly] Applied style rule: ".concat(n)),(0,o.logDebug)("[ABsmartly] CSS: ".concat(i))),this.trackAppliedChange(t,e),(0,o.logChangeApplication)(t,e.selector,"styleRules",1,!0),!0}catch(e){return this.debug&&(0,o.logDebug)("[ABsmartly] Error applying style rules:",e),!1}},e.prototype.applyChangeToElement=function(e,t){var r,n;switch(t.type){case"text":void 0!==t.value&&(e.textContent=String(t.value));break;case"html":void 0!==t.value&&(e.innerHTML=String(t.value));break;case"style":t.value&&"object"==typeof t.value&&Object.entries(t.value).forEach(function(t){var r=i(t,2),n=r[0],a=r[1],o=n.replace(/([A-Z])/g,"-$1").toLowerCase();e.style.setProperty(o,String(a))});break;case"class":t.add&&Array.isArray(t.add)&&(r=e.classList).add.apply(r,a([],i(t.add),!1)),t.remove&&Array.isArray(t.remove)&&(n=e.classList).remove.apply(n,a([],i(t.remove),!1));break;case"attribute":t.value&&"object"==typeof t.value&&Object.entries(t.value).forEach(function(t){var r=i(t,2),n=r[0],a=r[1];null==a?e.removeAttribute(n):e.setAttribute(n,String(a))});break;case"move":if(t.value&&"object"==typeof t.value){var l=t.value,s=document.querySelector(l.targetSelector);s?this.moveElement(e,s,l.position):this.debug&&(0,o.logDebug)("[ABsmartly] Move target not found: ".concat(l.targetSelector))}break;case"delete":e.remove()}},e.prototype.applyChangeToSpecificElement=function(e,t,r){var n;try{if(this.applyChangeToElement(r,e),"javascript"===e.type&&e.value)try{new Function("element",String(e.value))(r)}catch(e){return(0,o.logDebug)("[ABsmartly] JavaScript execution error:",e),!1}else if("move"===e.type){var i=e.targetSelector||(e.value&&"object"==typeof e.value?e.value.targetSelector:null),a=e.position||(e.value&&"object"==typeof e.value?e.value.position:null);if(i){var l=document.querySelector(i);if(!l)return!1;this.moveElement(r,l,a)}}return"style"===e.type&&(e.persistStyle||(null===(n=this.plugin.config)||void 0===n?void 0:n.spa))&&this.plugin.watchElement(r,t,e),!0}catch(e){return this.debug&&(0,o.logDebug)("[ABsmartly] Error applying change to specific element:",e),!1}},e.prototype.trackAppliedChange=function(e,t){var r=this.appliedChanges.get(e);r||(r=new Set,this.appliedChanges.set(e,r));var n="".concat(t.selector,"-").concat(t.type);r.add(n)},e.prototype.hasChanges=function(e){return this.appliedChanges.has(e)},e.prototype.clearTracking=function(e){e?this.appliedChanges.delete(e):this.appliedChanges.clear()},e.prototype.removeAllPending=function(e){this.pendingManager.removeAllPending(e)},e.prototype.destroy=function(){this.pendingManager.destroy(),this.appliedChanges.clear()},e}();t.DOMManipulatorLite=s},973:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.URLMatcher=void 0;var r=function(){function e(){}return e.matches=function(e,t){void 0===t&&(t=window.location.href);var r=this.normalizeFilter(e),n=this.extractURLPart(t,r.matchType);return(!r.exclude||!this.matchesPatterns(r.exclude,n,r.mode))&&(!r.include||0!==r.include.length&&this.matchesPatterns(r.include,n,r.mode))},e.extractURLPart=function(e,t){void 0===t&&(t="path");try{var r=new URL(e);switch(t){case"full-url":return r.href;case"path":default:return r.pathname+r.hash;case"domain":return r.hostname;case"query":return r.search;case"hash":return r.hash}}catch(t){return console.error("[ABsmartly] Failed to parse URL: ".concat(e),t),e}},e.matchesPatterns=function(e,t,r){var n=this;return void 0===r&&(r="simple"),e.some(function(e){if("regex"===r)try{return new RegExp(e).test(t)}catch(t){return console.error("[ABsmartly] Invalid regex pattern: ".concat(e),t),!1}return n.matchSimplePattern(e,t)})},e.matchSimplePattern=function(e,t){var r=e.replace(/[.+^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*").replace(/\?/g,".");try{return new RegExp("^".concat(r,"$")).test(t)}catch(t){return console.error("[ABsmartly] Invalid pattern: ".concat(e),t),!1}},e.normalizeFilter=function(e){return"string"==typeof e?{include:[e],exclude:[],mode:"simple",matchType:"path"}:Array.isArray(e)?{include:e.length>0?e:void 0,exclude:[],mode:"simple",matchType:"path"}:{include:e.include,exclude:e.exclude||[],mode:e.mode||"simple",matchType:e.matchType||"path"}},e}();t.URLMatcher=r}},t={};var r=function r(n){var i=t[n];if(void 0!==i)return i.exports;var a=t[n]={exports:{}};return e[n].call(a.exports,a,a.exports,r),a.exports}(254);return r})());
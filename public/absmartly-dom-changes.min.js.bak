!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ABSmartlyDOMChanges=t():e.ABSmartlyDOMChanges=t()}(this,()=>(()=>{"use strict";var e={156:function(e,t,r){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.DOMChangesPlugin=void 0;var a=r(530);Object.defineProperty(t,"DOMChangesPlugin",{enumerable:!0,get:function(){return a.DOMChangesPlugin}}),i(r(574),t),t.default=a.DOMChangesPlugin},252:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageBridge=void 0;var r=function(){function e(e){void 0===e&&(e=!1),this.handlers=new Map,this.isReady=!1,this.debug=e,this.setupListener()}return e.prototype.setupListener=function(){var e=this;window.addEventListener("message",function(t){if(t.source===window){var r=t.data;if(r&&"object"==typeof r&&"absmartly-extension"===r.source){e.debug&&console.log("[ABsmartly] Received message:",r.type,r.payload);var n=e.handlers.get(r.type);if(n)try{n(r.payload||{})}catch(t){console.error("[ABsmartly] Error handling message:",t),e.sendError(t instanceof Error?t.message:"Unknown error")}}}}),this.isReady=!0},e.prototype.on=function(e,t){this.handlers.set(e,t)},e.prototype.off=function(e){this.handlers.delete(e)},e.prototype.sendMessage=function(e,t){var r={source:"absmartly-sdk",type:e,payload:t};this.debug&&console.log("[ABsmartly] Sending message:",e,t),window.postMessage(r,"*")},e.prototype.notifyReady=function(e,t){this.sendMessage("PLUGIN_READY",{version:e,capabilities:t})},e.prototype.requestInjectionCode=function(){this.sendMessage("REQUEST_INJECTION_CODE")},e.prototype.requestOverrides=function(){this.sendMessage("REQUEST_OVERRIDES")},e.prototype.notifyChangesApplied=function(e,t){this.sendMessage("CHANGES_APPLIED",{count:e,experimentName:t})},e.prototype.notifyChangesRemoved=function(e){this.sendMessage("CHANGES_REMOVED",{experimentName:e})},e.prototype.notifyPreviewStarted=function(e){this.sendMessage("PREVIEW_STARTED",{changeCount:e})},e.prototype.notifyPreviewEnded=function(){this.sendMessage("PREVIEW_ENDED")},e.prototype.sendExperimentData=function(e){this.sendMessage("EXPERIMENT_DATA",{experiments:e})},e.prototype.sendOverridesData=function(e){this.sendMessage("OVERRIDES_DATA",{overrides:e})},e.prototype.notifyExperimentTriggered=function(e,t){this.sendMessage("EXPERIMENT_TRIGGERED",{experimentName:e,variant:t})},e.prototype.sendError=function(e){this.sendMessage("ERROR",{error:e})},e.prototype.notifyCodeInjected=function(e){this.sendMessage("CODE_INJECTED",{locations:e})},e.prototype.destroy=function(){this.handlers.clear(),this.isReady=!1},e.prototype.getIsReady=function(){return this.isReady},e}();t.MessageBridge=r},356:function(e,t){var r=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.VariantExtractor=void 0;var n=function(){function e(e,t,r,n){void 0===t&&(t="variable"),void 0===r&&(r="__dom_changes"),void 0===n&&(n=!1),this.context=e,this.dataSource=t,this.dataFieldName=r,this.debug=n}return e.prototype.extractAllChanges=function(){var e,t,n=new Map;try{var i=this.context.data();if(!i||!i.experiments)return this.debug&&console.log("[ABsmartly] No experiments found in context data"),n;try{for(var a=r(i.experiments),o=a.next();!o.done;o=a.next()){var s=o.value,l=this.extractExperimentChanges(s);l&&l.length>0&&n.set(s.name,l)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}}catch(e){console.error("[ABsmartly] Error extracting DOM changes:",e)}return n},e.prototype.extractExperimentChanges=function(e){try{return"variable"===this.dataSource?this.extractFromVariables(e):this.extractFromCustomField(e.name)}catch(t){return this.debug&&console.error("[ABsmartly] Error extracting changes for ".concat(e.name,":"),t),null}},e.prototype.extractFromVariables=function(e){var t,r=this.context.peek(e.name);if(null==r)return this.debug&&console.log("[ABsmartly] No variant selected for ".concat(e.name)),null;var n=null===(t=e.variants)||void 0===t?void 0:t[r];if(!n||!n.variables)return this.debug&&console.log("[ABsmartly] No variables found for variant ".concat(r," of ").concat(e.name)),null;var i=n.variables[this.dataFieldName];return i?this.parseChanges(i):(this.debug&&console.log("[ABsmartly] No ".concat(this.dataFieldName," found in ").concat(e.name)),null)},e.prototype.extractFromCustomField=function(e){var t=this.context.customFieldValue(e,this.dataFieldName);return t?this.parseChanges(t):(this.debug&&console.log("[ABsmartly] No custom field ".concat(this.dataFieldName," found for ").concat(e)),null)},e.prototype.parseChanges=function(e){var t,n;if(!e)return null;if("string"==typeof e)try{e=JSON.parse(e)}catch(e){return console.error("[ABsmartly] Failed to parse DOM changes JSON:",e),null}if(!Array.isArray(e))return this.debug&&console.warn("[ABsmartly] DOM changes data is not an array"),null;var i=[];try{for(var a=r(e),o=a.next();!o.done;o=a.next()){var s=o.value;this.isValidChange(s)?i.push(s):this.debug&&console.warn("[ABsmartly] Invalid DOM change:",s)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}return i.length>0?i:null},e.prototype.isValidChange=function(e){if(!e||"object"!=typeof e)return!1;var t=e;if(!t.selector||!t.type)return!1;if(!["text","html","style","class","attribute","javascript","move","create"].includes(t.type))return!1;switch(t.type){case"class":if(!t.add&&!t.remove)return!1;if(t.add&&!Array.isArray(t.add))return!1;if(t.remove&&!Array.isArray(t.remove))return!1;break;case"move":if(!t.targetSelector)return!1;break;case"create":if(!t.element||!t.targetSelector)return!1;break;case"style":case"attribute":if(!t.value||"object"!=typeof t.value)return!1}return!0},e.prototype.getExperimentChanges=function(e){var t=this.context.data();if(!t||!t.experiments)return null;var r=t.experiments.find(function(t){return t.name===e});return r?this.extractExperimentChanges(r):null},e}();t.VariantExtractor=n},530:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{l(n.next(e))}catch(e){a(e)}}function s(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}l((n=n.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){var r,n,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(l){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(a=0)),a;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((i=(i=a.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){a.label=s[1];break}if(6===s[0]&&a.label<i[1]){a.label=i[1],i=s;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(s);break}i[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}},a=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},o=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,a=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}return o};Object.defineProperty(t,"__esModule",{value:!0}),t.DOMChangesPlugin=void 0;var s=r(944),l=r(624),c=r(252),d=r(937),u=r(356),h=function(){function e(e){var t,r,n,i,a,o,c,h;if(this.messageBridge=null,this.mutationObserver=null,this.visibilityObserver=null,this.exposedExperiments=new Set,this.eventListeners=new Map,this.initialized=!1,this.config={context:e.context,autoApply:null===(t=e.autoApply)||void 0===t||t,spa:null===(r=e.spa)||void 0===r||r,visibilityTracking:null===(n=e.visibilityTracking)||void 0===n||n,extensionBridge:null===(i=e.extensionBridge)||void 0===i||i,dataSource:null!==(a=e.dataSource)&&void 0!==a?a:"variable",dataFieldName:null!==(o=e.dataFieldName)&&void 0!==o?o:"__dom_changes",overrideCookieName:null!==(c=e.overrideCookieName)&&void 0!==c?c:"absmartly_overrides",debug:null!==(h=e.debug)&&void 0!==h&&h},!this.config.context)throw new Error("[ABsmartly] Context is required");this.stateManager=new s.StateManager,this.domManipulator=new l.DOMManipulator(this.stateManager,this.config.debug),this.codeInjector=new d.CodeInjector(this.config.debug),this.variantExtractor=new u.VariantExtractor(this.config.context,this.config.dataSource,this.config.dataFieldName,this.config.debug)}return e.prototype.initialize=function(){return n(this,void 0,void 0,function(){var e;return i(this,function(t){switch(t.label){case 0:if(this.initialized)return[2];t.label=1;case 1:return t.trys.push([1,4,,5]),this.config.overrideCookieName&&this.applyOverridesToContext(),this.config.extensionBridge&&this.setupMessageBridge(),this.config.spa&&this.setupMutationObserver(),this.config.visibilityTracking&&this.setupVisibilityObserver(),this.config.autoApply?[4,this.applyChanges()]:[3,3];case 2:t.sent(),t.label=3;case 3:return this.config.extensionBridge&&this.messageBridge&&this.messageBridge.requestInjectionCode(),this.initialized=!0,this.registerWithContext(),this.emit("initialized"),this.config.debug&&console.log("[ABsmartly] DOM Changes Plugin initialized"),[3,5];case 4:throw e=t.sent(),console.error("[ABsmartly] Failed to initialize plugin:",e),e;case 5:return[2]}})})},e.prototype.setupMessageBridge=function(){var t=this;this.messageBridge=new c.MessageBridge(this.config.debug),this.messageBridge.on("PREVIEW_CHANGES",function(e){e.changes&&t.previewChanges(e.changes)}),this.messageBridge.on("REMOVE_PREVIEW",function(){t.removePreview()}),this.messageBridge.on("APPLY_CHANGES",function(e){t.applyChanges(e.experimentName)}),this.messageBridge.on("REMOVE_CHANGES",function(e){t.removeChanges(e.experimentName)}),this.messageBridge.on("INJECTION_CODE",function(e){var r={headStart:e.headStart,headEnd:e.headEnd,bodyStart:e.bodyStart,bodyEnd:e.bodyEnd};t.injectCode(r)}),this.messageBridge.on("UPDATE_OVERRIDES",function(e){e.overrides&&(t.setOverrideCookie(e.overrides),t.applyOverridesToContext(),t.refreshChanges())}),this.messageBridge.on("GET_OVERRIDES",function(){var e,r=t.getOverridesFromCookie();null===(e=t.messageBridge)||void 0===e||e.sendOverridesData(r)}),this.messageBridge.on("GET_EXPERIMENTS",function(){var e,r,n=(null===(e=t.config.context.data())||void 0===e?void 0:e.experiments)||[];null===(r=t.messageBridge)||void 0===r||r.sendExperimentData(n)}),this.messageBridge.notifyReady(e.VERSION,["preview","overrides","injection","spa","visibility"])},e.prototype.setupMutationObserver=function(){var e=this,t=new MutationObserver(function(){var t,r,n=e.stateManager.getPendingChanges();if(0!==n.length)try{for(var i=a(n),o=i.next();!o.done;o=i.next()){var s=o.value;document.querySelectorAll(s.change.selector).length>0&&e.domManipulator.applyChange(s.change,s.experimentName)&&e.stateManager.removePendingChange(s.experimentName,s.change)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}});t.observe(document.body,{childList:!0,subtree:!0}),this.mutationObserver=t},e.prototype.setupVisibilityObserver=function(){var e=this,t=new IntersectionObserver(function(t){t.forEach(function(t){var r;if(t.isIntersecting){var n=t.target.getAttribute("data-absmartly-experiment");if(n&&!e.exposedExperiments.has(n)){e.config.context.treatment(n),e.exposedExperiments.add(n),e.emit("experiment-triggered",{experimentName:n});var i=e.config.context.peek(n);void 0!==i&&(null===(r=e.messageBridge)||void 0===r||r.notifyExperimentTriggered(n,i))}}})});this.visibilityObserver=t},e.prototype.previewChanges=function(e){var t,r,n;this.config.debug&&console.log("[ABsmartly] previewChanges called with",e.length,"changes:",e),this.stateManager.startPreview();var i=0;try{for(var o=a(e),s=o.next();!s.done;s=o.next()){var l=s.value;this.domManipulator.applyChange(l,"__preview__")?(i++,this.config.debug&&console.log("[ABsmartly] Successfully applied preview change:",l.selector)):this.config.debug&&console.log("[ABsmartly] Failed to apply preview change:",l.selector)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}this.config.debug&&console.log("[ABsmartly] Preview started with",i,"of",e.length,"changes applied"),this.emit("preview-started",{changeCount:i}),null===(n=this.messageBridge)||void 0===n||n.notifyPreviewStarted(i)},e.prototype.removePreview=function(){var e,t,r;this.config.debug&&console.log("[ABsmartly] removePreview called");var n=this.stateManager.getPreviewChanges();this.config.debug&&console.log("[ABsmartly] Removing",n.length,"preview changes");try{for(var i=a(n),o=i.next();!o.done;o=i.next()){var s=o.value;this.domManipulator.removeChange(s.change,"__preview__")}}catch(t){e={error:t}}finally{try{o&&!o.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}this.stateManager.endPreview(),this.emit("preview-ended"),null===(r=this.messageBridge)||void 0===r||r.notifyPreviewEnded(),this.config.debug&&console.log("[ABsmartly] Preview ended")},e.prototype.isPreviewActive=function(){return this.stateManager.isInPreviewMode()},e.prototype.applyChanges=function(e){return n(this,void 0,void 0,function(){var t,r,n,s,l,c,d,u,h,p,g,f,y,v,m,b=this;return i(this,function(i){t=e?new Map([[e,this.variantExtractor.getExperimentChanges(e)||[]]]):this.variantExtractor.extractAllChanges(),r=0;try{for(n=a(t),s=n.next();!s.done;s=n.next()){l=o(s.value,2),c=l[0],d=l[1];try{for(y=void 0,u=a(d),h=u.next();!h.done;h=u.next())p=h.value,0===document.querySelectorAll(p.selector).length&&"create"!==p.type?this.config.spa&&this.stateManager.addPendingChange(c,p):this.domManipulator.applyChange(p,c)&&(r++,this.config.visibilityTracking&&this.visibilityObserver&&document.querySelectorAll('[data-absmartly-experiment="'.concat(c,'"]')).forEach(function(e){b.visibilityObserver.observe(e)}))}catch(e){y={error:e}}finally{try{h&&!h.done&&(v=u.return)&&v.call(u)}finally{if(y)throw y.error}}}}catch(e){g={error:e}}finally{try{s&&!s.done&&(f=n.return)&&f.call(n)}finally{if(g)throw g.error}}return this.emit("changes-applied",{count:r,experimentName:e}),null===(m=this.messageBridge)||void 0===m||m.notifyChangesApplied(r,e),[2]})})},e.prototype.removeChanges=function(e){var t,r,n;if(e){var i=this.stateManager.getAppliedChanges(e);try{for(var o=a(i),s=o.next();!s.done;s=o.next()){var l=s.value;this.domManipulator.removeChange(l.change,e)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}this.stateManager.removeAppliedChanges(e)}else this.domManipulator.removeAllChanges(),this.stateManager.removeAppliedChanges();this.emit("changes-removed",{experimentName:e}),null===(n=this.messageBridge)||void 0===n||n.notifyChangesRemoved(e)},e.prototype.refreshChanges=function(){this.removeChanges(),this.applyChanges()},e.prototype.getOverridesFromCookie=function(){var e,t,r=this.config.overrideCookieName+"=",n=decodeURIComponent(document.cookie).split(";");try{for(var i=a(n),o=i.next();!o.done;o=i.next()){var s=o.value;if(0===(s=s.trim()).indexOf(r)){var l=s.substring(r.length);try{return JSON.parse(l)}catch(e){console.error("[ABsmartly] Failed to parse overrides cookie:",e)}}}}catch(t){e={error:t}}finally{try{o&&!o.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return{}},e.prototype.setOverrideCookie=function(e){var t=JSON.stringify(e),r=new Date;r.setDate(r.getDate()+30),document.cookie="".concat(this.config.overrideCookieName,"=").concat(t,"; expires=").concat(r.toUTCString(),"; path=/")},e.prototype.applyOverridesToContext=function(){var e,t,r=this.getOverridesFromCookie();try{for(var n=a(Object.entries(r)),i=n.next();!i.done;i=n.next()){var s=o(i.value,2),l=s[0],c=s[1];this.config.context.override(l,c),this.config.debug&&console.log("[ABsmartly] Applied override: ".concat(l," -> variant ").concat(c))}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}},e.prototype.injectCode=function(e){var t,r=this.codeInjector.inject(e);this.emit("code-injected",{locations:r}),null===(t=this.messageBridge)||void 0===t||t.notifyCodeInjected(r)},e.prototype.requestInjectionCode=function(){var e;null===(e=this.messageBridge)||void 0===e||e.requestInjectionCode()},e.prototype.getAppliedChanges=function(){return this.stateManager.getAppliedChanges()},e.prototype.getPendingChanges=function(){return this.stateManager.getPendingChanges()},e.prototype.hasChanges=function(e){return this.stateManager.hasChanges(e)},e.prototype.getOriginalState=function(e){var t,r;try{for(var n=a(["text","html","style","class","attribute","move"]),i=n.next();!i.done;i=n.next()){var o=i.value,s=this.stateManager.getOriginalState(e,o);if(s)return s}}catch(e){t={error:e}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}},e.prototype.on=function(e,t){var r=this.eventListeners.get(e)||[];r.push(t),this.eventListeners.set(e,r)},e.prototype.off=function(e,t){if(t){var r=this.eventListeners.get(e)||[],n=r.indexOf(t);-1!==n&&r.splice(n,1)}else this.eventListeners.delete(e)},e.prototype.emit=function(e,t){(this.eventListeners.get(e)||[]).forEach(function(r){try{r(t)}catch(t){console.error("[ABsmartly] Error in event listener for ".concat(e,":"),t)}})},e.prototype.destroy=function(){this.removeChanges(),this.codeInjector.cleanup(),this.stateManager.clearAll(),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.visibilityObserver&&(this.visibilityObserver.disconnect(),this.visibilityObserver=null),this.messageBridge&&(this.messageBridge.destroy(),this.messageBridge=null),this.eventListeners.clear(),this.exposedExperiments.clear(),this.unregisterFromContext(),this.initialized=!1,this.config.debug&&console.log("[ABsmartly] DOM Changes Plugin destroyed")},e.prototype.registerWithContext=function(){this.config.context&&(this.config.context.__domPlugin={version:e.VERSION,initialized:!0,capabilities:["preview","overrides","injection","spa","visibility"],instance:this,timestamp:Date.now()},this.config.debug&&console.log("[ABsmartly] Plugin registered with context"))},e.prototype.unregisterFromContext=function(){this.config.context&&this.config.context.__domPlugin&&(delete this.config.context.__domPlugin,this.config.debug&&console.log("[ABsmartly] Plugin unregistered from context"))},e.VERSION="1.0.0",e}();t.DOMChangesPlugin=h},574:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},624:function(e,t){var r=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,a=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}return o},n=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,i=0,a=t.length;i<a;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.DOMManipulator=void 0;var i=function(){function e(e,t){void 0===t&&(t=!1),this.stateManager=e,this.debug=t}return e.prototype.applyChange=function(e,t){var i=this;if(!e.enabled&&void 0!==e.enabled)return!1;try{var a=document.querySelectorAll(e.selector),o=[];if(0===a.length&&"create"!==e.type)return this.debug&&console.warn("[ABsmartly] No elements found for selector: ".concat(e.selector)),!1;if(a.forEach(function(a){var s,l;switch(i.stateManager.storeOriginalState(e.selector,a,e.type),e.type){case"text":void 0!==e.value&&(a.textContent=String(e.value),o.push(a));break;case"html":void 0!==e.value&&(a.innerHTML=String(e.value),o.push(a));break;case"style":e.value&&"object"==typeof e.value&&(Object.entries(e.value).forEach(function(e){var t=r(e,2),n=t[0],i=t[1];a.style.setProperty(n,String(i))}),o.push(a));break;case"class":e.add&&Array.isArray(e.add)&&(s=a.classList).add.apply(s,n([],r(e.add),!1)),e.remove&&Array.isArray(e.remove)&&(l=a.classList).remove.apply(l,n([],r(e.remove),!1)),o.push(a);break;case"attribute":e.value&&"object"==typeof e.value&&(Object.entries(e.value).forEach(function(e){var t=r(e,2),n=t[0],i=t[1];null==i?a.removeAttribute(n):a.setAttribute(n,String(i))}),o.push(a));break;case"javascript":if(e.value)try{new Function("element",String(e.value))(a),o.push(a)}catch(e){console.error("[ABsmartly] JavaScript execution error:",e)}break;case"move":if(e.targetSelector){var c=document.querySelector(e.targetSelector);c?(i.moveElement(a,c,e.position),o.push(a)):i.debug&&console.warn("[ABsmartly] Move target not found: ".concat(e.targetSelector))}}a.setAttribute("data-absmartly-modified","true"),a.setAttribute("data-absmartly-experiment",t)}),"create"===e.type&&e.element&&e.targetSelector){var s=this.createElement(e,t);s&&o.push(s)}return o.length>0&&(this.stateManager.addAppliedChange(t,e,o),!0)}catch(t){return this.debug&&console.error("[ABsmartly] Error applying DOM change:",t,e),!1}},e.prototype.moveElement=function(e,t,r){var n,i,a;switch(r){case"before":null===(n=t.parentElement)||void 0===n||n.insertBefore(e,t);break;case"after":t.nextSibling?null===(i=t.parentElement)||void 0===i||i.insertBefore(e,t.nextSibling):null===(a=t.parentElement)||void 0===a||a.appendChild(e);break;case"firstChild":t.firstChild?t.insertBefore(e,t.firstChild):t.appendChild(e);break;default:t.appendChild(e)}},e.prototype.createElement=function(e,t){if(!e.element||!e.targetSelector)return null;var r=document.querySelector(e.targetSelector);if(!r)return this.debug&&console.warn("[ABsmartly] Create target not found: ".concat(e.targetSelector)),null;var n=document.createElement("div");n.innerHTML=e.element;var i=n.firstElementChild;if(!i)return null;var a="".concat(t,"-").concat(e.selector,"-create-").concat(Date.now());return this.stateManager.addCreatedElement(a,i),this.moveElement(i,r,e.position),i.setAttribute("data-absmartly-created","true"),i.setAttribute("data-absmartly-experiment",t),i.setAttribute("data-absmartly-change-id",a),i},e.prototype.removeChange=function(e,t){var r=this;try{document.querySelectorAll('[data-absmartly-experiment="'.concat(t,'"]')).forEach(function(t){if(t.hasAttribute("data-absmartly-created")){var n=t.getAttribute("data-absmartly-change-id");n&&r.stateManager.removeCreatedElement(n)}else{var i=r.stateManager.getOriginalState(e.selector,e.type);i&&r.restoreElement(t,i,e.type),t.removeAttribute("data-absmartly-modified"),t.removeAttribute("data-absmartly-experiment")}})}catch(e){this.debug&&console.error("[ABsmartly] Error removing DOM change:",e)}},e.prototype.restoreElement=function(e,t,i){var a,o=t.originalState;switch(i){case"text":void 0!==o.text&&(e.textContent=o.text);break;case"html":void 0!==o.html&&(e.innerHTML=o.html);break;case"style":void 0!==o.style&&e.setAttribute("style",o.style);break;case"class":o.classList&&(e.className="",(a=e.classList).add.apply(a,n([],r(o.classList),!1)));break;case"attribute":if(o.attributes){for(;e.attributes.length>0;)e.removeAttribute(e.attributes[0].name);Object.entries(o.attributes).forEach(function(t){var n=r(t,2),i=n[0],a=n[1];e.setAttribute(i,a)})}break;case"move":o.parent&&(o.nextSibling?o.parent.insertBefore(e,o.nextSibling):o.parent.appendChild(e))}},e.prototype.removeAllChanges=function(e){var t=e?'[data-absmartly-experiment="'.concat(e,'"]'):"[data-absmartly-modified], [data-absmartly-created]";document.querySelectorAll(t).forEach(function(e){e.hasAttribute("data-absmartly-created")?e.remove():(e.removeAttribute("data-absmartly-modified"),e.removeAttribute("data-absmartly-experiment"))})},e}();t.DOMManipulator=i},937:function(e,t){var r=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,a=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}return o},n=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,i=0,a=t.length;i<a;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.CodeInjector=void 0;var i=function(){function e(e){void 0===e&&(e=!1),this.injectedElements=new Map,this.debug=e}return e.prototype.inject=function(e){var t=[];return e.headStart&&(this.injectCode("headStart",e.headStart),t.push("headStart")),e.headEnd&&(this.injectCode("headEnd",e.headEnd),t.push("headEnd")),e.bodyStart&&(this.injectCode("bodyStart",e.bodyStart),t.push("bodyStart")),e.bodyEnd&&(this.injectCode("bodyEnd",e.bodyEnd),t.push("bodyEnd")),t},e.prototype.injectCode=function(e,t){try{var i=[],a=document.createElement("div");for(a.innerHTML=t;a.firstChild;){var o=a.firstChild;switch(o.nodeType===Node.ELEMENT_NODE&&o.setAttribute("data-absmartly-injected",e),e){case"headStart":document.head.firstChild?document.head.insertBefore(o,document.head.firstChild):document.head.appendChild(o);break;case"headEnd":document.head.appendChild(o);break;case"bodyStart":document.body.firstChild?document.body.insertBefore(o,document.body.firstChild):document.body.appendChild(o);break;case"bodyEnd":document.body.appendChild(o)}o.nodeType===Node.ELEMENT_NODE&&i.push(o)}var s=this.injectedElements.get(e)||[];this.injectedElements.set(e,n(n([],r(s),!1),r(i),!1)),this.debug&&console.log("[ABsmartly] Injected ".concat(i.length," elements at ").concat(e))}catch(t){console.error("[ABsmartly] Error injecting code at ".concat(e,":"),t)}},e.prototype.removeInjected=function(e){if(e){var t=this.injectedElements.get(e);t&&(t.forEach(function(e){return e.remove()}),this.injectedElements.delete(e))}else this.injectedElements.forEach(function(e){e.forEach(function(e){return e.remove()})}),this.injectedElements.clear()},e.prototype.getInjectedElements=function(e){if(e)return this.injectedElements.get(e)||[];var t=[];return this.injectedElements.forEach(function(e){t.push.apply(t,n([],r(e),!1))}),t},e.prototype.cleanup=function(){this.removeInjected()},e}();t.CodeInjector=i},944:function(e,t){var r=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,a=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}return o},n=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,i=0,a=t.length;i<a;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.StateManager=void 0;var i=function(){function e(){this.appliedChanges=new Map,this.pendingChanges=new Map,this.originalStates=new Map,this.createdElements=new Map,this.previewChanges=[],this.isPreviewMode=!1}return e.prototype.storeOriginalState=function(e,t,r){var n="".concat(e,"-").concat(r);if(!this.originalStates.has(n)){var i={selector:e,type:r,originalState:{}};switch(r){case"text":i.originalState.text=t.textContent||"";break;case"html":i.originalState.html=t.innerHTML;break;case"style":i.originalState.style=t.getAttribute("style")||"";break;case"class":i.originalState.classList=Array.from(t.classList);break;case"attribute":i.originalState.attributes={};for(var a=0;a<t.attributes.length;a++){var o=t.attributes[a];i.originalState.attributes[o.name]=o.value}break;case"move":i.originalState.parent=t.parentElement,i.originalState.nextSibling=t.nextElementSibling}this.originalStates.set(n,i)}},e.prototype.getOriginalState=function(e,t){return this.originalStates.get("".concat(e,"-").concat(t))},e.prototype.addAppliedChange=function(e,t,r){var n={experimentName:e,change:t,elements:r,timestamp:Date.now()};if(this.isPreviewMode)this.previewChanges.push(n);else{var i=this.appliedChanges.get(e)||[];i.push(n),this.appliedChanges.set(e,i)}},e.prototype.getAppliedChanges=function(e){if(e)return this.appliedChanges.get(e)||[];var t=[];return this.appliedChanges.forEach(function(e){t.push.apply(t,n([],r(e),!1))}),t},e.prototype.removeAppliedChanges=function(e){e?this.appliedChanges.delete(e):this.appliedChanges.clear()},e.prototype.addPendingChange=function(e,t){var r={experimentName:e,change:t,retryCount:0},n=this.pendingChanges.get(e)||[];n.push(r),this.pendingChanges.set(e,n)},e.prototype.getPendingChanges=function(e){if(e)return this.pendingChanges.get(e)||[];var t=[];return this.pendingChanges.forEach(function(e){t.push.apply(t,n([],r(e),!1))}),t},e.prototype.removePendingChange=function(e,t){var r=this.pendingChanges.get(e);if(r){var n=r.findIndex(function(e){return e.change.selector===t.selector&&e.change.type===t.type});-1!==n&&(r.splice(n,1),0===r.length&&this.pendingChanges.delete(e))}},e.prototype.incrementRetryCount=function(e,t){var r=this.pendingChanges.get(e);if(r){var n=r.find(function(e){return e.change.selector===t.selector&&e.change.type===t.type});n&&n.retryCount++}},e.prototype.addCreatedElement=function(e,t){this.createdElements.set(e,t)},e.prototype.getCreatedElement=function(e){return this.createdElements.get(e)},e.prototype.removeCreatedElement=function(e){var t=this.createdElements.get(e);t&&(t.remove(),this.createdElements.delete(e))},e.prototype.startPreview=function(){this.isPreviewMode=!0,this.previewChanges=[]},e.prototype.endPreview=function(){this.isPreviewMode=!1,this.previewChanges=[]},e.prototype.isInPreviewMode=function(){return this.isPreviewMode},e.prototype.getPreviewChanges=function(){return this.previewChanges},e.prototype.clearAll=function(){this.appliedChanges.clear(),this.pendingChanges.clear(),this.originalStates.clear(),this.createdElements.forEach(function(e){return e.remove()}),this.createdElements.clear(),this.previewChanges=[],this.isPreviewMode=!1},e.prototype.hasChanges=function(e){return this.appliedChanges.has(e)},e}();t.StateManager=i}},t={},r=function r(n){var i=t[n];if(void 0!==i)return i.exports;var a=t[n]={exports:{}};return e[n].call(a.exports,a,a.exports,r),a.exports}(156);return r.default})());
//# sourceMappingURL=absmartly-dom-changes.min.js.map
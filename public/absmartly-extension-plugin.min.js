var ABsmartlyExtensionPlugin=(()=>{var h=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var f=Object.prototype.hasOwnProperty;var y=(o,e,t)=>e in o?h(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var b=(o,e)=>{for(var t in e)h(o,t,{get:e[t],enumerable:!0})},m=(o,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of p(e))!f.call(o,n)&&n!==t&&h(o,n,{get:()=>e[n],enumerable:!(i=u(e,n))||i.enumerable});return o};var E=o=>m(h({},"__esModule",{value:!0}),o);var r=(o,e,t)=>(y(o,typeof e!="symbol"?e+"":e,t),t);var v={};b(v,{CodeInjector:()=>c,ExtensionDOMPlugin:()=>g,MessageBridge:()=>l,StateManager:()=>d});var d=class{constructor(e=!1){r(this,"stateMap",new Map);r(this,"appliedChanges",new Map);r(this,"debug");this.debug=e}storeState(e,t){this.stateMap.has(e)||this.stateMap.set(e,new Map);let i=this.stateMap.get(e);if(!i.has(t)){let n={textContent:e.textContent||void 0,innerHTML:e.innerHTML||void 0,attributes:this.captureAttributes(e),styles:this.captureStyles(e),classList:Array.from(e.classList)};i.set(t,n),this.debug&&console.log(`[StateManager] Stored state for ${t}:`,n)}return i.get(t)}trackChange(e){let{experimentName:t}=e;this.appliedChanges.has(t)||this.appliedChanges.set(t,[]);let i={...e,appliedAt:Date.now()};this.appliedChanges.get(t).push(i),this.debug&&console.log(`[StateManager] Tracked change for ${t}:`,i)}getState(e,t){return this.stateMap.get(e)?.get(t)||null}getAppliedChanges(e){return this.appliedChanges.get(e)||[]}revertElement(e,t){let i=this.getState(e,t);if(!i)return this.debug&&console.warn(`[StateManager] No state found for element in ${t}`),!1;try{if(i.textContent!==void 0&&(e.textContent=i.textContent),i.innerHTML!==void 0&&(e.innerHTML=i.innerHTML),i.attributes&&Object.entries(i.attributes).forEach(([n,s])=>{s===null?e.removeAttribute(n):e.setAttribute(n,s)}),i.styles){let n=e;Object.entries(i.styles).forEach(([s,a])=>{n.style[s]=a})}return i.classList&&(e.className=i.classList.join(" ")),e.removeAttribute("data-absmartly-experiment"),e.removeAttribute("data-absmartly-modified"),e.removeAttribute("data-absmartly-original"),this.debug&&console.log(`[StateManager] Reverted element for ${t}`),!0}catch(n){return console.error("[StateManager] Error reverting element:",n),!1}}removeExperiment(e){let t=this.getAppliedChanges(e);if(t.length===0)return!1;let i=!0;for(let n of t)this.revertElement(n.element,e)||(i=!1);return this.appliedChanges.delete(e),this.stateMap.forEach(n=>{n.delete(e)}),this.debug&&console.log(`[StateManager] Removed experiment ${e}, success: ${i}`),i}clear(){this.stateMap.clear(),this.appliedChanges.clear()}captureAttributes(e){let t={};for(let i of Array.from(e.attributes))t[i.name]=i.value;return t}captureStyles(e){let t={},i=window.getComputedStyle(e);if(e.style.length>0)for(let n=0;n<e.style.length;n++){let s=e.style[n];t[s]=e.style.getPropertyValue(s)}return t}};var l=class{constructor(e=!1){r(this,"handlers",new Map);r(this,"debug");r(this,"listenerAttached",!1);this.debug=e,this.setupListener()}send(e,t){let i={source:"absmartly-page",type:e,payload:t};this.debug&&console.log("[MessageBridge] Sending message:",i),window.postMessage(i,"*")}on(e,t){this.handlers.has(e)||this.handlers.set(e,[]),this.handlers.get(e).push(t),this.debug&&console.log(`[MessageBridge] Registered handler for: ${e}`)}off(e,t){let i=this.handlers.get(e);if(i){let n=i.indexOf(t);n>-1&&i.splice(n,1)}}removeAllHandlers(e){this.handlers.delete(e)}setupListener(){this.listenerAttached||(window.addEventListener("message",e=>{if(!e.data||e.data.source!=="absmartly-extension")return;let t=e.data;this.debug&&console.log("[MessageBridge] Received message:",t),this.handleMessage(t)}),this.listenerAttached=!0,this.debug&&console.log("[MessageBridge] Message listener attached"))}handleMessage(e){let t=this.handlers.get(e.type);if(!t||t.length===0){this.debug&&console.log(`[MessageBridge] No handlers for message type: ${e.type}`);return}t.forEach(i=>{try{i(e.payload)}catch(n){console.error(`[MessageBridge] Error in handler for ${e.type}:`,n)}})}notifyReady(e,t){this.send("PLUGIN_INITIALIZED",{version:e,capabilities:t})}requestCustomCode(){this.send("REQUEST_CUSTOM_CODE")}notifyExperimentTriggered(e,t){this.send("EXPERIMENT_TRIGGERED",{experimentName:e,variant:t})}destroy(){this.handlers.clear()}};var c=class{constructor(e=!1){r(this,"debug");r(this,"injectedElements",new Set);this.debug=e}injectCode(e){this.debug&&console.log("[CodeInjector] Injecting custom code:",e),e.headStart&&this.injectAtLocation(e.headStart,"headStart"),e.headEnd&&this.injectAtLocation(e.headEnd,"headEnd"),e.bodyStart&&this.injectAtLocation(e.bodyStart,"bodyStart"),e.bodyEnd&&this.injectAtLocation(e.bodyEnd,"bodyEnd")}injectAtLocation(e,t){if(!e)return;this.debug&&console.log(`[CodeInjector] Injecting at ${t}:`,e.substring(0,100));let i=document.createElement("div");i.innerHTML=e,i.setAttribute("data-absmartly-injected",t),Array.from(i.children).forEach(s=>{this.injectElement(s,t)}),this.executeScriptsInHTML(e,t)}injectElement(e,t){e.setAttribute("data-absmartly-injected",t);let i=this.getTargetLocation(t);i&&(i.appendChild(e),this.injectedElements.add(e),this.debug&&console.log(`[CodeInjector] Injected element at ${t}:`,e))}getTargetLocation(e){switch(e){case"headStart":return document.head.firstChild?document.head:null;case"headEnd":return document.head;case"bodyStart":return document.body.firstChild?document.body:null;case"bodyEnd":return document.body;default:return null}}executeScriptsInHTML(e,t){let i=document.createElement("div");i.innerHTML=e,i.querySelectorAll("script").forEach(s=>{try{if(s.src){let a=document.createElement("script");a.src=s.src,a.async=s.async,a.defer=s.defer,a.setAttribute("data-absmartly-injected",t),this.insertAtLocation(a,t),this.injectedElements.add(a)}else{let a=s.textContent||s.innerText||"";a&&(new Function(a)(),this.debug&&console.log(`[CodeInjector] Executed inline script from ${t}`))}}catch(a){console.error(`[CodeInjector] Failed to execute script from ${t}:`,a)}})}insertAtLocation(e,t){switch(t){case"headStart":document.head.firstChild?document.head.insertBefore(e,document.head.firstChild):document.head.appendChild(e);break;case"headEnd":document.head.appendChild(e);break;case"bodyStart":document.body.firstChild?document.body.insertBefore(e,document.body.firstChild):document.body.appendChild(e);break;case"bodyEnd":document.body.appendChild(e);break}}injectStyle(e,t){let i=document.createElement("style");t&&(i.id=t),i.setAttribute("data-absmartly-injected","style"),i.textContent=e,document.head.appendChild(i),this.injectedElements.add(i),this.debug&&console.log("[CodeInjector] Injected style:",e.substring(0,100))}injectScript(e,t){let i=document.createElement("script");t&&(i.id=t),i.src=e,i.setAttribute("data-absmartly-injected","script"),document.head.appendChild(i),this.injectedElements.add(i),this.debug&&console.log("[CodeInjector] Injected script:",e)}removeAll(){this.injectedElements.forEach(e=>{try{e.parentNode?.removeChild(e)}catch(t){console.error("[CodeInjector] Failed to remove injected element:",t)}}),this.injectedElements.clear(),this.debug&&console.log("[CodeInjector] Removed all injected elements")}getInjectedElements(){return Array.from(this.injectedElements)}};var g=class{constructor(e,t){r(this,"basePlugin");r(this,"stateManager");r(this,"messageBridge");r(this,"codeInjector");r(this,"config");r(this,"initialized",!1);this.basePlugin=e,this.config={context:t.context,autoApply:t.autoApply??!0,spa:t.spa??!0,visibilityTracking:t.visibilityTracking??!0,dataSource:t.dataSource??"variable",dataFieldName:t.dataFieldName??"__dom_changes",debug:t.debug??!1},this.stateManager=new d(this.config.debug),this.messageBridge=new l(this.config.debug),this.codeInjector=new c(this.config.debug),this.setupMessageHandlers()}async initialize(){this.initialized||(this.basePlugin.initialize&&await this.basePlugin.initialize(),this.basePlugin.on&&(this.basePlugin.on("change-applied",e=>{this.handleChangeApplied(e)}),this.basePlugin.on("experiment-triggered",e=>{this.messageBridge.notifyExperimentTriggered(e.experimentName,e.variant)})),this.messageBridge.notifyReady("1.0.0",["state-management","change-reversion","code-injection","preview-changes"]),this.config.context&&(this.config.context.__domPlugin={instance:this,initialized:!0,version:"1.0.0",capabilities:["state-management","change-reversion"],timestamp:Date.now()},typeof window<"u"&&(window.__absmartlyPlugin=this,window.__absmartlyDOMChangesPlugin=this)),this.initialized=!0,this.config.debug&&(console.log("[ExtensionDOMPlugin] Initialized successfully"),console.log("[ExtensionDOMPlugin] Available methods:",Object.getOwnPropertyNames(Object.getPrototypeOf(this)).filter(e=>typeof this[e]=="function")),console.log("[ExtensionDOMPlugin] removeChanges is function:",typeof this.removeChanges=="function")))}applyChange(e,t="__preview__"){if(!e.selector||!e.type||e.enabled===!1)return!1;let i=document.querySelectorAll(e.selector);if(i.length===0)return this.config.debug&&console.warn(`[ExtensionDOMPlugin] No elements found for: ${e.selector}`),!1;let n=!0;return i.forEach(s=>{try{let a=this.stateManager.storeState(s,t);this.applyChangeManually(s,e,t),this.stateManager.trackChange({experimentName:t,selector:e.selector,type:e.type,element:s,originalState:a}),this.config.debug&&console.log(`[ExtensionDOMPlugin] Applied ${e.type} change to element:`,{selector:e.selector,experimentName:t,element:s})}catch(a){console.error("[ExtensionDOMPlugin] Error applying change:",a),n=!1}}),n}removeChanges(e){return this.config.debug&&console.log(`[ExtensionDOMPlugin] Removing changes for: ${e}`),this.stateManager.removeExperiment(e)}revertChange(e,t){return this.stateManager.revertElement(e,t)}getOriginalState(e,t){return this.stateManager.getState(e,t)}getAppliedChanges(e){return this.stateManager.getAppliedChanges(e)}injectCode(e){this.codeInjector.injectCode(e)}on(e,t){this.basePlugin.on&&this.basePlugin.on(e,t)}getBasePlugin(){return this.basePlugin}setupMessageHandlers(){this.messageBridge.on("PREVIEW_CHANGES",e=>{let{changes:t,experimentName:i,updateMode:n}=e||{},s=i||"__preview__";this.config.debug&&console.log(`[ExtensionDOMPlugin] Applying preview for: ${s}`),this.removeChanges(s),t&&Array.isArray(t)&&t.forEach(a=>{this.applyChange(a,s)})}),this.messageBridge.on("REMOVE_PREVIEW",e=>{let{experimentName:t}=e||{},i=t||"__preview__";this.config.debug&&console.log(`[ExtensionDOMPlugin] Removing preview: ${i}`),this.removeChanges(i)}),this.messageBridge.on("INJECT_CUSTOM_CODE",e=>{e&&e.code&&this.injectCode(e.code)})}handleChangeApplied(e){let{experimentName:t,change:i,element:n}=e;if(n&&t){let s=this.stateManager.storeState(n,t);this.stateManager.trackChange({experimentName:t,selector:i.selector,type:i.type,element:n,originalState:s})}}applyChangeManually(e,t,i){switch(e.setAttribute("data-absmartly-experiment",i),e.setAttribute("data-absmartly-modified","true"),t.type){case"text":e.textContent=t.value;break;case"html":e.innerHTML=t.value;break;case"style":case"styles":let n=t.styles||t.value;typeof n=="object"?Object.entries(n).forEach(([s,a])=>{e.style[s]=a}):typeof n=="string"&&e.setAttribute("style",n);break;case"class":t.className&&e.classList.add(t.className);break;case"attribute":t.attribute&&t.value!==void 0&&e.setAttribute(t.attribute,t.value);break}}destroy(){this.stateManager.clear(),this.messageBridge.destroy(),this.codeInjector.removeAll(),this.basePlugin.destroy&&this.basePlugin.destroy(),this.config.context?.__domPlugin&&delete this.config.context.__domPlugin,this.initialized=!1}};typeof window<"u"&&(window.ABsmartlyExtensionPlugin={ExtensionDOMPlugin:g,StateManager:d,MessageBridge:l,CodeInjector:c,version:"1.0.0"});return E(v);})();

<!DOCTYPE html>
<html>
<head>
  <title>Test Brittle Selectors</title>
</head>
<body>
  <!-- Case 1: Single paragraph in unique parent -->
  <div id="unique-container">
    <p>This is the only paragraph here</p>
  </div>

  <!-- Case 2: Single span in nested structure -->
  <div id="another-container">
    <div>
      <div>
        <span>Only span in nested divs</span>
      </div>
    </div>
  </div>

  <!-- Case 3: Single h1 on page -->
  <h1>Main Title</h1>

  <!-- Case 4: Link inside unique parent -->
  <nav id="main-nav">
    <a href="#">Home</a>
  </nav>

  <script>
    // Copy the updated getSelector function (simplified for testing)
    function getSelector(element) {
      if (!element) return ''

      // Collect element path
      let pathElements = []
      let current = element
      const maxDepth = 10

      while (current && current !== document.body && current !== document.documentElement && pathElements.length < maxDepth) {
        pathElements.push(current)
        current = current.parentElement
      }

      // Try with minimal tag path, but always include parent IDs for context
      for (let startDepth = 1; startDepth <= pathElements.length; startDepth++) {
        let basePath = []
        let foundId = false

        for (let i = startDepth - 1; i >= 0; i--) {
          const elem = pathElements[i]

          // If we find a parent with ID, use it as anchor
          if (elem.id) {
            basePath.unshift('#' + elem.id)
            foundId = true
            // Add remaining path to target
            for (let j = i - 1; j >= 0; j--) {
              basePath.push(pathElements[j].tagName.toLowerCase())
            }
            break
          } else {
            basePath.unshift(elem.tagName.toLowerCase())
          }
        }

        const selector = basePath.join(' > ')
        const matches = document.querySelectorAll(selector)

        if (matches.length === 1 && matches[0] === element) {
          // Don't accept single tag selectors - too brittle!
          if (!selector.includes('#') && !selector.includes('>') && !selector.includes('[')) {
            console.log('[ABSmartly] Single tag selector too brittle, continuing search:', selector)
            continue
          }
          console.log('[ABSmartly] Found unique selector with context:', selector)
          return selector
        }
      }

      // Fallback
      return pathElements.map(e => e.tagName.toLowerCase()).reverse().join(' > ')
    }

    function runTests() {
      console.log('=== BRITTLE SELECTOR TESTS ===\n')

      const testCases = [
        { selector: '#unique-container p', name: 'Paragraph with parent ID' },
        { selector: '#another-container span', name: 'Nested span with ancestor ID' },
        { selector: 'h1', name: 'Single H1 (no parent ID)' },
        { selector: '#main-nav a', name: 'Link with parent ID' }
      ]

      testCases.forEach(test => {
        const elem = document.querySelector(test.selector)
        if (!elem) {
          console.error(`Element not found: ${test.selector}`)
          return
        }

        const generated = getSelector(elem)
        console.log(`\nTest: ${test.name}`)
        console.log(`Element: "${elem.textContent.trim()}"`)
        console.log(`Expected something like: ${test.selector}`)
        console.log(`Generated: ${generated}`)

        // Check if it's brittle
        const isBrittle = generated === 'p' || generated === 'span' || generated === 'h1' || generated === 'a'
        if (isBrittle) {
          console.error('❌ BRITTLE SELECTOR! Should include parent context')
        } else {
          console.log('✅ Good - includes context')
        }

        // Verify uniqueness
        const matches = document.querySelectorAll(generated)
        if (matches.length === 1 && matches[0] === elem) {
          console.log('✅ Selector is unique')
        } else {
          console.error('❌ Selector not unique!')
        }
      })

      console.log('\n\n=== EXPECTED BEHAVIOR ===')
      console.log('- Never return just a single tag like "p" or "span"')
      console.log('- Always include parent ID when available')
      console.log('- For elements without parent IDs, include parent tags for context')
    }

    window.addEventListener('load', runTests)
  </script>
</body>
</html>
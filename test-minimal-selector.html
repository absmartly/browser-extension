<!DOCTYPE html>
<html>
<head>
  <title>Minimal Selector Test</title>
</head>
<body>
  <!-- First carousel -->
  <div id="carousel-1">
    <h2>Carousel 1</h2>
    <ul>
      <li><span>Item 1-1</span></li>
      <li><span>Item 1-2</span></li>
      <li><span>Item 1-3</span></li>
    </ul>
  </div>

  <!-- Second carousel with same structure -->
  <div id="carousel-2">
    <h2>Carousel 2</h2>
    <ul>
      <li><span>Item 2-1</span></li>
      <li><span>Item 2-2</span></li>
      <li><span>Item 2-3</span></li>
    </ul>
  </div>

  <!-- Third carousel with ol instead of ul -->
  <div id="carousel-3">
    <h2>Carousel 3</h2>
    <ol>
      <li><span>Item 3-1</span></li>
      <li><span>Item 3-2</span></li>
      <li><span>Item 3-3</span></li>
    </ol>
  </div>

  <!-- Nested structure without ID -->
  <div>
    <div>
      <div>
        <ul>
          <li><span>Nested 1</span></li>
          <li><span>Nested 2</span></li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // Copy the updated getSelector function from background.ts
    function isAutoGenerated(str) {
      if (!str) return false
      if (/^[0-9]/.test(str)) return true

      const patterns = [
        /^framer-[a-zA-Z0-9]+$/,
        /^css-[a-z0-9]+$/i,
        /^sc-[a-zA-Z0-9]+$/,
        /^v-[a-f0-9]{8}$/,
        /^svelte-[a-z0-9]+$/,
        /^emotion-[0-9]+$/,
        /^chakra-/,
        /^MuiBox-root/,
        /^[a-f0-9]{8,}$/i,
        /_[a-f0-9]{6,}$/i
      ]

      if (patterns.some(pattern => pattern.test(str))) return true

      const segments = str.split(/[-_]/)
      for (const segment of segments) {
        if (segment.length < 6) continue
        const looksNormal = /^[A-Z][a-z]+$/.test(segment) ||
                           /^[a-z]+$/.test(segment) ||
                           /^[A-Z]+$/.test(segment) ||
                           /^[a-z]+[0-9]{1,2}$/.test(segment)
        if (!looksNormal) {
          if (/[0-9][a-zA-Z]{2,}[0-9]/.test(segment) ||
              /[a-z][A-Z]{2,}[a-z]/.test(segment) ||
              /[A-Z][a-z][0-9][a-zA-Z]{3,}/.test(segment)) {
            return true
          }
        }
      }
      return false
    }

    function getSelector(element) {
      if (!element) return ''

      // Collect element path
      let pathElements = []
      let current = element
      const maxDepth = 10

      while (current && current !== document.body && current !== document.documentElement && pathElements.length < maxDepth) {
        pathElements.push(current)
        current = current.parentElement
      }

      // Try building selector from different starting points (bottom-up)
      for (let startDepth = 1; startDepth <= pathElements.length; startDepth++) {
        let basePath = []
        let foundUniqueId = false

        for (let i = startDepth - 1; i >= 0; i--) {
          const elem = pathElements[i]

          if (elem.id && !isAutoGenerated(elem.id)) {
            const idMatches = document.querySelectorAll('#' + elem.id)
            if (idMatches.length === 1) {
              basePath = ['#' + elem.id]
              foundUniqueId = true
              // Add rest of path
              for (let j = i - 1; j >= 0; j--) {
                basePath.push(pathElements[j].tagName.toLowerCase())
              }
              break
            } else {
              if (i === startDepth - 1) {
                console.log('[ABSmartly] Ignoring duplicate ID:', elem.id, 'found', idMatches.length, 'times')
              }
              basePath.unshift(elem.tagName.toLowerCase())
            }
          } else {
            basePath.unshift(elem.tagName.toLowerCase())
          }
        }

        const selector = basePath.join(' > ')
        const matches = document.querySelectorAll(selector)

        if (matches.length === 1 && matches[0] === element) {
          console.log('[ABSmartly] Found unique selector at depth', startDepth, ':', selector)
          return selector
        }

        if (foundUniqueId) break
      }

      // Need to add specificity with nth-child
      console.log('[ABSmartly] Simple paths not unique. Adding nth-child for specificity...')

      for (let targetIndex = 0; targetIndex < pathElements.length; targetIndex++) {
        const targetElem = pathElements[targetIndex]

        if (targetElem.id && !isAutoGenerated(targetElem.id)) {
          const idMatches = document.querySelectorAll('#' + targetElem.id)
          if (idMatches.length === 1) continue
        }

        // Try minimal selector with nth-child at this level
        for (let startDepth = 1; startDepth <= pathElements.length; startDepth++) {
          let specificPath = []
          let foundUniqueId = false

          for (let i = startDepth - 1; i >= 0; i--) {
            const elem = pathElements[i]

            if (elem.id && !isAutoGenerated(elem.id)) {
              const idMatches = document.querySelectorAll('#' + elem.id)
              if (idMatches.length === 1) {
                specificPath = ['#' + elem.id]
                foundUniqueId = true
                for (let j = i - 1; j >= 0; j--) {
                  if (j === targetIndex && pathElements[j].parentElement) {
                    const childIndex = Array.from(pathElements[j].parentElement.children).indexOf(pathElements[j]) + 1
                    specificPath.push(pathElements[j].tagName.toLowerCase() + ':nth-child(' + childIndex + ')')
                  } else {
                    specificPath.push(pathElements[j].tagName.toLowerCase())
                  }
                }
                break
              } else {
                if (i === targetIndex && elem.parentElement) {
                  const childIndex = Array.from(elem.parentElement.children).indexOf(elem) + 1
                  specificPath.unshift(elem.tagName.toLowerCase() + ':nth-child(' + childIndex + ')')
                } else {
                  specificPath.unshift(elem.tagName.toLowerCase())
                }
              }
            } else if (i === targetIndex && elem.parentElement) {
              const childIndex = Array.from(elem.parentElement.children).indexOf(elem) + 1
              specificPath.unshift(elem.tagName.toLowerCase() + ':nth-child(' + childIndex + ')')
            } else {
              specificPath.unshift(elem.tagName.toLowerCase())
            }
          }

          const testSelector = specificPath.join(' > ')
          const testMatches = document.querySelectorAll(testSelector)

          if (testMatches.length === 1 && testMatches[0] === element) {
            console.log('[ABSmartly] Found minimal unique selector with nth-child at', targetElem.tagName, ':', testSelector)
            return testSelector
          }

          if (foundUniqueId) break
        }
      }

      // Fallback
      return 'span'
    }

    function testSelectors() {
      console.log('=== Testing Minimal Selector Generation ===\n')

      const testCases = [
        { selector: '#carousel-1 span', description: 'Carousel 1 spans' },
        { selector: '#carousel-2 span', description: 'Carousel 2 spans' },
        { selector: '#carousel-3 span', description: 'Carousel 3 spans' },
        { selector: 'div > div > div > ul > li > span', description: 'Nested spans' }
      ]

      testCases.forEach(testCase => {
        console.log('Testing:', testCase.description)
        const elements = document.querySelectorAll(testCase.selector)

        elements.forEach((elem, index) => {
          const selector = getSelector(elem)
          const matches = document.querySelectorAll(selector)
          const isUnique = matches.length === 1 && matches[0] === elem

          console.log(`  ${elem.textContent}: "${selector}"`)
          console.log(`    Unique: ${isUnique ? '✅' : '❌'} (matches: ${matches.length})`)
        })
        console.log('')
      })

      // Test that we get minimal selectors
      console.log('Expected minimal selectors:')
      console.log('  For carousel items: Should start with #carousel-X')
      console.log('  For nested items: Should be as short as possible (e.g., "ul > li:nth-child(2) > span")')
    }

    window.addEventListener('load', testSelectors)
  </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Selector Diagnostic Test</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    .test { margin: 20px 0; padding: 10px; border: 1px solid #ddd; }
    .pass { background: #d4edda; }
    .fail { background: #f8d7da; }
    .warn { background: #fff3cd; }
  </style>
</head>
<body>
  <h1>Selector Generation Diagnostic</h1>
  <div id="results"></div>

  <!-- Test HTML -->

  <!-- Case 1: Duplicate IDs -->
  <div id="product-list">
    <div class="item">
      <div id="price-tag">$10.99</div>
      <div id="product-title">Product 1</div>
    </div>
    <div class="item">
      <div id="price-tag">$20.99</div>
      <div id="product-title">Product 2</div>
    </div>
  </div>

  <!-- Case 2: Single child -->
  <div id="single-parent">
    <span>Only span here</span>
  </div>

  <!-- Case 3: Multiple children -->
  <div id="multi-parent">
    <span>First span</span>
    <span>Second span</span>
    <span>Third span</span>
  </div>

  <!-- Case 4: Nested without IDs -->
  <article>
    <section>
      <p>First paragraph</p>
      <p>Second paragraph</p>
    </section>
  </article>

  <!-- Case 5: Data attributes -->
  <button data-testid="submit">Submit</button>
  <button data-test="cancel">Cancel</button>

  <script>
    // Copy the EXACT getSelector from background.ts (simplified for testing)
    function getSelector(element) {
      if (!element) return ''

      // Check for unique ID
      if (element.id && !isAutoGenerated(element.id)) {
        const idMatches = document.querySelectorAll('#' + element.id)
        if (idMatches.length === 1) {
          return '#' + element.id
        }
      }

      // Check for data attributes
      const dataAttrs = Array.from(element.attributes)
        .filter(attr => {
          return attr.name.startsWith('data-') &&
                 !attr.name.startsWith('data-absmartly') &&
                 attr.value &&
                 attr.value.length < 50
        })

      const preferredDataAttrs = ['data-testid', 'data-test', 'data-cy', 'data-id']
      const preferredAttr = dataAttrs.find(attr => preferredDataAttrs.includes(attr.name))

      if (preferredAttr) {
        const dataSelector = '[' + preferredAttr.name + '="' + preferredAttr.value + '"]'
        const matches = document.querySelectorAll(dataSelector)
        if (matches.length === 1 && matches[0] === element) {
          return dataSelector
        }
      }

      // Build path
      let pathElements = []
      let current = element
      const maxDepth = 10

      while (current && current !== document.body && current !== document.documentElement && pathElements.length < maxDepth) {
        pathElements.push(current)
        current = current.parentElement
      }

      // Look for ID in parents (even duplicate)
      for (let i = 0; i < pathElements.length; i++) {
        const elem = pathElements[i]

        if (elem.id && !isAutoGenerated(elem.id)) {
          let selector = '#' + elem.id

          if (i > 0) {
            // Add path to target
            let path = []
            for (let j = i - 1; j >= 0; j--) {
              const e = pathElements[j]
              let part = e.tagName.toLowerCase()

              // Add nth-child if needed
              if (e.parentElement) {
                const siblings = Array.from(e.parentElement.children)
                if (siblings.length > 1) {
                  const idx = siblings.indexOf(e) + 1
                  part += ':nth-child(' + idx + ')'
                }
              }

              path.push(part)
            }
            selector = selector + ' > ' + path.join(' > ')
          }

          // Test if unique
          const matches = document.querySelectorAll(selector)
          if (matches.length === 1 && matches[0] === element) {
            return selector
          }

          // Try with parent ID
          for (let p = i + 1; p < pathElements.length; p++) {
            const parent = pathElements[p]
            if (parent.id && !isAutoGenerated(parent.id)) {
              const parentSelector = '#' + parent.id + ' ' + selector
              const parentMatches = document.querySelectorAll(parentSelector)
              if (parentMatches.length === 1 && parentMatches[0] === element) {
                return parentSelector
              }
            }
          }
        }
      }

      // Build minimal path
      let selector = pathElements.map((elem, i) => {
        let sel = elem.tagName.toLowerCase()
        if (elem.parentElement && i > 0) {
          const siblings = Array.from(elem.parentElement.children)
          if (siblings.length > 1) {
            const idx = siblings.indexOf(elem) + 1
            sel += ':nth-child(' + idx + ')'
          }
        }
        return sel
      }).reverse().join(' > ')

      return selector
    }

    function isAutoGenerated(str) {
      if (!str) return false
      if (str.includes('absmartly') || str.includes('ABSmartly')) return true
      if (/^[0-9]/.test(str)) return true
      if (/^css-[a-z0-9]+$/i.test(str)) return true
      if (/^framer-/.test(str)) return true
      return false
    }

    // Run diagnostic tests
    function runDiagnostic() {
      const results = document.getElementById('results')
      results.innerHTML = ''

      const tests = [
        {
          name: 'First price tag (duplicate ID)',
          selector: '#product-list .item:nth-child(1) #price-tag',
          element: document.querySelector('#product-list .item:nth-child(1) #price-tag')
        },
        {
          name: 'Second price tag (duplicate ID)',
          selector: '#product-list .item:nth-child(2) #price-tag',
          element: document.querySelector('#product-list .item:nth-child(2) #price-tag')
        },
        {
          name: 'Single span (no nth-child needed)',
          selector: '#single-parent > span',
          element: document.querySelector('#single-parent > span')
        },
        {
          name: 'Second span (nth-child needed)',
          selector: '#multi-parent > span:nth-child(2)',
          element: document.querySelector('#multi-parent > span:nth-child(2)')
        },
        {
          name: 'First paragraph in section',
          selector: 'article > section > p:nth-child(1)',
          element: document.querySelector('article > section > p:nth-child(1)')
        },
        {
          name: 'Button with data-testid',
          selector: '[data-testid="submit"]',
          element: document.querySelector('[data-testid="submit"]')
        }
      ]

      tests.forEach(test => {
        if (!test.element) {
          results.innerHTML += `<div class="test fail">
            <h3>${test.name}</h3>
            <p>Element not found: ${test.selector}</p>
          </div>`
          return
        }

        const generated = getSelector(test.element)
        const matches = document.querySelectorAll(generated)
        const isUnique = matches.length === 1 && matches[0] === test.element

        // Analyze the differences
        let analysis = []

        // Check if it's unique
        if (!isUnique) {
          analysis.push(`NOT UNIQUE: Matches ${matches.length} elements`)
        }

        // Check for unnecessary nth-child
        if (generated.includes(':nth-child(1)')) {
          const parent = test.element.parentElement
          if (parent && parent.children.length === 1) {
            analysis.push('Has unnecessary :nth-child(1)')
          }
        }

        // Check if it's using duplicate IDs properly
        if (test.element.id && document.querySelectorAll('#' + test.element.id).length > 1) {
          if (!generated.includes(test.element.id)) {
            analysis.push('Not using duplicate ID at all')
          } else if (!generated.includes('#product-list')) {
            analysis.push('Using duplicate ID but missing parent context')
          }
        }

        const status = isUnique ? 'pass' : 'fail'

        results.innerHTML += `<div class="test ${status}">
          <h3>${test.name}</h3>
          <p><strong>Expected:</strong> ${test.selector}</p>
          <p><strong>Generated:</strong> ${generated}</p>
          <p><strong>Unique:</strong> ${isUnique ? 'Yes ✅' : 'No ❌'}</p>
          ${analysis.length > 0 ? '<p><strong>Issues:</strong> ' + analysis.join(', ') + '</p>' : ''}
          <hr>
          <p><strong>Debug Info:</strong></p>
          <ul>
            <li>Element ID: ${test.element.id || 'none'}</li>
            <li>Parent ID: ${test.element.parentElement?.id || 'none'}</li>
            <li>Siblings: ${test.element.parentElement ? test.element.parentElement.children.length : 0}</li>
            <li>ID is duplicate: ${test.element.id ? document.querySelectorAll('#' + test.element.id).length > 1 : false}</li>
          </ul>
        </div>`
      })
    }

    window.addEventListener('load', () => {
      console.clear()
      console.log('Running diagnostic tests...')
      runDiagnostic()
    })
  </script>
</body>
</html>
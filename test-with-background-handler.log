ğŸš€ Starting global test setup...
âœ… Extension already built
âš ï¸  Note: Using existing build. Delete build/chrome-mv3-dev/manifest.json to force rebuild.
âœ… Copied seed.html to build directory
âœ… Copied seed.js to build directory
âœ… Copied local-test-page.html to build directory
âœ… Loaded environment variables from .env.dev.local
âœ… API credentials found in environment
âœ… Global setup completed successfully
---

Running 1 test using 1 worker

[2m[WebServer] [22m(node:10229) [DEP0066] DeprecationWarning: OutgoingMessage.prototype._headers is deprecated
[2m[WebServer] [22m(Use `node --trace-deprecation ...` to show where the warning was created)
âœ… Test page loaded (test mode enabled)
  ğŸ“‹ Console messages so far: 29
Extension ID: hmdfdmlfegajkklhbiijdpkdbaccnplj

ğŸ“‚ STEP 1: Injecting sidebar
âœ… Sidebar visible

ğŸ“‹ STEP 2: Creating new experiment
  Dispatched click event to Create New Experiment button
  Selecting "From Scratch" option...
  âœ“ Selected "From Scratch" option
  Filled experiment name: E2E Test Experiment 1761076300627
  Selecting Unit Type...
  Selecting Unit Type...
  âœ“ Unit type select is enabled
  âœ“ Clicked unit type trigger
  âœ“ Selected unit type
  Selecting Applications...
  âœ“ Clicked applications trigger
  âœ“ Selected application
âœ… Experiment form filled with required fields
ğŸ¨ STEP 3: Clicking Visual Editor button
  âœ“ Visual Editor button is enabled (form validation complete)
  âœ“ Waited for React handlers to attach
  âœ“ Brought test page to front
  âœ“ Dispatched click event to Visual Editor button
  â³ Waited 3s after VE button click
  ğŸ“‹ Captured 239 console messages
  ğŸ“‹ Content script/background messages: 6
  Messages:
    [log] [ABsmartly] Content script executing - TOP OF FILE
    [log] [ABsmartly] Content script marker set: true
    [log] [ABsmartly] SDK Bridge loaded successfully - version 1.1.0
    [log] [ABsmartly] Message listener called! Message type: ABSMARTLY_PREVIEW
    [log] [ABsmartly] Message listener called! Message type: CHECK_VISUAL_EDITOR_ACTIVE
    [log] [ABsmartly] Message listener called! Message type: SET_VISUAL_EDITOR_STARTING
  âŒ Found 2 error messages:
    - Failed to load resource: the server responded with a status of 404 (Not Found)
    - Failed to save development environment: Error: Cannot access contents of url "http://localhost:3456/visual-editor-test.html?use_shadow_dom_for_visual_editor_context_menu=0". Extension manifest must request permission to access this host.
  â³ Waiting for VE banner to appear...
  ğŸ“‹ Total messages captured so far: 239
âœ… Visual editor active
  Screenshot saved: sidebar-after-ve-launch.png

ğŸš« STEP 3.5: Testing VE protection - all buttons should be disabled
  Found 1 Visual Editor buttons
  Button 0 disabled: true, title: "Visual Editor is already active for this variant"
  âœ… All VE buttons correctly disabled when VE is active

ğŸ§ª STEP 4: Testing visual editor context menu actions
  Testing: Edit Text on #test-paragraph
  âœ“ Edit Text works
  Testing: Hide on #button-1
  âœ“ Hide works
  Testing: Delete on #button-2
  âœ“ Delete works
  Testing: Edit HTML on #test-container
  âœ“ CodeMirror editor appeared
  âœ“ CodeMirror syntax highlighting: true
  âœ“ Updated HTML via CodeMirror
  Looking for Save button...
  Clicking Save button with JavaScript click...
  Clicked Save button
  Editor closed
  âœ“ Edit HTML with CodeMirror works
  Testing: Change image source on img element
  âœ“ Added test image to page
  âœ“ Context menu opened for image
  âœ“ "Change image source" option is visible
  âœ“ Clicked "Change image source"
  âœ“ Image source dialog opened
  âœ“ Context menu closed after opening image dialog
  âœ“ Entered new image URL: https://via.placeholder.com/200
  âœ“ Clicked Apply button
  âœ“ Image source dialog closed after clicking Apply
  âœ… Context menu did NOT reopen (bug is fixed!)
  âœ“ Image source updated to: https://via.placeholder.com/200
âœ… Visual editor actions tested (Edit Text, Hide, Delete, Edit HTML, Change Image Source)

âœ“ Verifying DOM changes were actually applied...
  Applied changes: {
  paragraphText: [32m'Modified text!'[39m,
  button1Display: [32m'none'[39m,
  button2Display: [32m'none'[39m,
  testContainerHTML: [32m'<h2>HTML Edited!</h2><p>New paragraph content</p><p></p>'[39m
}
  âœ“ Text change applied: paragraph text is "Modified text!"
  âœ“ Hide change applied: button-1 is display:none
  âœ“ Delete change applied: button-2 is hidden (display:none)
  âœ“ HTML change applied: test-container has new HTML
âœ… All DOM changes verified and applied correctly

ğŸ”„ Testing undo/redo with multiple changes to same element...
  ğŸ“ Current text: "Modified text!"
  âœï¸  Making change 1: "Undo test 1"
  âœ“ Change 1 applied: "Undo test 1" (trackChange: null, undoAction: null)
  âœï¸  Making change 2: "Undo test 2"
  âœ“ Change 2 applied: "Undo test 2" (trackChange: null, undoAction: null)
  âœï¸  Making change 3: "Undo test 3"
  âœ“ Change 3 applied: "Undo test 3" (trackChange: null, undoAction: null)
  âœ“ Final text after changes: "Undo test 3"

  âª Testing undo with individual change tracking...
  âœ“ Undo 1: Text is now "Undo test 2"
  âœ“ Undo 2: Text is now "Undo test 1"
  âœ“ Undo 3: Text is now "Modified text!"

  â© Testing redo...
  âœ“ Redo 1: Text is now "Undo test 1"
  âœ“ Redo 2: Text is now "Undo test 2"
  âœ“ Redo 3: Text is now "Undo test 3"

âœ… Undo/redo with individual change tracking working correctly!
  â€¢ Each change tracked individually for granular undo/redo
  â€¢ 3 undos: "Undo test 3" -> "Undo test 2" -> "Undo test 1" -> "Modified text!"
  â€¢ 3 redos: "Modified text!" -> "Undo test 1" -> "Undo test 2" -> "Undo test 3"

ğŸ”˜ Testing undo/redo button states...
  âª Undoing all changes to test undo button disabled state...
  âœ“ Undo button became disabled after 8 undos
  âœ“ Undo button is disabled when no more changes to undo

  â© Redoing all changes to test redo button disabled state...
  âœ“ Redo button became disabled after 8 redos
  âœ“ Redo button is disabled when no more changes to redo

âœ… Undo/redo button states test PASSED!
  â€¢ Undo button disabled after 8 undos (no more history)
  â€¢ Redo button disabled after 8 redos (caught up to current state)

ğŸ’¾ STEP 5: Clicking Save button...
âœ… Save button clicked

â³ STEP 6: Waiting for sidebar to update after visual editor closes...

ğŸ“ STEP 7: Verifying changes in sidebar...
  Screenshot saved to test-results/sidebar-after-save.png
  Inline editor exists: false
  Sidebar HTML length: 41468 characters
  Sidebar HTML: 
    <div id="__plasmo" style="width: 100%; height: 100%; background-color: white; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, Oxygen, Ubuntu, Cantarell, &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, sans-serif; font-size: 14px; line-height: 1.5; color: rgb(17, 24, 39); overflow: auto;"><div class="w-full h-screen bg-white flex flex-col"><div class="p-4"><div class="mb-4 flex items-center justify-between gap-2"><div class="flex items-center gap-3 flex-1 min...
  Elements with 'change' or 'card' in class: 5
Found 5 DOM change cards in sidebar
DOM Change cards content: Text#test-paragraphSet text to: "Undo test 3" Style#button-1display:none Remove#button-2Remove element HTML#test-containerReplace inner HTML(58 chars) Attribute#test-imagesrc="https://via.placeholder.com/200"

Searching for HTML change...
Looking for: #test-container and "<h2>HTML Edited!</h2><p>New paragraph content</p>"
Has #test-container: [33mtrue[39m
Has "<h2>HTML Edited!</h2><p>New paragraph content</p>": [33mfalse[39m

  Verifying individual changes:
  âœ“ Edit Text: #test-paragraph â†’ "Undo test 3"
  âœ“ Hide: #button-1 â†’ display:none
  âœ“ Delete/Remove: #button-2
  âœ“ Edit HTML: #test-container â†’ HTML change

âœ… All expected changes verified in sidebar

ğŸ‰ Visual editor complete workflow test PASSED!
âœ… Successfully tested:
  â€¢ Edit Text - Modified paragraph text
  â€¢ Hide - Hid button element
  â€¢ Delete - Deleted button element
  â€¢ Edit HTML - Modified heading HTML
  â€¢ Save to sidebar - Changes synced to DOM editor

ğŸ” STEP 6.5: Verifying changes and markers after VE exit
  Post-VE state: {
  paragraphText: [32m'Undo test 3'[39m,
  button1Display: [32m'none'[39m,
  button2Display: [32m'none'[39m,
  testContainerHTML: [32m'<h2>HTML Edited!</h2><p>New paragraph content</p><p></p>'[39m,
  markedElementsCount: [33m5[39m,
  elementsWithOriginalsCount: [33m5[39m,
  experimentNames: [
    [32m'e2e_test_experiment_1761076300627'[39m,
    [32m'e2e_test_experiment_1761076300627'[39m,
    [32m'e2e_test_experiment_1761076300627'[39m,
    [32m'e2e_test_experiment_1761076300627'[39m,
    [32m'e2e_test_experiment_1761076300627'[39m
  ]
}
  âœ“ All changes still applied after VE exit
  âœ“ Preview markers present: 5 elements marked
  âœ“ Original values preserved: 5 elements with data-absmartly-original

ğŸšª STEP 7: Testing Exit Preview button from toolbar
  Verifying preview toolbar is visible...
  ğŸ“¸ Screenshot: after-ve-exit-before-toolbar-check.png
  Toolbar visible: true
  âœ“ Preview toolbar is visible
  Preview markers before exit: 5 modified, 5 experiment markers
  Clicking Exit Preview button...
  âœ“ Clicked Exit Preview button
  ğŸ” Checking if sidebar iframe received DISABLE_PREVIEW...
  Sidebar iframe received DISABLE_PREVIEW (main page listener): false
  ğŸ” Checking if content script received ABSMARTLY_PREVIEW...
  Content script received ABSMARTLY_PREVIEW: false
  ğŸ“‹ Console messages during Exit Preview:
    [TEST] About to click Exit Preview button
    [TEST] Clicking Exit Preview button now...
    [Content Script] Found 5 elements with preview markers
    [TEST] Exit Preview button clicked
    ğŸ“¡ Preview state changed: false
    [ABsmartly] Message listener called! Message type: ABSMARTLY_PREVIEW
    [Visual Editor Content Script] Received message: ABSMARTLY_PREVIEW
    [ABSmartly Content Script] Received preview message: remove
    [ABsmartly Extension] [ABsmartly Page] Removing preview changes for experiment: e2e_test_experiment_1761076300627
    [ABsmartly Extension] [ABsmartly Page] Preview removal requires external preview manager
  Verifying preview toolbar was removed...
  âœ“ Preview toolbar removed
  Verifying preview mode is completely disabled...
  After exit state: {
  modifiedElementsCount: [33m0[39m,
  experimentMarkersCount: [33m0[39m,
  paragraphText: [32m'\n'[39m +
    [32m'      This is a test paragraph that we will edit with the visual editor.\n'[39m +
    [32m'    '[39m,
  button1Visible: [33mtrue[39m,
  button2Visible: [33mtrue[39m,
  testContainerHTML: [32m'<h2 id="section-title">Section Title</h2>\n'[39m +
    [32m'      <p id="section-text">Section content that can be modified.</p>'[39m
}
  Remaining markers: 0 modified, 0 experiment markers
  âœ“ All preview markers removed
  âœ“ All changes reverted to original state
  Verifying preview toggle in sidebar is OFF...
  âœ“ Preview toggle in sidebar is OFF
âœ… Exit Preview button test COMPLETED!

ğŸ‘ï¸ STEP 8: Testing preview mode toggle
  Verifying preview is currently disabled...
  âœ“ Preview is disabled (no markers present)
  Capturing element states with preview disabled...
  States captured: {
  paragraphText: [32m'\n'[39m +
    [32m'      This is a test paragraph that we will edit with the visual editor.\n'[39m +
    [32m'    '[39m,
  paragraphVisible: [33mtrue[39m,
  button1Visible: [33mtrue[39m,
  button2Visible: [33mtrue[39m,
  testContainerHTML: [32m'<h2 id="section-title">Section Title</h2>\n'[39m +
    [32m'      <p id="section-text">Section content that can be modified.</p>'[39m
}
  Enabling preview mode...
  âœ“ Preview mode enabled
  Verifying preview markers were added...
  States after enabling: {
  paragraphText: [32m'\n'[39m +
    [32m'      This is a test paragraph that we will edit with the visual editor.\n'[39m +
    [32m'    '[39m,
  button1Visible: [33mtrue[39m,
  button2Visible: [33mtrue[39m,
  testContainerHTML: [32m'<h2 id="section-title">Section Title</h2>\n'[39m +
    [32m'      <p id="section-text">Section content that can be modified.</p>'[39m,
  stillModifiedCount: [33m0[39m,
  experimentMarkersCount: [33m0[39m
}
  Modified elements: 0
  Experiment markers: 0
  âœ˜  1 [chromium] â€º tests/e2e/visual-editor-complete.spec.ts:81:7 â€º Visual Editor Complete Workflow â€º Complete workflow: sidebar â†’ experiment â†’ visual editor â†’ actions â†’ save â†’ verify (9.0s)


  1) [chromium] â€º tests/e2e/visual-editor-complete.spec.ts:81:7 â€º Visual Editor Complete Workflow â€º Complete workflow: sidebar â†’ experiment â†’ visual editor â†’ actions â†’ save â†’ verify â€º Test preview mode toggle 

    Error: [2mexpect([22m[31mreceived[39m[2m).[22mtoBeGreaterThan[2m([22m[32mexpected[39m[2m)[22m

    Expected: > [32m0[39m
    Received:   [31m0[39m

      1184 |
      1185 |       // Verify markers were added
    > 1186 |       expect(enabledStates.stillModifiedCount).toBeGreaterThan(0)
           |                                                ^
      1187 |       expect(enabledStates.experimentMarkersCount).toBeGreaterThan(0)
      1188 |       console.log('  âœ“ Preview markers added')
      1189 |
        at /Users/joalves/git_tree/ext-dev6-refactor-sdk-plugin/tests/e2e/visual-editor-complete.spec.ts:1186:48
        at /Users/joalves/git_tree/ext-dev6-refactor-sdk-plugin/tests/e2e/visual-editor-complete.spec.ts:1106:5

  1 failed
    [chromium] â€º tests/e2e/visual-editor-complete.spec.ts:81:7 â€º Visual Editor Complete Workflow â€º Complete workflow: sidebar â†’ experiment â†’ visual editor â†’ actions â†’ save â†’ verify 

To open last HTML report run:
[36m[39m
[36m  npx playwright show-report[39m
[36m[39m

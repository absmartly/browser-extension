import { test, expect } from '../fixtures/extension'

test.describe('Claude API Key Authentication', () => {
  test('should display Claude API Key input in settings', async ({ context, extensionUrl }) => {
    const page = await context.newPage()
    await page.goto(extensionUrl('tabs/sidebar.html'), { waitUntil: 'domcontentloaded', timeout: 10000 })

    // Wait for the page to fully load before interacting
    await page.waitForLoadState('networkidle')

    // Navigate to settings
    await page.click('text=Settings')
    await page.waitForSelector('text=Claude API Configuration')

    // Verify Claude API Configuration section exists
    await expect(page.locator('text=Claude API Configuration')).toBeVisible()

    // Verify API Key label is visible
    await expect(page.locator('text=Claude API Key')).toBeVisible()

    // Verify API Key input field exists
    const apiKeyInput = page.locator('input[placeholder="sk-ant-..."]')
    await expect(apiKeyInput).toBeVisible()

    await page.close()
  })

  test('should allow entering and saving Claude API Key', async ({ context, extensionUrl }) => {
    const page = await context.newPage()
    await page.goto(extensionUrl('tabs/sidebar.html'), { waitUntil: 'domcontentloaded', timeout: 10000 })

    // Wait for the page to fully load before interacting
    await page.waitForLoadState('networkidle')

    // Navigate to settings
    await page.click('text=Settings')
    await page.waitForSelector('text=Claude API Configuration')

    // Enter an API key
    const apiKeyInput = page.locator('input[placeholder="sk-ant-..."]')
    await apiKeyInput.fill('sk-ant-test-key-12345678901234567890')

    // Save settings
    await page.click('#save-settings-button')

    // Wait a moment for save to complete
    await page.waitForLoadState('networkidle')

    // Navigate back to settings to verify persistence
    await page.click('text=Settings')
    await page.waitForSelector('text=Claude API Configuration')

    // Verify API key is still populated
    const savedApiKeyInput = page.locator('input[placeholder="sk-ant-..."]')
    await expect(savedApiKeyInput).toHaveValue('sk-ant-test-key-12345678901234567890')

    await page.close()
  })

  test('should persist Claude API Key across page reloads', async ({ context, extensionUrl }) => {
    const page = await context.newPage()
    await page.goto(extensionUrl('tabs/sidebar.html'), { waitUntil: 'domcontentloaded', timeout: 10000 })

    // Wait for the page to fully load before interacting
    await page.waitForLoadState('networkidle')

    // Navigate to settings
    await page.click('text=Settings')
    await page.waitForSelector('text=Claude API Configuration')

    // Enter an API key
    const apiKeyInput = page.locator('input[placeholder="sk-ant-..."]')
    await apiKeyInput.fill('sk-ant-persistent-key-123')

    // Save settings
    await page.click('#save-settings-button')

    // Wait for save to complete
    await page.waitForLoadState('networkidle')

    // Reload the page
    await page.reload()

    // Wait for page to load
    await page.waitForLoadState('networkidle')

    // Navigate to settings again
    await page.click('text=Settings')
    await page.waitForSelector('text=Claude API Configuration')

    // Verify API key is still populated
    const savedApiKeyInput = page.locator('input[placeholder="sk-ant-..."]')
    await expect(savedApiKeyInput).toHaveValue('sk-ant-persistent-key-123')

    await page.close()
  })
})

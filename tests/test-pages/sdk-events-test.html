<!DOCTYPE html>
<html>
<head>
  <title>SDK Events Test Page</title>
  <script src="https://unpkg.com/@absmartly/javascript-sdk/dist/absmartly.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; background: #f5f5f5; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; }
    h1 { color: #333; font-size: 32px; margin-bottom: 20px; }
    .button-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
    .event-button {
      padding: 12px 24px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .event-button:hover { background: #2563eb; }
    .info { margin: 20px 0; padding: 15px; background: #f0f9ff; border-left: 4px solid #3b82f6; }
  </style>
</head>
<body>
  <div class="container">
    <h1>SDK Events Test Page</h1>
    <p class="info">
      Click the buttons below to trigger different ABsmartly SDK events.
      These events will appear in the Events Debug Page panel.
    </p>

    <div class="button-grid">
      <button id="trigger-ready" class="event-button">Trigger Ready</button>
      <button id="trigger-refresh" class="event-button">Trigger Refresh</button>
      <button id="trigger-publish" class="event-button">Trigger Publish</button>
      <button id="trigger-exposure" class="event-button">Trigger Exposure</button>
      <button id="trigger-goal" class="event-button">Trigger Goal</button>
      <button id="trigger-finalize" class="event-button">Trigger Finalize</button>
      <button id="trigger-error" class="event-button">Trigger Error</button>
      <button id="trigger-all" class="event-button">Trigger All</button>
      <button id="clear-events" class="event-button">Clear Events</button>
    </div>

    <div id="event-log" style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 6px; min-height: 100px;">
      <strong>Event Log:</strong>
      <div id="log-content" style="margin-top: 10px; font-family: monospace; font-size: 12px;"></div>
    </div>
  </div>

  <script>
    let sdk = null

    function logEvent(message) {
      const logContent = document.getElementById('log-content')
      const timestamp = new Date().toLocaleTimeString()
      logContent.innerHTML += `<div>[${timestamp}] ${message}</div>`
    }

    // Initialize ABsmartly SDK
    async function initSDK() {
      try {
        const ABSmartly = window.absmartly
        const sdkConfig = {
          endpoint: 'https://demo.absmartly.io/v1',
          apiKey: 'test-api-key',
          environment: 'test',
          application: 'test-app'
        }

        const contextConfig = {
          units: {
            session_id: 'test-session-' + Date.now(),
            user_id: 'test-user-123'
          }
        }

        sdk = ABSmartly.create(sdkConfig)
        const context = await sdk.createContext(contextConfig)

        logEvent('ABsmartly SDK initialized')
        return context
      } catch (error) {
        logEvent('SDK initialization error: ' + error.message)
        console.error('SDK init error:', error)
      }
    }

    // Event button handlers - these will trigger real SDK events
    document.getElementById('trigger-ready').addEventListener('click', async () => {
      try {
        const context = await initSDK()
        logEvent('Triggered ready event')
      } catch (error) {
        logEvent('Error: ' + error.message)
      }
    })

    document.getElementById('trigger-refresh').addEventListener('click', async () => {
      try {
        if (!sdk) await initSDK()
        const context = await sdk.createContext({
          units: { session_id: 'test-session-' + Date.now() }
        })
        await context.refresh()
        logEvent('Triggered refresh event')
      } catch (error) {
        logEvent('Error: ' + error.message)
      }
    })

    document.getElementById('trigger-publish').addEventListener('click', async () => {
      try {
        if (!sdk) await initSDK()
        const context = await sdk.createContext({
          units: { session_id: 'test-session-' + Date.now() }
        })
        await context.publish()
        logEvent('Triggered publish event')
      } catch (error) {
        logEvent('Error: ' + error.message)
      }
    })

    document.getElementById('trigger-exposure').addEventListener('click', async () => {
      try {
        if (!sdk) await initSDK()
        const context = await sdk.createContext({
          units: { session_id: 'test-session-' + Date.now() }
        })
        // Trigger an exposure by getting a treatment
        context.treatment('test_experiment')
        logEvent('Triggered exposure event')
      } catch (error) {
        logEvent('Error: ' + error.message)
      }
    })

    document.getElementById('trigger-goal').addEventListener('click', async () => {
      try {
        if (!sdk) await initSDK()
        const context = await sdk.createContext({
          units: { session_id: 'test-session-' + Date.now() }
        })
        context.track('conversion', { value: 99.99, currency: 'USD' })
        logEvent('Triggered goal event')
      } catch (error) {
        logEvent('Error: ' + error.message)
      }
    })

    document.getElementById('trigger-finalize').addEventListener('click', async () => {
      try {
        if (!sdk) await initSDK()
        const context = await sdk.createContext({
          units: { session_id: 'test-session-' + Date.now() }
        })
        await context.close()
        logEvent('Triggered finalize event')
      } catch (error) {
        logEvent('Error: ' + error.message)
      }
    })

    document.getElementById('trigger-error').addEventListener('click', () => {
      // Dispatch a custom error event
      const event = {
        source: 'absmartly-page',
        type: 'SDK_EVENT',
        payload: {
          eventName: 'error',
          data: {
            message: 'Test error message',
            code: 'TEST_ERROR',
            stack: 'Error: Test error\n    at testFunction (test.js:10:15)'
          },
          timestamp: new Date().toISOString()
        }
      }
      window.postMessage(event, '*')
      logEvent('Triggered error event')
    })

    document.getElementById('trigger-all').addEventListener('click', () => {
      const events = ['ready', 'refresh', 'publish', 'exposure', 'goal', 'finalize', 'error']
      events.forEach((eventName, index) => {
        setTimeout(() => {
          document.getElementById(`trigger-${eventName}`).click()
        }, index * 200)
      })
    })

    document.getElementById('clear-events').addEventListener('click', () => {
      document.getElementById('log-content').innerHTML = ''
      logEvent('Log cleared')
    })

    // Log page load
    window.addEventListener('load', () => {
      logEvent('SDK Events Test Page loaded')
      logEvent('ABsmartly SDK available: ' + (typeof window.absmartly !== 'undefined'))
    })
  </script>
</body>
</html>

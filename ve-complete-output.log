ğŸš€ Starting global test setup...
âœ… Extension already built
âš ï¸  Note: Using existing build. Delete build/chrome-mv3-dev/manifest.json to force rebuild.
âœ… Copied seed.html to build directory
âœ… Copied local-test-page.html to build directory
âœ… Loaded environment variables from .env.local
âœ… API credentials found in environment
âœ… Global setup completed successfully
---

Running 3 tests using 1 worker

  ğŸ“ [log] [ABsmartly] Content script executing - TOP OF FILE
  ğŸ“ [log] [ABsmartly] Content script marker set: true
âœ… Test page loaded (test mode enabled)
  ğŸ“‹ Console messages so far: 3
Extension ID: elelnihlihbhpkobodjiodoefdjpdcjp

ğŸ“‚ STEP 1: Injecting sidebar
âœ… Sidebar visible

ğŸ“‹ STEP 2: Creating new experiment
  Clicked Create New Experiment button
  Filled experiment name: E2E Test Experiment 1759523936537
  ğŸ“ [log] [ABsmartly] Message listener called! Message type: ABSMARTLY_PREVIEW
  Selecting Unit Type...
  âœ“ Unit types loaded
  âœ“ Selected unit type
  Selecting Applications...
  âœ“ Clicked applications field
  âœ“ Applications loaded in dropdown
  âœ“ Selected application: Wwww
âœ… Experiment form filled with required fields
ğŸ¨ STEP 3: Clicking Visual Editor button
  âœ“ Visual Editor button is enabled (form validation complete)
  âœ“ Waited for React handlers to attach
  âœ“ Brought test page to front
  ğŸ“ [log] [DOMChanges] HANDLER CALLED - about to query tabs
  ğŸ“ [log] [DOMChanges] Initial tabs query result: 1 tabs
  ğŸ“ [log] [DOMChanges] Using tab ID: 399629242
  ğŸ“ [log] [ABsmartly] Message listener called! Message type: CHECK_VISUAL_EDITOR_ACTIVE
  âœ“ Dispatched click event to Visual Editor button
  ğŸ“ [log] [ABsmartly] Message listener called! Message type: SET_VISUAL_EDITOR_STARTING
  ğŸ“ [log] [ABsmartly] Message listener called! Message type: ABSMARTLY_PREVIEW
  ğŸ“ [log] [DOMChanges] About to send START_VISUAL_EDITOR, tabs[0]?.id: 399629242
  ğŸ“ [log] [DOMChanges] Sending START_VISUAL_EDITOR to tab: 399629242
  ğŸ“ [log] [ABsmartly] Message listener called! Message type: START_VISUAL_EDITOR
  ğŸ“ [log] [ABsmartly] Received START_VISUAL_EDITOR message: {"type":"START_VISUAL_EDITOR","variantName":"Control","experimentName":"E2E Test Experiment 1759523936537","changes":[]}
  ğŸ“ [log] [ABsmartly] startVisualEditor called with config: {"variantName":"Control","experimentName":"E2E Test Experiment 1759523936537","changes":[]}
  ğŸ“ [log] [ABsmartly] startVisualEditor completed with result: {"success":true}
  â³ Waited 3s after VE button click
  ğŸ“‹ Captured 146 console messages
  ğŸ“‹ Content script/background messages: 10
  Messages:
    [log] [ABsmartly] Content script executing - TOP OF FILE
    [log] [ABsmartly] Content script marker set: true
    [log] [ABsmartly] Message listener called! Message type: ABSMARTLY_PREVIEW
    [log] [ABsmartly] Message listener called! Message type: CHECK_VISUAL_EDITOR_ACTIVE
    [log] [ABsmartly] Message listener called! Message type: SET_VISUAL_EDITOR_STARTING
    [log] [ABsmartly] Message listener called! Message type: ABSMARTLY_PREVIEW
    [log] [ABsmartly] Message listener called! Message type: START_VISUAL_EDITOR
    [log] [ABsmartly] Received START_VISUAL_EDITOR message: {"type":"START_VISUAL_EDITOR","variantName":"Control","experimentName":"E2E Test Experiment 1759523936537","changes":[]}
    [log] [ABsmartly] startVisualEditor called with config: {"variantName":"Control","experimentName":"E2E Test Experiment 1759523936537","changes":[]}
    [log] [ABsmartly] startVisualEditor completed with result: {"success":true}
  â³ Waiting for VE banner to appear...
  ğŸ“‹ Total messages captured so far: 146
âœ… Visual editor active
  Screenshot saved: sidebar-after-ve-launch.png

ğŸš« STEP 3.5: Testing VE protection - all buttons should be disabled
  Found 2 Visual Editor buttons
  Button 0 disabled: true, title: "Visual Editor is already active for this variant"
  Button 1 disabled: true, title: "Visual Editor is active for variant "Control""
  âœ… All VE buttons correctly disabled when VE is active

ğŸ§ª STEP 4: Testing visual editor context menu actions
  Testing: Edit Text on #test-paragraph
  âœ“ Edit Text works
  Testing: Hide on #button-1
  âœ“ Hide works
  Testing: Delete on #button-2
  âœ“ Delete works
  Testing: Move up on #item-2
  âœ“ Move up works
  Testing: Edit HTML on #test-container
  âœ“ CodeMirror editor appeared
  âœ“ CodeMirror syntax highlighting: true
  âœ“ Updated HTML via CodeMirror
  Looking for Save button...
  Clicking Save button with JavaScript click...
  Clicked Save button
  Editor closed
  âœ“ Edit HTML with CodeMirror works
âœ… Visual editor actions tested (Edit Text, Hide, Delete, Move up, Edit HTML)

âœ“ Verifying DOM changes were actually applied...
  Applied changes: {
  paragraphText: [32m'Modified text!'[39m,
  button1Display: [32m'none'[39m,
  button2Display: [32m'none'[39m,
  testContainerHTML: [32m'<h2>HTML Edited!</h2><p>New paragraph content</p><p></p>'[39m
}
  âœ“ Text change applied: paragraph text is "Modified text!"
  âœ“ Hide change applied: button-1 is display:none
  âœ“ Delete change applied: button-2 is hidden (display:none)
  âœ“ HTML change applied: test-container has new HTML
âœ… All DOM changes verified and applied correctly

ğŸ”„ Testing undo/redo with multiple changes to same element...
  ğŸ“ Current text: "Modified text!"
  âœï¸  Making change 1: "Undo test 1"
  âœ“ Change 1 applied: "Undo test 1" (trackChange: null, undoAction: null)
  âœï¸  Making change 2: "Undo test 2"
  âœ“ Change 2 applied: "Undo test 2" (trackChange: null, undoAction: null)
  âœï¸  Making change 3: "Undo test 3"
  âœ“ Change 3 applied: "Undo test 3" (trackChange: null, undoAction: null)
  âœ“ Final text after changes: "Undo test 3"

  âª Testing undo with individual change tracking...
  âœ“ Undo 1: Text is now "Undo test 2"
  âœ“ Undo 2: Text is now "Undo test 1"
  âœ“ Undo 3: Text is now "Modified text!"

  â© Testing redo...
  âœ“ Redo 1: Text is now "Undo test 1"
  âœ“ Redo 2: Text is now "Undo test 2"
  âœ“ Redo 3: Text is now "Undo test 3"

âœ… Undo/redo with individual change tracking working correctly!
  â€¢ Each change tracked individually for granular undo/redo
  â€¢ 3 undos: "Undo test 3" -> "Undo test 2" -> "Undo test 1" -> "Modified text!"
  â€¢ 3 redos: "Modified text!" -> "Undo test 1" -> "Undo test 2" -> "Undo test 3"

ğŸ”˜ Testing undo/redo button states...
  âª Undoing all changes to test undo button disabled state...
  âœ“ Undo button became disabled after 8 undos
  âœ“ Undo button is disabled when no more changes to undo

  â© Redoing all changes to test redo button disabled state...
  âœ“ Redo button became disabled after 8 redos
  âœ“ Redo button is disabled when no more changes to redo

âœ… Undo/redo button states test PASSED!
  â€¢ Undo button disabled after 8 undos (no more history)
  â€¢ Redo button disabled after 8 redos (caught up to current state)

ğŸ’¾ STEP 5: Clicking Save button...
âœ… Save button clicked

â³ STEP 6: Waiting for sidebar to update after visual editor closes...
  ğŸ“ [log] [ABsmartly] Message listener called! Message type: ABSMARTLY_PREVIEW

ğŸ“ STEP 7: Verifying changes in sidebar...
  Screenshot saved to test-results/sidebar-after-save.png
  Inline editor exists: false
  Sidebar HTML length: 38294 characters
  Sidebar HTML: 
    <div id="__plasmo" style="width: 100%; height: 100%; background-color: white; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, Oxygen, Ubuntu, Cantarell, &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, sans-serif; font-size: 14px; line-height: 1.5; color: rgb(17, 24, 39); overflow: auto;"><div class="w-full h-screen bg-white flex flex-col"><div class="p-4"><div class="mb-4 flex items-center justify-between"><div class="flex items-center gap-3"><img src="chrom...
  Elements with 'change' or 'card' in class: 5
Found 5 DOM change cards in sidebar
DOM Change cards content: Text#test-paragraphSet text to: "Undo test 3" Style#button-1display:none delete#button-2Unknown change type: delete Move/Reorder#item-2Move after  HTML#test-containerReplace inner HTML(58 chars)

Searching for HTML change...
Looking for: #test-container and "<h2>HTML Edited!</h2><p>New paragraph content</p>"
Has #test-container: [33mtrue[39m
Has "<h2>HTML Edited!</h2><p>New paragraph content</p>": [33mfalse[39m

  Verifying individual changes:
  âœ“ Edit Text: #test-paragraph â†’ "Undo test 3"
  âœ“ Hide: #button-1 â†’ display:none
  âœ“ Delete: #button-2
  âœ“ Move: #item-2
  âœ“ Edit HTML: #test-container â†’ HTML change

âœ… All expected changes verified in sidebar

ğŸ‰ Visual editor complete workflow test PASSED!
âœ… Successfully tested:
  â€¢ Edit Text - Modified paragraph text
  â€¢ Hide - Hid button element
  â€¢ Delete - Deleted button element
  â€¢ Move up - Moved list item up
  â€¢ Edit HTML - Modified heading HTML
  â€¢ Save to sidebar - Changes synced to DOM editor

ğŸ” STEP 6.5: Verifying changes and markers after VE exit
  Post-VE state: {
  paragraphText: [32m'Undo test 3'[39m,
  button1Display: [32m'none'[39m,
  button2Display: [32m'none'[39m,
  testContainerHTML: [32m'<h2>HTML Edited!</h2><p>New paragraph content</p><p></p>'[39m,
  markedElementsCount: [33m5[39m,
  elementsWithOriginalsCount: [33m5[39m,
  experimentNames: [
    [32m'E2E Test Experiment 1759523936537'[39m,
    [32m'E2E Test Experiment 1759523936537'[39m,
    [32m'E2E Test Experiment 1759523936537'[39m,
    [32m'E2E Test Experiment 1759523936537'[39m,
    [32m'E2E Test Experiment 1759523936537'[39m
  ]
}
  âœ“ All changes still applied after VE exit
  âœ“ Preview markers present: 5 elements marked
  âœ“ Original values preserved: 5 elements with data-absmartly-original

ğŸ‘ï¸ STEP 7: Testing preview mode removal
  Verifying preview is currently enabled...
  âœ“ Preview is enabled (5 elements marked)
  Experiment names in markers: E2E Test Experiment 1759523936537
  Capturing element states with preview enabled...
  States captured: {
  paragraphText: [32m'Undo test 3'[39m,
  paragraphVisible: [33mtrue[39m,
  button1Visible: [33mfalse[39m,
  button2Visible: [33mfalse[39m,
  testContainerHTML: [32m'<h2>HTML Edited!</h2><p>New paragraph content</p><p></p>'[39m
}
  Disabling preview mode...
  ğŸ“ [log] [ABsmartly] Message listener called! Message type: ABSMARTLY_PREVIEW
  âœ“ Preview mode disabled
  Verifying all preview markers were removed...
  States after disabling: {
  paragraphText: [32m'\n'[39m +
    [32m'      This is a test paragraph that we will edit with the visual editor.\n'[39m +
    [32m'    '[39m,
  button1Visible: [33mtrue[39m,
  button2Visible: [33mtrue[39m,
  testContainerHTML: [32m'<h2 id="section-title">Section Title</h2>\n'[39m +
    [32m'      <p id="section-text">Section content that can be modified.</p>'[39m,
  stillModifiedCount: [33m0[39m,
  experimentMarkersCount: [33m0[39m
}
  Modified elements remaining: 0
  Experiment markers remaining: 0
  âœ“ All data-absmartly attributes removed
  âœ“ Paragraph reverted to original: "
      This is a test paragraph that we will edit with the visual editor.
    "
  âœ“ Button-1 is visible again (display restored)
  âœ“ Button-2 is visible again (restored from delete)
  âœ“ Section title reverted: "<h2 id="section-title">Section Title</h2>
      <p id="section-text">Section content that can be modified.</p>"
  âœ“ All changes reverted when preview disabled
  Re-enabling preview mode...
  ğŸ“ [log] [ABsmartly] Message listener called! Message type: ABSMARTLY_PREVIEW
  âœ“ Preview mode re-enabled
  Re-enabled state: {
  paragraphText: [32m'Undo test 3'[39m,
  button1Display: [32m'none'[39m,
  button2Display: [32m'none'[39m,
  testContainerHTML: [32m'<h2>HTML Edited!</h2><p>New paragraph content</p><p></p>'[39m,
  modifiedElementsCount: [33m5[39m,
  experimentMarkersCount: [33m5[39m,
  elementsWithOriginalsCount: [33m0[39m
}
  âœ“ Paragraph text re-applied: "Undo test 3"
  âœ“ Button-1 hidden again (display: none)
  âœ“ Button-2 hidden again (delete re-applied)
  âœ“ Section title HTML re-applied
  âœ“ Preview markers restored: 5 elements marked
âœ… Preview mode toggle test PASSED!
  â€¢ Preview was enabled after visual editor usage
  â€¢ Disabling preview reverted all changes and removed markers
  â€¢ Re-enabling preview re-applied changes and added markers back

ğŸ”„ Testing ability to launch VE a second time...
  âœ“ Previous VE DOM elements cleaned up
  ğŸ“ [log] [DOMChanges] HANDLER CALLED - about to query tabs
  ğŸ“ [log] [DOMChanges] Initial tabs query result: 1 tabs
  ğŸ“ [log] [DOMChanges] Using tab ID: 399629242
  ğŸ“ [log] [ABsmartly] Message listener called! Message type: CHECK_VISUAL_EDITOR_ACTIVE
  âœ“ Dispatched click event to Visual Editor button for second launch
  ğŸ“ [log] [ABsmartly] Message listener called! Message type: SET_VISUAL_EDITOR_STARTING
  ğŸ“ [log] [DOMChanges] About to send START_VISUAL_EDITOR, tabs[0]?.id: 399629242
  ğŸ“ [log] [DOMChanges] Sending START_VISUAL_EDITOR to tab: 399629242
  ğŸ“ [log] [ABsmartly] Message listener called! Message type: START_VISUAL_EDITOR
  ğŸ“ [log] [ABsmartly] Received START_VISUAL_EDITOR message: {"type":"START_VISUAL_EDITOR","variantName":"Control","experimentName":"E2E Test Experiment 1759523936537","changes":[{"selector":"#test-paragraph","type":"text","value":"Undo test 3","enabled":true},{"selector":"#button-1","type":"style","value":{"display":"none"},"enabled":true},{"selector":"#button-2","type":"delete","value":null,"enabled":true},{"selector":"#item-2","type":"move","value":"up","enabled":true},{"selector":"#test-container","type":"html","value":"<h2>HTML Edited!</h2><p>New paragraph content</p></p></h2>","enabled":true}]}
  ğŸ“ [log] [ABsmartly] startVisualEditor called with config: {"variantName":"Control","experimentName":"E2E Test Experiment 1759523936537","changes":[{"selector":"#test-paragraph","type":"text","value":"Undo test 3","enabled":true},{"selector":"#button-1","type":"style","value":{"display":"none"},"enabled":true},{"selector":"#button-2","type":"delete","value":null,"enabled":true},{"selector":"#item-2","type":"move","value":"up","enabled":true},{"selector":"#test-container","type":"html","value":"<h2>HTML Edited!</h2><p>New paragraph content</p></p></h2>","enabled":true}]}
  ğŸ“ [log] [ABsmartly] startVisualEditor completed with result: {"success":true}
  âœ“ Second VE instance launched successfully!
  âœ˜  1 [chromium] â€º tests/e2e/visual-editor-complete.spec.ts:104:7 â€º Visual Editor Complete Workflow â€º Complete workflow: sidebar â†’ experiment â†’ visual editor â†’ actions â†’ save â†’ verify (20.2s)
âœ… Local server started on port 8080
âœ… Test page loaded
âœ… Extension injection triggered
âœ… Server stopped
  âœ˜  2 [chromium] â€º tests/visual-editor-complete-test.spec.ts:37:7 â€º Complete Visual Editor Test â€º Complete visual editor workflow (12.6s)
âœ… Local server started on port 8080
Visual editor tests should:
1. Right-click elements to show context menu
2. Test Edit Text action
3. Test Change Style action
4. Test Add/Remove Class actions
5. Test Hide/Delete element actions
6. Save changes and verify they persist
7. Exit visual editor and verify preview header shows
âœ… Server stopped
  âœ“  3 [chromium] â€º tests/visual-editor-complete-test.spec.ts:99:7 â€º Complete Visual Editor Test â€º Test visual editor context menu directly (1.1s)


  1) [chromium] â€º tests/e2e/visual-editor-complete.spec.ts:104:7 â€º Visual Editor Complete Workflow â€º Complete workflow: sidebar â†’ experiment â†’ visual editor â†’ actions â†’ save â†’ verify â€º Test launching second VE instance 

    [31mTest timeout of 20000ms exceeded.[39m

    Error: page.waitForTimeout: Target page, context or browser has been closed

      1128 |
      1129 |       // Verify banner shows correct experiment name
    > 1130 |       await testPage.waitForTimeout(500) // Give banner time to render
           |                      ^
      1131 |       console.log('  âœ“ Second VE is active and ready')
      1132 |
      1133 |       // Exit the second VE by clicking the Exit button in the banner
        at /Users/joalves/git_tree/absmartly-browser-extension/tests/e2e/visual-editor-complete.spec.ts:1130:22
        at /Users/joalves/git_tree/absmartly-browser-extension/tests/e2e/visual-editor-complete.spec.ts:1060:5

  2) [chromium] â€º tests/visual-editor-complete-test.spec.ts:37:7 â€º Complete Visual Editor Test â€º Complete visual editor workflow 

    TimeoutError: page.waitForSelector: Timeout 10000ms exceeded.
    Call log:
    [2m  - waiting for locator('#absmartly-sidebar-iframe') to be visible[22m


      46 |
      47 |     // Step 3: Wait for sidebar iframe
    > 48 |     await page.waitForSelector('#absmartly-sidebar-iframe', { timeout: 10000 })
         |                ^
      49 |     const iframe = await page.$('#absmartly-sidebar-iframe')
      50 |     console.log('âœ… Sidebar iframe detected')
      51 |
        at /Users/joalves/git_tree/absmartly-browser-extension/tests/visual-editor-complete-test.spec.ts:48:16

    attachment #1: video (video/webm) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    test-results/visual-editor-complete-tes-75cff-lete-visual-editor-workflow-chromium/video.webm
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Error Context: test-results/visual-editor-complete-tes-75cff-lete-visual-editor-workflow-chromium/error-context.md

  2 failed
    [chromium] â€º tests/e2e/visual-editor-complete.spec.ts:104:7 â€º Visual Editor Complete Workflow â€º Complete workflow: sidebar â†’ experiment â†’ visual editor â†’ actions â†’ save â†’ verify 
    [chromium] â€º tests/visual-editor-complete-test.spec.ts:37:7 â€º Complete Visual Editor Test â€º Complete visual editor workflow 
  1 passed (39.2s)

To open last HTML report run:
[36m[39m
[36m  npx playwright show-report[39m
[36m[39m
